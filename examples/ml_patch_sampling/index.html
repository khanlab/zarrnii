
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://www.khanlab.ca/zarrnii/examples/ml_patch_sampling/">
      
      
        <link rel="prev" href="../atlas_example/">
      
      
        <link rel="next" href="../multiscale/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>ML Training - Patch Sampling - ZarrNii Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2a3383ac.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ml-training-patch-sampling-and-cropping" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ZarrNii Documentation" class="md-header__button md-logo" aria-label="ZarrNii Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ZarrNii Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ML Training - Patch Sampling
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ZarrNii Documentation" class="md-nav__button md-logo" aria-label="ZarrNii Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ZarrNii Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Walkthrough
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Walkthrough
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../walkthrough/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../walkthrough/getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../walkthrough/basic_tasks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Tasks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../walkthrough/advanced_use_cases/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Use Cases
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command Line Interface
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zarr_nifti/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Zarr and NIfTI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../imaris_usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Imaris Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../transformations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../downsampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Downsampling and Upsampling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../near_isotropic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Near-Isotropic Downsampling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../atlas_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Atlases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    ML Training - Patch Sampling
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    ML Training - Patch Sampling
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Workflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basic Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-load-atlas-and-sample-centers" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Load Atlas and Sample Centers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-extract-fixed-size-patches" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Extract Fixed-Size Patches
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-region-sampling" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Region Sampling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#different-patch-sizes-for-different-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Different Patch Sizes for Different Tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#single-center-cropping" class="md-nav__link">
    <span class="md-ellipsis">
      Single Center Cropping
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-ml-training-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Complete ML Training Pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-pytorch-dataloader" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with PyTorch DataLoader
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-resolution-training-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Resolution Training Strategy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#balanced-sampling-from-multiple-regions" class="md-nav__link">
    <span class="md-ellipsis">
      Balanced Sampling from Multiple Regions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quality-control-verify-patch-coverage" class="md-nav__link">
    <span class="md-ellipsis">
      Quality Control: Verify Patch Coverage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-efficient-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Memory-Efficient Processing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Tips and Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tips and Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-coordinate-systems" class="md-nav__link">
    <span class="md-ellipsis">
      1. Coordinate Systems
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-reproducibility" class="md-nav__link">
    <span class="md-ellipsis">
      2. Reproducibility
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-handling-edge-cases" class="md-nav__link">
    <span class="md-ellipsis">
      3. Handling Edge Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-data-augmentation" class="md-nav__link">
    <span class="md-ellipsis">
      4. Data Augmentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-distributed-training" class="md-nav__link">
    <span class="md-ellipsis">
      5. Distributed Training
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multiscale OME-Zarr
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../segmentation_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Segmentation Plugins
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scaled_processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scaled Processing Plugins
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Workflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basic Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-load-atlas-and-sample-centers" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Load Atlas and Sample Centers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-extract-fixed-size-patches" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Extract Fixed-Size Patches
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-region-sampling" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Region Sampling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#different-patch-sizes-for-different-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Different Patch Sizes for Different Tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#single-center-cropping" class="md-nav__link">
    <span class="md-ellipsis">
      Single Center Cropping
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-ml-training-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Complete ML Training Pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-pytorch-dataloader" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with PyTorch DataLoader
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-resolution-training-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Resolution Training Strategy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#balanced-sampling-from-multiple-regions" class="md-nav__link">
    <span class="md-ellipsis">
      Balanced Sampling from Multiple Regions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quality-control-verify-patch-coverage" class="md-nav__link">
    <span class="md-ellipsis">
      Quality Control: Verify Patch Coverage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-efficient-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Memory-Efficient Processing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Tips and Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tips and Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-coordinate-systems" class="md-nav__link">
    <span class="md-ellipsis">
      1. Coordinate Systems
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-reproducibility" class="md-nav__link">
    <span class="md-ellipsis">
      2. Reproducibility
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-handling-edge-cases" class="md-nav__link">
    <span class="md-ellipsis">
      3. Handling Edge Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-data-augmentation" class="md-nav__link">
    <span class="md-ellipsis">
      4. Data Augmentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-distributed-training" class="md-nav__link">
    <span class="md-ellipsis">
      5. Distributed Training
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="ml-training-patch-sampling-and-cropping">ML Training: Patch Sampling and Cropping</h1>
<p>This example demonstrates how to use <code>sample_region_patches()</code> and <code>crop_centered()</code> for machine learning workflows where you need to extract fixed-size training patches from anatomical regions defined in an atlas.</p>
<h2 id="overview">Overview</h2>
<p>The typical ML training workflow involves:
1. <strong>Define regions</strong> using a lower-resolution atlas
2. <strong>Sample center coordinates</strong> from those regions
3. <strong>Extract fixed-size patches</strong> at those centers from high-resolution data</p>
<p>This approach is particularly useful when:
- Your atlas is at a different resolution than your training data
- You need consistent patch dimensions for ML models (e.g., 256×256×256 voxels)
- You want to sample from specific anatomical regions</p>
<h2 id="basic-workflow">Basic Workflow</h2>
<h3 id="step-1-load-atlas-and-sample-centers">Step 1: Load Atlas and Sample Centers</h3>
<pre><code class="language-python">from zarrnii import ZarrNiiAtlas

# Load atlas (e.g., at 1mm resolution)
atlas = ZarrNiiAtlas.from_files(
    dseg_path=&quot;atlas_dseg.nii.gz&quot;,
    labels_path=&quot;atlas_dseg.tsv&quot;
)

# Sample 100 centers from cortical regions
centers = atlas.sample_region_patches(
    n_patches=100,
    region_ids=&quot;Cortex&quot;,
    seed=42  # For reproducibility
)

print(f&quot;Sampled {len(centers)} centers&quot;)
print(f&quot;First center: {centers[0]} mm (physical coordinates)&quot;)
</code></pre>
<p><strong>Output:</strong></p>
<pre><code>Sampled 100 centers
First center: (45.2, 67.8, 123.4) mm (physical coordinates)
</code></pre>
<h3 id="step-2-extract-fixed-size-patches">Step 2: Extract Fixed-Size Patches</h3>
<pre><code class="language-python">from zarrnii import ZarrNii

# Load high-resolution image (e.g., at 0.1mm resolution)
highres_image = ZarrNii.from_ome_zarr(&quot;microscopy_data.ome.zarr&quot;, level=0)

# Extract 256x256x256 voxel patches at each center
patches = highres_image.crop_centered(
    centers,
    patch_size=(256, 256, 256)  # Fixed size in voxels
)

print(f&quot;Created {len(patches)} patches&quot;)
print(f&quot;First patch shape: {patches[0].shape}&quot;)
print(f&quot;All patches have consistent spatial dims: {all(p.shape[1:] == patches[0].shape[1:] for p in patches)}&quot;)
</code></pre>
<p><strong>Output:</strong></p>
<pre><code>Created 100 patches
First patch shape: (1, 256, 256, 256)
All patches have consistent spatial dims: True
</code></pre>
<h2 id="advanced-examples">Advanced Examples</h2>
<h3 id="multi-region-sampling">Multi-Region Sampling</h3>
<p>Sample from multiple anatomical regions:</p>
<pre><code class="language-python"># Sample from multiple regions using a list
centers = atlas.sample_region_patches(
    n_patches=50,
    region_ids=[&quot;Hippocampus&quot;, &quot;Amygdala&quot;, &quot;Cortex&quot;],
    seed=42
)

# Or use regex patterns
cortical_centers = atlas.sample_region_patches(
    n_patches=100,
    regex=&quot;.*[Cc]ortex.*&quot;,  # Match any cortical regions
    seed=42
)
</code></pre>
<h3 id="different-patch-sizes-for-different-tasks">Different Patch Sizes for Different Tasks</h3>
<pre><code class="language-python"># Large patches for context (512³ voxels)
large_patches = highres_image.crop_centered(centers[:10], patch_size=(512, 512, 512))

# Medium patches for training (256³ voxels)
training_patches = highres_image.crop_centered(centers, patch_size=(256, 256, 256))

# Small patches for fine details (128³ voxels)
detail_patches = highres_image.crop_centered(centers, patch_size=(128, 128, 128))
</code></pre>
<h3 id="single-center-cropping">Single Center Cropping</h3>
<p>When you need just one patch, <code>crop_centered()</code> returns a single <code>ZarrNii</code> object (not a list):</p>
<pre><code class="language-python"># Get one specific center
center = centers[0]

# Extract single patch
patch = highres_image.crop_centered(
    center,  # Single tuple, not a list
    patch_size=(256, 256, 256)
)

print(f&quot;Single patch type: {type(patch)}&quot;)  # &lt;class 'zarrnii.core.ZarrNii'&gt;
print(f&quot;Shape: {patch.shape}&quot;)
</code></pre>
<h2 id="complete-ml-training-pipeline">Complete ML Training Pipeline</h2>
<p>Here's a complete example showing data preparation for ML training:</p>
<pre><code class="language-python">import numpy as np
from zarrnii import ZarrNii, ZarrNiiAtlas
from pathlib import Path

# Configuration
PATCH_SIZE = (256, 256, 256)
N_TRAIN_PATCHES = 1000
N_VAL_PATCHES = 200
OUTPUT_DIR = Path(&quot;ml_training_data&quot;)
OUTPUT_DIR.mkdir(exist_ok=True)

# Step 1: Load atlas and define regions of interest
atlas = ZarrNiiAtlas.from_files(
    dseg_path=&quot;atlas_1mm_dseg.nii.gz&quot;,
    labels_path=&quot;atlas_1mm_dseg.tsv&quot;
)

# Step 2: Sample centers for training set
train_centers = atlas.sample_region_patches(
    n_patches=N_TRAIN_PATCHES,
    region_ids=[&quot;Gray-Matter&quot;, &quot;Cortex&quot;],
    seed=42
)

# Step 3: Sample centers for validation set
val_centers = atlas.sample_region_patches(
    n_patches=N_VAL_PATCHES,
    region_ids=[&quot;Gray-Matter&quot;, &quot;Cortex&quot;],
    seed=123  # Different seed for validation
)

# Step 4: Load high-resolution data
highres_image = ZarrNii.from_ome_zarr(
    &quot;specimen_highres.ome.zarr&quot;,
    level=0  # Highest resolution
)

# Step 5: Extract training patches
print(&quot;Extracting training patches...&quot;)
train_patches = highres_image.crop_centered(train_centers, patch_size=PATCH_SIZE)

# Step 6: Extract validation patches
print(&quot;Extracting validation patches...&quot;)
val_patches = highres_image.crop_centered(val_centers, patch_size=PATCH_SIZE)

# Step 7: Save patches (example with one format)
print(&quot;Saving patches...&quot;)
for i, patch in enumerate(train_patches):
    patch.to_nifti(OUTPUT_DIR / f&quot;train_patch_{i:04d}.nii.gz&quot;)

for i, patch in enumerate(val_patches):
    patch.to_nifti(OUTPUT_DIR / f&quot;val_patch_{i:04d}.nii.gz&quot;)

print(f&quot;Training patches: {len(train_patches)}&quot;)
print(f&quot;Validation patches: {len(val_patches)}&quot;)
print(f&quot;Patch size: {PATCH_SIZE}&quot;)
print(f&quot;Output directory: {OUTPUT_DIR}&quot;)
</code></pre>
<h2 id="integration-with-pytorch-dataloader">Integration with PyTorch DataLoader</h2>
<p>Convert patches to numpy arrays for direct use with PyTorch:</p>
<pre><code class="language-python">import torch
from torch.utils.data import Dataset, DataLoader
import numpy as np

class PatchDataset(Dataset):
    def __init__(self, patches, transform=None):
        &quot;&quot;&quot;
        Args:
            patches: List of ZarrNii objects
            transform: Optional transforms to apply
        &quot;&quot;&quot;
        self.patches = patches
        self.transform = transform

    def __len__(self):
        return len(self.patches)

    def __getitem__(self, idx):
        # Get patch data
        patch = self.patches[idx]

        # Convert to numpy array
        data = patch.data
        if hasattr(data, 'compute'):
            data = data.compute()

        # Convert to float32 and normalize
        data = data.astype(np.float32)

        # Remove channel dimension if present
        if data.shape[0] == 1:
            data = data[0]

        # Apply transforms if any
        if self.transform:
            data = self.transform(data)

        return torch.from_numpy(data)

# Create datasets
train_dataset = PatchDataset(train_patches)
val_dataset = PatchDataset(val_patches)

# Create dataloaders
train_loader = DataLoader(
    train_dataset,
    batch_size=4,
    shuffle=True,
    num_workers=4
)

val_loader = DataLoader(
    val_dataset,
    batch_size=4,
    shuffle=False,
    num_workers=4
)

# Use in training loop
for batch in train_loader:
    # batch shape: (batch_size, z, y, x)
    # Your training code here
    pass
</code></pre>
<h2 id="multi-resolution-training-strategy">Multi-Resolution Training Strategy</h2>
<p>Sample at different atlas resolutions for multi-scale analysis:</p>
<pre><code class="language-python"># Load atlases at different resolutions
atlas_1mm = ZarrNiiAtlas.from_files(&quot;atlas_1mm_dseg.nii.gz&quot;, &quot;atlas_dseg.tsv&quot;)
atlas_2mm = ZarrNiiAtlas.from_files(&quot;atlas_2mm_dseg.nii.gz&quot;, &quot;atlas_dseg.tsv&quot;)

# Sample centers from each resolution
centers_1mm = atlas_1mm.sample_region_patches(
    n_patches=500,
    region_ids=&quot;Cortex&quot;,
    seed=42
)

centers_2mm = atlas_2mm.sample_region_patches(
    n_patches=500,
    region_ids=&quot;Cortex&quot;,
    seed=42
)

# Load image at multiple resolutions
highres_image = ZarrNii.from_ome_zarr(&quot;data.ome.zarr&quot;, level=0)  # Highest resolution
lowres_image = ZarrNii.from_ome_zarr(&quot;data.ome.zarr&quot;, level=2)   # Lower resolution

# Extract patches at different scales
# All patches will be 256³ voxels, but represent different physical sizes
highres_patches = highres_image.crop_centered(centers_1mm, patch_size=(256, 256, 256))
lowres_patches = lowres_image.crop_centered(centers_2mm, patch_size=(256, 256, 256))
</code></pre>
<h2 id="balanced-sampling-from-multiple-regions">Balanced Sampling from Multiple Regions</h2>
<p>Ensure equal representation from different anatomical regions:</p>
<pre><code class="language-python"># Define regions and number of patches per region
regions_config = {
    &quot;Cortex&quot;: 300,
    &quot;Hippocampus&quot;: 200,
    &quot;Thalamus&quot;: 200,
    &quot;Cerebellum&quot;: 300
}

# Sample from each region
all_centers = []
for region_name, n_patches in regions_config.items():
    centers = atlas.sample_region_patches(
        n_patches=n_patches,
        region_ids=region_name,
        seed=42
    )
    all_centers.extend(centers)

print(f&quot;Total centers sampled: {len(all_centers)}&quot;)

# Extract all patches
patches = highres_image.crop_centered(all_centers, patch_size=(256, 256, 256))
</code></pre>
<h2 id="quality-control-verify-patch-coverage">Quality Control: Verify Patch Coverage</h2>
<p>Check that patches cover the intended regions:</p>
<pre><code class="language-python"># Sample centers
centers = atlas.sample_region_patches(
    n_patches=50,
    region_ids=&quot;Hippocampus&quot;,
    seed=42
)

# Extract patches from the atlas itself to verify regions
atlas_patches = atlas.crop_centered(centers, patch_size=(64, 64, 64))

# Check that patches contain the target region label
hippocampus_label = atlas.get_region_info(&quot;Hippocampus&quot;)[&quot;index&quot;]

for i, patch in enumerate(atlas_patches):
    data = patch.data
    if hasattr(data, 'compute'):
        data = data.compute()

    # Check if hippocampus label is present
    has_hippocampus = np.any(data == hippocampus_label)
    print(f&quot;Patch {i}: Contains Hippocampus = {has_hippocampus}&quot;)
</code></pre>
<h2 id="memory-efficient-processing">Memory-Efficient Processing</h2>
<p>For large datasets, process patches in batches:</p>
<pre><code class="language-python">def process_in_batches(centers, image, patch_size, batch_size=10):
    &quot;&quot;&quot;Process patches in batches to save memory.&quot;&quot;&quot;
    n_patches = len(centers)

    for i in range(0, n_patches, batch_size):
        # Get batch of centers
        batch_centers = centers[i:i+batch_size]

        # Extract batch of patches
        batch_patches = image.crop_centered(batch_centers, patch_size=patch_size)

        # Process batch (e.g., save, train, etc.)
        for j, patch in enumerate(batch_patches):
            patch_idx = i + j
            # Your processing code here
            patch.to_nifti(f&quot;patch_{patch_idx:04d}.nii.gz&quot;)

        print(f&quot;Processed patches {i} to {i+len(batch_patches)-1}&quot;)

# Use the function
process_in_batches(
    centers=train_centers,
    image=highres_image,
    patch_size=(256, 256, 256),
    batch_size=10
)
</code></pre>
<h2 id="tips-and-best-practices">Tips and Best Practices</h2>
<h3 id="1-coordinate-systems">1. Coordinate Systems</h3>
<ul>
<li>Centers are always in <strong>physical space (mm)</strong> in (x, y, z) order</li>
<li>Patch sizes are always in <strong>voxels</strong> in (x, y, z) order</li>
<li>This allows sampling at one resolution and cropping at another</li>
</ul>
<h3 id="2-reproducibility">2. Reproducibility</h3>
<ul>
<li>Always set a <code>seed</code> for reproducible sampling</li>
<li>Save the seed value with your training configuration</li>
</ul>
<pre><code class="language-python"># Save configuration
config = {
    'seed': 42,
    'n_patches': 1000,
    'patch_size': (256, 256, 256),
    'regions': [&quot;Cortex&quot;, &quot;Hippocampus&quot;],
}
</code></pre>
<h3 id="3-handling-edge-cases">3. Handling Edge Cases</h3>
<ul>
<li>Patches near image boundaries may be smaller than requested</li>
<li>Check patch dimensions before training:</li>
</ul>
<pre><code class="language-python"># Filter patches by size
min_size = (200, 200, 200)  # Minimum acceptable size
valid_patches = [
    p for p in patches 
    if all(s &gt;= m for s, m in zip(p.shape[1:], min_size))
]
</code></pre>
<h3 id="4-data-augmentation">4. Data Augmentation</h3>
<ul>
<li>Combine with standard augmentation techniques:</li>
<li>Rotation (use <code>apply_transform()</code>)</li>
<li>Flipping</li>
<li>Intensity scaling</li>
<li>Adding noise</li>
</ul>
<h3 id="5-distributed-training">5. Distributed Training</h3>
<ul>
<li>Sample centers once and share across workers:</li>
</ul>
<pre><code class="language-python"># In main process
centers = atlas.sample_region_patches(n_patches=10000, region_ids=&quot;Cortex&quot;, seed=42)

# Save centers for workers
import pickle
with open('centers.pkl', 'wb') as f:
    pickle.dump(centers, f)

# In worker processes, load and subset
with open('centers.pkl', 'rb') as f:
    all_centers = pickle.load(f)

# Each worker gets a subset
worker_centers = all_centers[worker_id::n_workers]
patches = image.crop_centered(worker_centers, patch_size=(256, 256, 256))
</code></pre>
<h2 id="see-also">See Also</h2>
<ul>
<li><a href="../atlas_example/">Atlas Example</a> - General atlas functionality</li>
<li><a href="../transformations/">Transformations</a> - Spatial transformations and alignment</li>
<li><a href="../multiscale/">Multiscale OME-Zarr</a> - Working with multi-resolution data</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>