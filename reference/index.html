
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://www.khanlab.ca/zarrnii/reference/">
      
      
        <link rel="prev" href="../cli/">
      
      
        <link rel="next" href="../examples/zarr_nifti/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>API Reference - ZarrNii Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ZarrNii Documentation" class="md-header__button md-logo" aria-label="ZarrNii Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ZarrNii Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ZarrNii Documentation" class="md-nav__button md-logo" aria-label="ZarrNii Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ZarrNii Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Walkthrough
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Walkthrough
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../walkthrough/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../walkthrough/getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../walkthrough/basic_tasks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Tasks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../walkthrough/advanced_use_cases/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Use Cases
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command Line Interface
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Core Classes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii" class="md-nav__link">
    <span class="md-ellipsis">
      ZarrNii
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    <span class="md-ellipsis">
      Methods
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_ome_zarr" class="md-nav__link">
    <span class="md-ellipsis">
      from_ome_zarr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      from_nifti
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_imaris" class="md-nav__link">
    <span class="md-ellipsis">
      from_imaris
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_ome_zarr" class="md-nav__link">
    <span class="md-ellipsis">
      to_ome_zarr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      to_nifti
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_tiff_stack" class="md-nav__link">
    <span class="md-ellipsis">
      to_tiff_stack
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_imaris" class="md-nav__link">
    <span class="md-ellipsis">
      to_imaris
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.crop" class="md-nav__link">
    <span class="md-ellipsis">
      crop
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.downsample" class="md-nav__link">
    <span class="md-ellipsis">
      downsample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.upsample" class="md-nav__link">
    <span class="md-ellipsis">
      upsample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.upsample--upsample-with-scaling-factors" class="md-nav__link">
    <span class="md-ellipsis">
      Upsample with scaling factors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.upsample--upsample-to-a-specific-shape" class="md-nav__link">
    <span class="md-ellipsis">
      Upsample to a specific shape
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_transform" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remaining-methods-and-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Remaining Methods and Functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii" class="md-nav__link">
    <span class="md-ellipsis">
      ZarrNii
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii._omero" class="md-nav__link">
    <span class="md-ellipsis">
      _omero
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.affine" class="md-nav__link">
    <span class="md-ellipsis">
      affine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.axes" class="md-nav__link">
    <span class="md-ellipsis">
      axes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.axes_order" class="md-nav__link">
    <span class="md-ellipsis">
      axes_order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.coordinate_transformations" class="md-nav__link">
    <span class="md-ellipsis">
      coordinate_transformations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.darr" class="md-nav__link">
    <span class="md-ellipsis">
      darr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.data" class="md-nav__link">
    <span class="md-ellipsis">
      data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.dims" class="md-nav__link">
    <span class="md-ellipsis">
      dims
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.name" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.ngff_image" class="md-nav__link">
    <span class="md-ellipsis">
      ngff_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.omero" class="md-nav__link">
    <span class="md-ellipsis">
      omero
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.orientation" class="md-nav__link">
    <span class="md-ellipsis">
      orientation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.scale" class="md-nav__link">
    <span class="md-ellipsis">
      scale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.shape" class="md-nav__link">
    <span class="md-ellipsis">
      shape
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.translation" class="md-nav__link">
    <span class="md-ellipsis">
      translation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.xyz_orientation" class="md-nav__link">
    <span class="md-ellipsis">
      xyz_orientation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.__get_upsampled_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      __get_upsampled_chunks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii._create_zyx_ngff_image" class="md-nav__link">
    <span class="md-ellipsis">
      _create_zyx_ngff_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_scaled_processing" class="md-nav__link">
    <span class="md-ellipsis">
      apply_scaled_processing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_transform" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_transform_flo_to_ref_indices" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform_flo_to_ref_indices
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_transform_ref_to_flo_indices" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform_ref_to_flo_indices
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.compute" class="md-nav__link">
    <span class="md-ellipsis">
      compute
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.compute_histogram" class="md-nav__link">
    <span class="md-ellipsis">
      compute_histogram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.compute_otsu_thresholds" class="md-nav__link">
    <span class="md-ellipsis">
      compute_otsu_thresholds
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.copy" class="md-nav__link">
    <span class="md-ellipsis">
      copy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.crop" class="md-nav__link">
    <span class="md-ellipsis">
      crop
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.crop_with_bounding_box" class="md-nav__link">
    <span class="md-ellipsis">
      crop_with_bounding_box
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.downsample" class="md-nav__link">
    <span class="md-ellipsis">
      downsample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_darr" class="md-nav__link">
    <span class="md-ellipsis">
      from_darr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_file" class="md-nav__link">
    <span class="md-ellipsis">
      from_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_imaris" class="md-nav__link">
    <span class="md-ellipsis">
      from_imaris
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_ngff_image" class="md-nav__link">
    <span class="md-ellipsis">
      from_ngff_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      from_nifti
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_ome_zarr" class="md-nav__link">
    <span class="md-ellipsis">
      from_ome_zarr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_affine_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      get_affine_matrix
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_affine_transform" class="md-nav__link">
    <span class="md-ellipsis">
      get_affine_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_orientation" class="md-nav__link">
    <span class="md-ellipsis">
      get_orientation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_origin" class="md-nav__link">
    <span class="md-ellipsis">
      get_origin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_zooms" class="md-nav__link">
    <span class="md-ellipsis">
      get_zooms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.list_channels" class="md-nav__link">
    <span class="md-ellipsis">
      list_channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.segment" class="md-nav__link">
    <span class="md-ellipsis">
      segment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.segment_otsu" class="md-nav__link">
    <span class="md-ellipsis">
      segment_otsu
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.segment_threshold" class="md-nav__link">
    <span class="md-ellipsis">
      segment_threshold
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.select_channels" class="md-nav__link">
    <span class="md-ellipsis">
      select_channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.select_timepoints" class="md-nav__link">
    <span class="md-ellipsis">
      select_timepoints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_imaris" class="md-nav__link">
    <span class="md-ellipsis">
      to_imaris
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_ngff_image" class="md-nav__link">
    <span class="md-ellipsis">
      to_ngff_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      to_nifti
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_ome_zarr" class="md-nav__link">
    <span class="md-ellipsis">
      to_ome_zarr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_tiff_stack" class="md-nav__link">
    <span class="md-ellipsis">
      to_tiff_stack
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.upsample" class="md-nav__link">
    <span class="md-ellipsis">
      upsample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform" class="md-nav__link">
    <span class="md-ellipsis">
      AffineTransform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.matrix" class="md-nav__link">
    <span class="md-ellipsis">
      matrix
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.__array__" class="md-nav__link">
    <span class="md-ellipsis">
      __array__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.__matmul__" class="md-nav__link">
    <span class="md-ellipsis">
      __matmul__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.__setitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __setitem__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.apply_transform" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.from_array" class="md-nav__link">
    <span class="md-ellipsis">
      from_array
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.from_txt" class="md-nav__link">
    <span class="md-ellipsis">
      from_txt
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.identity" class="md-nav__link">
    <span class="md-ellipsis">
      identity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.invert" class="md-nav__link">
    <span class="md-ellipsis">
      invert
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.update_for_orientation" class="md-nav__link">
    <span class="md-ellipsis">
      update_for_orientation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform" class="md-nav__link">
    <span class="md-ellipsis">
      DisplacementTransform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.disp_affine" class="md-nav__link">
    <span class="md-ellipsis">
      disp_affine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.disp_grid" class="md-nav__link">
    <span class="md-ellipsis">
      disp_grid
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.disp_xyz" class="md-nav__link">
    <span class="md-ellipsis">
      disp_xyz
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.apply_transform" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.from_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      from_nifti
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/zarr_nifti/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Zarr and NIfTI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/imaris_usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Imaris Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/transformations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/downsampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Downsampling and Upsampling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/near_isotropic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Near-Isotropic Downsampling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/multiscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multiscale OME-Zarr
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/segmentation_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Segmentation Plugins
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Core Classes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii" class="md-nav__link">
    <span class="md-ellipsis">
      ZarrNii
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    <span class="md-ellipsis">
      Methods
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_ome_zarr" class="md-nav__link">
    <span class="md-ellipsis">
      from_ome_zarr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      from_nifti
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_imaris" class="md-nav__link">
    <span class="md-ellipsis">
      from_imaris
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_ome_zarr" class="md-nav__link">
    <span class="md-ellipsis">
      to_ome_zarr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      to_nifti
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_tiff_stack" class="md-nav__link">
    <span class="md-ellipsis">
      to_tiff_stack
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_imaris" class="md-nav__link">
    <span class="md-ellipsis">
      to_imaris
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.crop" class="md-nav__link">
    <span class="md-ellipsis">
      crop
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.downsample" class="md-nav__link">
    <span class="md-ellipsis">
      downsample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.upsample" class="md-nav__link">
    <span class="md-ellipsis">
      upsample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.upsample--upsample-with-scaling-factors" class="md-nav__link">
    <span class="md-ellipsis">
      Upsample with scaling factors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.upsample--upsample-to-a-specific-shape" class="md-nav__link">
    <span class="md-ellipsis">
      Upsample to a specific shape
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_transform" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remaining-methods-and-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Remaining Methods and Functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii" class="md-nav__link">
    <span class="md-ellipsis">
      ZarrNii
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii._omero" class="md-nav__link">
    <span class="md-ellipsis">
      _omero
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.affine" class="md-nav__link">
    <span class="md-ellipsis">
      affine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.axes" class="md-nav__link">
    <span class="md-ellipsis">
      axes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.axes_order" class="md-nav__link">
    <span class="md-ellipsis">
      axes_order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.coordinate_transformations" class="md-nav__link">
    <span class="md-ellipsis">
      coordinate_transformations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.darr" class="md-nav__link">
    <span class="md-ellipsis">
      darr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.data" class="md-nav__link">
    <span class="md-ellipsis">
      data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.dims" class="md-nav__link">
    <span class="md-ellipsis">
      dims
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.name" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.ngff_image" class="md-nav__link">
    <span class="md-ellipsis">
      ngff_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.omero" class="md-nav__link">
    <span class="md-ellipsis">
      omero
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.orientation" class="md-nav__link">
    <span class="md-ellipsis">
      orientation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.scale" class="md-nav__link">
    <span class="md-ellipsis">
      scale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.shape" class="md-nav__link">
    <span class="md-ellipsis">
      shape
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.translation" class="md-nav__link">
    <span class="md-ellipsis">
      translation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.xyz_orientation" class="md-nav__link">
    <span class="md-ellipsis">
      xyz_orientation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.__get_upsampled_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      __get_upsampled_chunks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii._create_zyx_ngff_image" class="md-nav__link">
    <span class="md-ellipsis">
      _create_zyx_ngff_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_scaled_processing" class="md-nav__link">
    <span class="md-ellipsis">
      apply_scaled_processing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_transform" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_transform_flo_to_ref_indices" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform_flo_to_ref_indices
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.apply_transform_ref_to_flo_indices" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform_ref_to_flo_indices
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.compute" class="md-nav__link">
    <span class="md-ellipsis">
      compute
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.compute_histogram" class="md-nav__link">
    <span class="md-ellipsis">
      compute_histogram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.compute_otsu_thresholds" class="md-nav__link">
    <span class="md-ellipsis">
      compute_otsu_thresholds
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.copy" class="md-nav__link">
    <span class="md-ellipsis">
      copy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.crop" class="md-nav__link">
    <span class="md-ellipsis">
      crop
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.crop_with_bounding_box" class="md-nav__link">
    <span class="md-ellipsis">
      crop_with_bounding_box
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.downsample" class="md-nav__link">
    <span class="md-ellipsis">
      downsample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_darr" class="md-nav__link">
    <span class="md-ellipsis">
      from_darr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_file" class="md-nav__link">
    <span class="md-ellipsis">
      from_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_imaris" class="md-nav__link">
    <span class="md-ellipsis">
      from_imaris
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_ngff_image" class="md-nav__link">
    <span class="md-ellipsis">
      from_ngff_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      from_nifti
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.from_ome_zarr" class="md-nav__link">
    <span class="md-ellipsis">
      from_ome_zarr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_affine_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      get_affine_matrix
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_affine_transform" class="md-nav__link">
    <span class="md-ellipsis">
      get_affine_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_orientation" class="md-nav__link">
    <span class="md-ellipsis">
      get_orientation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_origin" class="md-nav__link">
    <span class="md-ellipsis">
      get_origin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.get_zooms" class="md-nav__link">
    <span class="md-ellipsis">
      get_zooms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.list_channels" class="md-nav__link">
    <span class="md-ellipsis">
      list_channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.segment" class="md-nav__link">
    <span class="md-ellipsis">
      segment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.segment_otsu" class="md-nav__link">
    <span class="md-ellipsis">
      segment_otsu
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.segment_threshold" class="md-nav__link">
    <span class="md-ellipsis">
      segment_threshold
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.select_channels" class="md-nav__link">
    <span class="md-ellipsis">
      select_channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.select_timepoints" class="md-nav__link">
    <span class="md-ellipsis">
      select_timepoints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_imaris" class="md-nav__link">
    <span class="md-ellipsis">
      to_imaris
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_ngff_image" class="md-nav__link">
    <span class="md-ellipsis">
      to_ngff_image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      to_nifti
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_ome_zarr" class="md-nav__link">
    <span class="md-ellipsis">
      to_ome_zarr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.to_tiff_stack" class="md-nav__link">
    <span class="md-ellipsis">
      to_tiff_stack
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.ZarrNii.upsample" class="md-nav__link">
    <span class="md-ellipsis">
      upsample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform" class="md-nav__link">
    <span class="md-ellipsis">
      AffineTransform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.matrix" class="md-nav__link">
    <span class="md-ellipsis">
      matrix
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.__array__" class="md-nav__link">
    <span class="md-ellipsis">
      __array__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.__matmul__" class="md-nav__link">
    <span class="md-ellipsis">
      __matmul__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.__setitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __setitem__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.apply_transform" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.from_array" class="md-nav__link">
    <span class="md-ellipsis">
      from_array
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.from_txt" class="md-nav__link">
    <span class="md-ellipsis">
      from_txt
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.identity" class="md-nav__link">
    <span class="md-ellipsis">
      identity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.invert" class="md-nav__link">
    <span class="md-ellipsis">
      invert
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.AffineTransform.update_for_orientation" class="md-nav__link">
    <span class="md-ellipsis">
      update_for_orientation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform" class="md-nav__link">
    <span class="md-ellipsis">
      DisplacementTransform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.disp_affine" class="md-nav__link">
    <span class="md-ellipsis">
      disp_affine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.disp_grid" class="md-nav__link">
    <span class="md-ellipsis">
      disp_grid
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.disp_xyz" class="md-nav__link">
    <span class="md-ellipsis">
      disp_xyz
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.apply_transform" class="md-nav__link">
    <span class="md-ellipsis">
      apply_transform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zarrnii.transform.DisplacementTransform.from_nifti" class="md-nav__link">
    <span class="md-ellipsis">
      from_nifti
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api-reference">API Reference</h1>
<p>This page documents the core classes, methods, and functions in ZarrNii. </p>
<hr />
<h2 id="core-classes">Core Classes</h2>
<h3 id="zarrnii">ZarrNii</h3>
<p>The <code>ZarrNii</code> class provides tools for reading, writing, and transforming datasets in OME-Zarr and NIfTI formats.</p>
<h4 id="key-methods">Key Methods</h4>
<ul>
<li><a href="#from_ome_zarr"><code>from_ome_zarr</code></a>: Load data from OME-Zarr.</li>
<li><a href="#from_nifti"><code>from_nifti</code></a>: Load data from a NIfTI file.</li>
<li><a href="#from_imaris"><code>from_imaris</code></a>: Load data from an Imaris (.ims) file.</li>
<li><a href="#to_ome_zarr"><code>to_ome_zarr</code></a>: Save data as OME-Zarr.</li>
<li><a href="#to_nifti"><code>to_nifti</code></a>: Save data as a NIfTI file.</li>
<li><a href="#to_tiff_stack"><code>to_tiff_stack</code></a>: Save data as a stack of 2D TIFF files.</li>
<li><a href="#to_imaris"><code>to_imaris</code></a>: Save data as an Imaris (.ims) file.</li>
<li><a href="#crop"><code>crop</code></a>: Extract a region from the dataset.</li>
<li><a href="#downsample"><code>downsample</code></a>: Reduce resolution of datasets.</li>
<li><a href="#upsample"><code>upsample</code></a>: Increase resolution of datasets.</li>
<li><a href="#apply_transform"><code>apply_transform</code></a>: Apply spatial transformations.</li>
</ul>


<div class="doc doc-object doc-class">



<a id="zarrnii.ZarrNii"></a>
    <div class="doc doc-contents first">


        <p>Zarr-based image with NIfTI compatibility using NgffImage internally.</p>
<p>This class provides chainable operations on OME-Zarr data while maintaining
compatibility with NIfTI workflows. It uses NgffImage objects internally for
better multiscale support and metadata preservation.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="ngff_image

  
      instance-attribute
   (zarrnii.ZarrNii.ngff_image)" href="#zarrnii.ZarrNii.ngff_image">ngff_image</a></code></td>
            <td>
                  <code><span title="ngff_zarr.NgffImage">NgffImage</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The internal NgffImage object containing data and metadata.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="axes_order = 'ZYX'

  
      class-attribute
      instance-attribute
   (zarrnii.ZarrNii.axes_order)" href="#zarrnii.ZarrNii.axes_order">axes_order</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The order of the axes for NIfTI compatibility ('ZYX' or 'XYZ').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="xyz_orientation = 'RAS'

  
      class-attribute
      instance-attribute
   (zarrnii.ZarrNii.xyz_orientation)" href="#zarrnii.ZarrNii.xyz_orientation">xyz_orientation</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The anatomical orientation string in XYZ axes order (e.g., 'RAS', 'LPI').</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

        <p>Constructor with backward compatibility for old signature.</p>








                  <details class="quote">
                    <summary>Source code in <code>zarrnii/core.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">darr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">affine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;ZYX&quot;</span><span class="p">,</span>
    <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
    <span class="n">xyz_orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ngff_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_omero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructor with backward compatibility for old signature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle backwards compatibility: if xyz_orientation is provided, use it</span>
    <span class="c1"># Otherwise, use orientation for backwards compatibility</span>
    <span class="n">final_orientation</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">xyz_orientation</span> <span class="k">if</span> <span class="n">xyz_orientation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">orientation</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">ngff_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># New signature</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ngff_image&quot;</span><span class="p">,</span> <span class="n">ngff_image</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;axes_order&quot;</span><span class="p">,</span> <span class="n">axes_order</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xyz_orientation&quot;</span><span class="p">,</span> <span class="n">final_orientation</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_omero&quot;</span><span class="p">,</span> <span class="n">_omero</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">darr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Legacy signature - delegate to from_darr</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_darr</span><span class="p">(</span>
            <span class="n">darr</span><span class="o">=</span><span class="n">darr</span><span class="p">,</span>
            <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">,</span>
            <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">final_orientation</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ngff_image&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;axes_order&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">axes_order</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xyz_orientation&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_omero&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">_omero</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either ngff_image or darr&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">












  </div>

    </div>

</div><hr />
<h2 id="methods">Methods</h2>
<h3 id="from_ome_zarr"><code>from_ome_zarr</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.from_ome_zarr"></a>
    <div class="doc doc-contents first">

        <p>Load ZarrNii from OME-Zarr store with flexible options.</p>
<p>Creates a ZarrNii instance from an OME-Zarr store, supporting multiscale
pyramids, channel/timepoint selection, and various storage backends.
Automatically handles metadata extraction and format conversion.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>store_or_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Store or path to OME-Zarr file. Supports:
- Local file paths
- Remote URLs (s3://, http://, etc.)
- ZIP files (.zip extension)
- Zarr store objects</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>level</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyramid level to load (0 = highest resolution). If level
exceeds available levels, applies lazy downsampling</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channels</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel indices to load (0-based). Mutually
exclusive with channel_labels</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel_labels</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel names to load by label. Requires
OMERO metadata. Mutually exclusive with channels</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timepoints</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of timepoint indices to load (0-based). If None,
loads all available timepoints</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>storage_options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional options for zarr storage backend
(e.g., credentials for cloud storage)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axis order for NIfTI compatibility.
Either "ZYX" or "XYZ"</p>
              </div>
            </td>
            <td>
                  <code>&#39;ZYX&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orientation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default anatomical orientation if not in metadata.
Standard orientations like "RAS", "LPI", etc. This is always
interpreted in XYZ axes order for consistency.</p>
              </div>
            </td>
            <td>
                  <code>&#39;RAS&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>downsample_near_isotropic</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, automatically downsample
dimensions with smaller voxel sizes to achieve near-isotropic
resolution</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="Ellipsis">Ellipsis</span>] | <span title="Literal">Literal</span>[&#39;auto&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>chunking strategy, or explicit chunk sizes to use if not automatic</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rechunk</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, rechunks the dataset after lazy loading, based
on the chunks parameter</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instance with loaded data and metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If both channels and channel_labels are specified,
or if invalid level/indices are provided</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If store_or_path does not exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If specified channel labels are not found</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="IOError">IOError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to read from the storage backend</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load full resolution data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ome_zarr</span><span class="p">(</span><span class="s2">&quot;/path/to/data.zarr&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load specific channels and pyramid level</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ome_zarr</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;/path/to/data.zarr&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;LPI&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load from cloud storage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ome_zarr</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;s3://bucket/data.zarr&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">storage_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;access_key&quot;</span><span class="p">,</span> <span class="s2">&quot;secret&quot;</span><span class="p">:</span> <span class="s2">&quot;secret&quot;</span><span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <p><strong>Orientation Metadata Backwards Compatibility:</strong></p>
<p>This method implements backwards compatibility for orientation metadata:</p>
<ol>
<li>
<p><strong>Priority Order</strong>: Checks for 'xyz_orientation' first (new format),
   then falls back to 'orientation' (legacy format)</p>
</li>
<li>
<p><strong>Legacy Fallback</strong>: When only legacy 'orientation' is found, the
   orientation string is automatically reversed to convert from ZYX-based
   encoding (legacy) to XYZ-based encoding (current standard)</p>
</li>
<li>
<p><strong>Default Fallback</strong>: If no orientation metadata is found, uses the
   provided 'orientation' parameter as the default</p>
</li>
</ol>
<p>Examples of the conversion:
- Legacy 'orientation'='SAR' (ZYX) → 'xyz_orientation'='RAS' (XYZ)
- Legacy 'orientation'='IPL' (ZYX) → 'xyz_orientation'='LPI' (XYZ)</p>
<p>This ensures consistent orientation handling while maintaining backwards
compatibility with existing OME-Zarr files that use the legacy format.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ome_zarr</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">store_or_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">channel_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timepoints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
    <span class="n">downsample_near_isotropic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="bp">Ellipsis</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">rechunk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load ZarrNii from OME-Zarr store with flexible options.</span>

<span class="sd">    Creates a ZarrNii instance from an OME-Zarr store, supporting multiscale</span>
<span class="sd">    pyramids, channel/timepoint selection, and various storage backends.</span>
<span class="sd">    Automatically handles metadata extraction and format conversion.</span>

<span class="sd">    Args:</span>
<span class="sd">        store_or_path: Store or path to OME-Zarr file. Supports:</span>
<span class="sd">            - Local file paths</span>
<span class="sd">            - Remote URLs (s3://, http://, etc.)</span>
<span class="sd">            - ZIP files (.zip extension)</span>
<span class="sd">            - Zarr store objects</span>
<span class="sd">        level: Pyramid level to load (0 = highest resolution). If level</span>
<span class="sd">            exceeds available levels, applies lazy downsampling</span>
<span class="sd">        channels: List of channel indices to load (0-based). Mutually</span>
<span class="sd">            exclusive with channel_labels</span>
<span class="sd">        channel_labels: List of channel names to load by label. Requires</span>
<span class="sd">            OMERO metadata. Mutually exclusive with channels</span>
<span class="sd">        timepoints: List of timepoint indices to load (0-based). If None,</span>
<span class="sd">            loads all available timepoints</span>
<span class="sd">        storage_options: Additional options for zarr storage backend</span>
<span class="sd">            (e.g., credentials for cloud storage)</span>
<span class="sd">        axes_order: Spatial axis order for NIfTI compatibility.</span>
<span class="sd">            Either &quot;ZYX&quot; or &quot;XYZ&quot;</span>
<span class="sd">        orientation: Default anatomical orientation if not in metadata.</span>
<span class="sd">            Standard orientations like &quot;RAS&quot;, &quot;LPI&quot;, etc. This is always</span>
<span class="sd">            interpreted in XYZ axes order for consistency.</span>
<span class="sd">        downsample_near_isotropic: If True, automatically downsample</span>
<span class="sd">            dimensions with smaller voxel sizes to achieve near-isotropic</span>
<span class="sd">            resolution</span>
<span class="sd">        chunks: chunking strategy, or explicit chunk sizes to use if not automatic</span>
<span class="sd">        rechunk: If True, rechunks the dataset after lazy loading, based</span>
<span class="sd">            on the chunks parameter</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii instance with loaded data and metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If both channels and channel_labels are specified,</span>
<span class="sd">            or if invalid level/indices are provided</span>
<span class="sd">        FileNotFoundError: If store_or_path does not exist</span>
<span class="sd">        KeyError: If specified channel labels are not found</span>
<span class="sd">        IOError: If unable to read from the storage backend</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Load full resolution data</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_ome_zarr(&quot;/path/to/data.zarr&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Load specific channels and pyramid level</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_ome_zarr(</span>
<span class="sd">        ...     &quot;/path/to/data.zarr&quot;,</span>
<span class="sd">        ...     level=1,</span>
<span class="sd">        ...     channels=[0, 2],</span>
<span class="sd">        ...     orientation=&quot;LPI&quot;</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Load from cloud storage</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_ome_zarr(</span>
<span class="sd">        ...     &quot;s3://bucket/data.zarr&quot;,</span>
<span class="sd">        ...     storage_options={&quot;key&quot;: &quot;access_key&quot;, &quot;secret&quot;: &quot;secret&quot;}</span>
<span class="sd">        ... )</span>

<span class="sd">    Notes:</span>
<span class="sd">        **Orientation Metadata Backwards Compatibility:**</span>

<span class="sd">        This method implements backwards compatibility for orientation metadata:</span>

<span class="sd">        1. **Priority Order**: Checks for &#39;xyz_orientation&#39; first (new format),</span>
<span class="sd">           then falls back to &#39;orientation&#39; (legacy format)</span>

<span class="sd">        2. **Legacy Fallback**: When only legacy &#39;orientation&#39; is found, the</span>
<span class="sd">           orientation string is automatically reversed to convert from ZYX-based</span>
<span class="sd">           encoding (legacy) to XYZ-based encoding (current standard)</span>

<span class="sd">        3. **Default Fallback**: If no orientation metadata is found, uses the</span>
<span class="sd">           provided &#39;orientation&#39; parameter as the default</span>

<span class="sd">        Examples of the conversion:</span>
<span class="sd">        - Legacy &#39;orientation&#39;=&#39;SAR&#39; (ZYX) → &#39;xyz_orientation&#39;=&#39;RAS&#39; (XYZ)</span>
<span class="sd">        - Legacy &#39;orientation&#39;=&#39;IPL&#39; (ZYX) → &#39;xyz_orientation&#39;=&#39;LPI&#39; (XYZ)</span>

<span class="sd">        This ensures consistent orientation handling while maintaining backwards</span>
<span class="sd">        compatibility with existing OME-Zarr files that use the legacy format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate channel and timepoint selection arguments</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">channel_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify both &#39;channels&#39; and &#39;channel_labels&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Load the multiscales object</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Handle ZIP files by creating a ZipStore</span>
            <span class="k">if</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

                <span class="n">store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span>
                    <span class="n">store</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="p">)</span>
                <span class="c1"># Note: We&#39;ll close the store after extracting metadata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span>
                    <span class="n">store_or_path</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Fallback for older zarr/ngff_zarr versions</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

                <span class="n">store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">store_or_path</span>
            <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>

    <span class="c1"># Extract omero metadata if available</span>
    <span class="n">omero_metadata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                <span class="n">zip_store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">zip_store</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="c1"># Close zip store after getting group</span>
                <span class="n">zip_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;omero&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">omero_dict</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;omero&quot;</span><span class="p">]</span>

            <span class="c1"># Create a simple object to hold omero metadata</span>
            <span class="k">class</span><span class="w"> </span><span class="nc">OmeroMetadata</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omero_dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="s2">&quot;channels&quot;</span> <span class="ow">in</span> <span class="n">omero_dict</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">ch_dict</span> <span class="ow">in</span> <span class="n">omero_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">]:</span>
                            <span class="c1"># Create channel objects</span>
                            <span class="k">class</span><span class="w"> </span><span class="nc">ChannelMetadata</span><span class="p">:</span>
                                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_dict</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">ch_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">ch_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="s2">&quot;window&quot;</span> <span class="ow">in</span> <span class="n">ch_dict</span><span class="p">:</span>

                                        <span class="k">class</span><span class="w"> </span><span class="nc">WindowMetadata</span><span class="p">:</span>
                                            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win_dict</span><span class="p">):</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">win_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">win_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                                    <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="mf">65535.0</span>
                                                <span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">win_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                                    <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="mf">0.0</span>
                                                <span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">win_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                                    <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="mf">65535.0</span>
                                                <span class="p">)</span>

                                        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">WindowMetadata</span><span class="p">(</span>
                                            <span class="n">ch_dict</span><span class="p">[</span><span class="s2">&quot;window&quot;</span><span class="p">]</span>
                                        <span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ChannelMetadata</span><span class="p">(</span><span class="n">ch_dict</span><span class="p">))</span>

            <span class="n">omero_metadata</span> <span class="o">=</span> <span class="n">OmeroMetadata</span><span class="p">(</span><span class="n">omero_dict</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># If we can&#39;t load omero metadata, that&#39;s okay</span>
        <span class="k">pass</span>

    <span class="c1"># Read orientation metadata with backwards compatibility support</span>
    <span class="c1"># Priority: xyz_orientation (new) &gt; orientation (legacy, with reversal)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                <span class="n">zip_store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">zip_store</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="c1"># Check for new xyz_orientation first, then fallback to legacy orientation</span>
                <span class="k">if</span> <span class="s2">&quot;xyz_orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;xyz_orientation&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="c1"># Legacy orientation is ZYX-based, reverse it to get XYZ-based orientation</span>
                    <span class="n">legacy_orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">reverse_orientation_string</span><span class="p">(</span><span class="n">legacy_orientation</span><span class="p">)</span>
                <span class="c1"># If neither found, use the provided default orientation</span>
                <span class="n">zip_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="c1"># Check for new xyz_orientation first, then fallback to legacy orientation</span>
                <span class="k">if</span> <span class="s2">&quot;xyz_orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;xyz_orientation&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="c1"># Legacy orientation is ZYX-based, reverse it to get XYZ-based orientation</span>
                    <span class="n">legacy_orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">reverse_orientation_string</span><span class="p">(</span><span class="n">legacy_orientation</span><span class="p">)</span>
                <span class="c1"># If neither found, use the provided default orientation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="c1"># Check for new xyz_orientation first, then fallback to legacy orientation</span>
            <span class="k">if</span> <span class="s2">&quot;xyz_orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;xyz_orientation&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="c1"># Legacy orientation is ZYX-based, reverse it to get XYZ-based orientation</span>
                <span class="n">legacy_orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="n">reverse_orientation_string</span><span class="p">(</span><span class="n">legacy_orientation</span><span class="p">)</span>
            <span class="c1"># If neither found, use the provided default orientation</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># If we can&#39;t read orientation metadata, use the provided default</span>
        <span class="k">pass</span>

    <span class="c1"># Determine the available pyramid levels and handle lazy downsampling</span>
    <span class="n">max_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiscales</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">actual_level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">max_level</span><span class="p">)</span>
    <span class="n">do_downsample</span> <span class="o">=</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">max_level</span>

    <span class="c1"># Get the highest available level</span>
    <span class="n">ngff_image</span> <span class="o">=</span> <span class="n">multiscales</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">actual_level</span><span class="p">]</span>

    <span class="c1"># Handle channel and timepoint selection and filter omero metadata accordingly</span>
    <span class="n">filtered_omero</span> <span class="o">=</span> <span class="n">omero_metadata</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">channel_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">timepoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngff_image</span><span class="p">,</span> <span class="n">filtered_omero</span> <span class="o">=</span> <span class="n">_select_dimensions_from_image_with_omero</span><span class="p">(</span>
            <span class="n">ngff_image</span><span class="p">,</span>
            <span class="n">multiscales</span><span class="p">,</span>
            <span class="n">channels</span><span class="p">,</span>
            <span class="n">channel_labels</span><span class="p">,</span>
            <span class="n">timepoints</span><span class="p">,</span>
            <span class="n">omero_metadata</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Create ZarrNii instance with xyz_orientation</span>
    <span class="n">znimg</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="n">filtered_omero</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Apply lazy downsampling if needed</span>
    <span class="k">if</span> <span class="n">do_downsample</span><span class="p">:</span>
        <span class="n">level_ds</span> <span class="o">=</span> <span class="n">level</span> <span class="o">-</span> <span class="n">max_level</span>
        <span class="n">downsample_factor</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">level_ds</span>

        <span class="c1"># Get spatial dims based on axes order</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>

        <span class="c1"># Apply downsampling using the existing method</span>
        <span class="n">znimg</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span>
            <span class="n">factors</span><span class="o">=</span><span class="n">downsample_factor</span><span class="p">,</span> <span class="n">spatial_dims</span><span class="o">=</span><span class="n">spatial_dims</span>
        <span class="p">)</span>

    <span class="c1"># Apply near-isotropic downsampling if requested</span>
    <span class="k">if</span> <span class="n">downsample_near_isotropic</span><span class="p">:</span>
        <span class="n">znimg</span> <span class="o">=</span> <span class="n">_apply_near_isotropic_downsampling</span><span class="p">(</span><span class="n">znimg</span><span class="p">,</span> <span class="n">axes_order</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rechunk</span><span class="p">:</span>
        <span class="n">znimg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">znimg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="from_nifti"><code>from_nifti</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.from_nifti"></a>
    <div class="doc doc-contents first">

        <p>Load ZarrNii from NIfTI file with flexible loading options.</p>
<p>Creates a ZarrNii instance from a NIfTI file, automatically converting
the data to dask arrays and extracting spatial transformation information.
Supports both full data loading and reference-only loading for memory
efficiency.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bytes">bytes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>File path to NIfTI file (.nii, .nii.gz, .img/.hdr)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dask array chunking strategy. Can be:
- "auto": Automatic chunking based on file size
- Tuple of ints: Manual chunk sizes for each dimension
- Dict mapping axis to chunk size</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axis ordering convention. Either:
- "XYZ": X=left-right, Y=anterior-posterior, Z=inferior-superior
- "ZYX": Z=inferior-superior, Y=anterior-posterior, X=left-right</p>
              </div>
            </td>
            <td>
                  <code>&#39;XYZ&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional name for the resulting NgffImage. If None,
uses filename without extension</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>as_ref</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, creates empty dask array with correct shape/metadata
without loading actual image data (memory efficient for templates)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zooms</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target voxel spacing as (x, y, z) in mm. Only valid when
as_ref=True. Adjusts shape and affine accordingly</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instance containing NIfTI data and spatial metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If zooms specified with as_ref=False, or invalid axes_order</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If NIfTI file does not exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to read NIfTI file</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="nibabel.filebasedimages.ImageFileError">ImageFileError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If file is not valid NIfTI</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load full NIfTI data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span><span class="s2">&quot;/path/to/brain.nii.gz&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load with custom chunking and axis order</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;/path/to/data.nii&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;ZYX&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create reference with target resolution</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii_ref</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;/path/to/template.nii.gz&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">as_ref</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">zooms</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <p>The method automatically handles NIfTI orientation codes and converts
them to the specified axes_order for consistency with OME-Zarr workflows.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_nifti</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">as_ref</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zooms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load ZarrNii from NIfTI file with flexible loading options.</span>

<span class="sd">    Creates a ZarrNii instance from a NIfTI file, automatically converting</span>
<span class="sd">    the data to dask arrays and extracting spatial transformation information.</span>
<span class="sd">    Supports both full data loading and reference-only loading for memory</span>
<span class="sd">    efficiency.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: File path to NIfTI file (.nii, .nii.gz, .img/.hdr)</span>
<span class="sd">        chunks: Dask array chunking strategy. Can be:</span>
<span class="sd">            - &quot;auto&quot;: Automatic chunking based on file size</span>
<span class="sd">            - Tuple of ints: Manual chunk sizes for each dimension</span>
<span class="sd">            - Dict mapping axis to chunk size</span>
<span class="sd">        axes_order: Spatial axis ordering convention. Either:</span>
<span class="sd">            - &quot;XYZ&quot;: X=left-right, Y=anterior-posterior, Z=inferior-superior</span>
<span class="sd">            - &quot;ZYX&quot;: Z=inferior-superior, Y=anterior-posterior, X=left-right</span>
<span class="sd">        name: Optional name for the resulting NgffImage. If None,</span>
<span class="sd">            uses filename without extension</span>
<span class="sd">        as_ref: If True, creates empty dask array with correct shape/metadata</span>
<span class="sd">            without loading actual image data (memory efficient for templates)</span>
<span class="sd">        zooms: Target voxel spacing as (x, y, z) in mm. Only valid when</span>
<span class="sd">            as_ref=True. Adjusts shape and affine accordingly</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii instance containing NIfTI data and spatial metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If zooms specified with as_ref=False, or invalid axes_order</span>
<span class="sd">        FileNotFoundError: If NIfTI file does not exist</span>
<span class="sd">        OSError: If unable to read NIfTI file</span>
<span class="sd">        nibabel.filebasedimages.ImageFileError: If file is not valid NIfTI</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Load full NIfTI data</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_nifti(&quot;/path/to/brain.nii.gz&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Load with custom chunking and axis order</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_nifti(</span>
<span class="sd">        ...     &quot;/path/to/data.nii&quot;,</span>
<span class="sd">        ...     chunks=(64, 64, 64),</span>
<span class="sd">        ...     axes_order=&quot;ZYX&quot;</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Create reference with target resolution</span>
<span class="sd">        &gt;&gt;&gt; znii_ref = ZarrNii.from_nifti(</span>
<span class="sd">        ...     &quot;/path/to/template.nii.gz&quot;,</span>
<span class="sd">        ...     as_ref=True,</span>
<span class="sd">        ...     zooms=(2.0, 2.0, 2.0)</span>
<span class="sd">        ... )</span>

<span class="sd">    Notes:</span>
<span class="sd">        The method automatically handles NIfTI orientation codes and converts</span>
<span class="sd">        them to the specified axes_order for consistency with OME-Zarr workflows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">as_ref</span> <span class="ow">and</span> <span class="n">zooms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`zooms` can only be used when `as_ref=True`.&quot;</span><span class="p">)</span>

    <span class="c1"># Load NIfTI file</span>
    <span class="n">nifti_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">nifti_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()</span>
    <span class="n">affine_matrix</span> <span class="o">=</span> <span class="n">nifti_img</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Adjust shape and affine if zooms are provided</span>
    <span class="k">if</span> <span class="n">zooms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">in_zooms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">affine_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Current voxel spacing</span>
        <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">in_zooms</span> <span class="o">/</span> <span class="n">zooms</span>
        <span class="n">new_shape</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling_factor</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>  <span class="c1"># Z</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling_factor</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>  <span class="c1"># Y</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>  <span class="c1"># X</span>
        <span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">zooms</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="k">if</span> <span class="n">as_ref</span><span class="p">:</span>
        <span class="c1"># Create an empty dask array with the adjusted shape</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">new_shape</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Load the NIfTI data and convert to a dask array</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">nifti_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>

    <span class="c1"># Add channel and time dimensions if not present</span>
    <span class="n">original_ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">original_ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># 3D data: add channel dimension -&gt; (c, z, y, x) or (c, x, y, z)</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">darr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">original_ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># 4D data: could be (c, z, y, x) or (t, z, y, x) - assume channel by default</span>
        <span class="c1"># User can specify if it&#39;s time by using appropriate axes_order</span>
        <span class="k">pass</span>  <span class="c1"># Keep as is - 4D is already handled</span>
    <span class="k">elif</span> <span class="n">original_ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># 5D data: assume (t, z, y, x, c) and handle appropriately</span>
        <span class="k">pass</span>  <span class="c1"># Keep as is - 5D is already the target format</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For 1D, 2D, or &gt;5D data, add channel dimension and let user handle</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">darr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

    <span class="c1"># Create dimensions based on data shape after dimension adjustments</span>
    <span class="n">final_ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final_ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># 4D: (c, z, y, x) or (c, x, y, z) - standard case</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">final_ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># 5D: (t, c, z, y, x) or (t, c, x, y, z) - time dimension included</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback for other cases</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="c1"># Extract scale and translation from affine</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spatial_dims</span><span class="p">):</span>
        <span class="n">scale</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">affine_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">translation</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Create NgffImage</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;nifti_image_</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">ngff_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">darr</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ngff_image</span><span class="o">=</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="from_imaris"><code>from_imaris</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.from_imaris"></a>
    <div class="doc doc-contents first">

        <p>Load from Imaris (.ims) file format.</p>
<p>Imaris files use HDF5 format with specific dataset structure.
This method requires the 'imaris' extra dependency (h5py).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to Imaris (.ims) file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>level</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution level to load (0 = full resolution)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timepoint</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time point to load (default: 0)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Channel to load (default: 0)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chunking strategy for dask array</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axes order for compatibility (default: "ZYX")</p>
              </div>
            </td>
            <td>
                  <code>&#39;ZYX&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orientation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default orientation (default: "RAS")</p>
              </div>
            </td>
            <td>
                  <code>&#39;RAS&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If h5py is not available</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the file is not a valid Imaris file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_imaris</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">timepoint</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">channel</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load from Imaris (.ims) file format.</span>

<span class="sd">    Imaris files use HDF5 format with specific dataset structure.</span>
<span class="sd">    This method requires the &#39;imaris&#39; extra dependency (h5py).</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path to Imaris (.ims) file</span>
<span class="sd">        level: Resolution level to load (0 = full resolution)</span>
<span class="sd">        timepoint: Time point to load (default: 0)</span>
<span class="sd">        channel: Channel to load (default: 0)</span>
<span class="sd">        chunks: Chunking strategy for dask array</span>
<span class="sd">        axes_order: Spatial axes order for compatibility (default: &quot;ZYX&quot;)</span>
<span class="sd">        orientation: Default orientation (default: &quot;RAS&quot;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii instance</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If h5py is not available</span>
<span class="sd">        ValueError: If the file is not a valid Imaris file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;h5py is required for Imaris support. &quot;</span>
            <span class="s2">&quot;Install with: pip install zarrnii[imaris] or pip install h5py&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Open Imaris file</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Verify it&#39;s an Imaris file by checking for standard structure</span>
        <span class="k">if</span> <span class="s2">&quot;DataSet&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not appear to be a valid Imaris file (missing DataSet group)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Navigate to the specific dataset</span>
        <span class="n">dataset_group</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;DataSet&quot;</span><span class="p">]</span>

        <span class="c1"># Find available resolution levels</span>
        <span class="n">resolution_levels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dataset_group</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ResolutionLevel&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resolution_levels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No resolution levels found in Imaris file&quot;</span><span class="p">)</span>

        <span class="c1"># Validate level parameter</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolution_levels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> not available. Available levels: 0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">resolution_levels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Navigate to specified resolution level</span>
        <span class="n">res_level_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ResolutionLevel </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">res_level_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolution level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">res_group</span> <span class="o">=</span> <span class="n">dataset_group</span><span class="p">[</span><span class="n">res_level_key</span><span class="p">]</span>

        <span class="c1"># Find available timepoints</span>
        <span class="n">timepoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">res_group</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TimePoint&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timepoints</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No timepoints found in Imaris file&quot;</span><span class="p">)</span>

        <span class="c1"># Validate timepoint parameter</span>
        <span class="k">if</span> <span class="n">timepoint</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timepoints</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Timepoint </span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2"> not available. Available timepoints: 0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timepoints</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Navigate to specified timepoint</span>
        <span class="n">time_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TimePoint </span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">time_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timepoint </span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">time_group</span> <span class="o">=</span> <span class="n">res_group</span><span class="p">[</span><span class="n">time_key</span><span class="p">]</span>

        <span class="c1"># Find available channels</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">time_group</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Channel&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No channels found in Imaris file&quot;</span><span class="p">)</span>

        <span class="c1"># Validate channel parameter</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> not available. Available channels: 0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Navigate to specified channel</span>
        <span class="n">channel_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">channel_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">time_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">channel_group</span> <span class="o">=</span> <span class="n">time_group</span><span class="p">[</span><span class="n">channel_key</span><span class="p">]</span>

        <span class="c1"># Load the actual data</span>
        <span class="k">if</span> <span class="s2">&quot;Data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channel_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No Data dataset found in channel group&quot;</span><span class="p">)</span>

        <span class="n">data_dataset</span> <span class="o">=</span> <span class="n">channel_group</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">]</span>

        <span class="c1"># Load data into memory first (necessary because HDF5 file will be closed)</span>
        <span class="n">data_numpy</span> <span class="o">=</span> <span class="n">data_dataset</span><span class="p">[:]</span>

        <span class="c1"># Create dask array from numpy array</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">data_numpy</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>

        <span class="c1"># Add channel dimension if not present</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

        <span class="c1"># Extract spatial metadata</span>
        <span class="c1"># Try to get spacing information from Imaris metadata</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>  <span class="c1"># Default spacing</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>  <span class="c1"># Default origin</span>

        <span class="c1"># Look for ImageSizeX, ImageSizeY, ImageSizeZ attributes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Navigate back to get image info</span>
            <span class="k">if</span> <span class="s2">&quot;ImageSizeX&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">x_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeX&quot;</span><span class="p">]</span>
                <span class="n">y_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeY&quot;</span><span class="p">]</span>
                <span class="n">z_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeZ&quot;</span><span class="p">]</span>

                <span class="c1"># Calculate spacing based on physical size and voxel count</span>
                <span class="k">if</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># X dimension</span>
                    <span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_size</span> <span class="o">/</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Y dimension</span>
                    <span class="n">spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_size</span> <span class="o">/</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Z dimension</span>
                    <span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_size</span> <span class="o">/</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="c1"># Use default spacing if metadata is not available</span>
            <span class="k">pass</span>

        <span class="c1"># Create dimensions</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="c1"># Create scale and translation dictionaries</span>
        <span class="n">scale_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">translation_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spatial_dims</span><span class="p">):</span>
            <span class="n">scale_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">translation_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Create NgffImage</span>
        <span class="n">ngff_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data_array</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale_dict</span><span class="p">,</span>
            <span class="n">translation</span><span class="o">=</span><span class="n">translation_dict</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;imaris_image_</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Create and return ZarrNii instance</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="to_ome_zarr"><code>to_ome_zarr</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.to_ome_zarr"></a>
    <div class="doc doc-contents first">

        <p>Save to OME-Zarr store with multiscale pyramid.</p>
<p>Creates an OME-Zarr dataset with automatic multiscale pyramid generation
for efficient visualization and processing at multiple resolutions.
Preserves spatial metadata and supports various storage backends.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>store_or_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target location for OME-Zarr store. Supports:
- Local directory path
- Remote URLs (s3://, gs://, etc.)
- ZIP files (.zip extension for compressed storage)
- Zarr store objects</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_layer</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of pyramid levels to create (including level 0).
Higher values create more downsampled levels</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale_factors</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom downsampling factors for each pyramid level.
If None, uses powers of 2: [2, 4, 8, 16, ...]</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to underlying to_ngff_zarr function.
May include compression options, chunk sizes, etc.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to write to target location</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If invalid scale_factors provided</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save with default pyramid levels</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_ome_zarr</span><span class="p">(</span><span class="s2">&quot;/path/to/output.zarr&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save to compressed ZIP with custom pyramid</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_ome_zarr</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;/path/to/output.zarr.zip&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">max_layer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">scale_factors</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Chain with other operations</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">... </span>              <span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
<span class="gp">... </span>              <span class="o">.</span><span class="n">to_ome_zarr</span><span class="p">(</span><span class="s2">&quot;processed.zarr&quot;</span><span class="p">))</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>OME-Zarr files are always saved in ZYX axis order</li>
<li>Automatic axis reordering if current order is XYZ</li>
<li>Spatial transformations and metadata are preserved</li>
<li>Orientation information is stored using the new 'xyz_orientation'
  metadata key for consistency and future compatibility</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_ome_zarr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">store_or_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">max_layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">scale_factors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save to OME-Zarr store with multiscale pyramid.</span>

<span class="sd">    Creates an OME-Zarr dataset with automatic multiscale pyramid generation</span>
<span class="sd">    for efficient visualization and processing at multiple resolutions.</span>
<span class="sd">    Preserves spatial metadata and supports various storage backends.</span>

<span class="sd">    Args:</span>
<span class="sd">        store_or_path: Target location for OME-Zarr store. Supports:</span>
<span class="sd">            - Local directory path</span>
<span class="sd">            - Remote URLs (s3://, gs://, etc.)</span>
<span class="sd">            - ZIP files (.zip extension for compressed storage)</span>
<span class="sd">            - Zarr store objects</span>
<span class="sd">        max_layer: Maximum number of pyramid levels to create (including level 0).</span>
<span class="sd">            Higher values create more downsampled levels</span>
<span class="sd">        scale_factors: Custom downsampling factors for each pyramid level.</span>
<span class="sd">            If None, uses powers of 2: [2, 4, 8, 16, ...]</span>
<span class="sd">        **kwargs: Additional arguments passed to underlying to_ngff_zarr function.</span>
<span class="sd">            May include compression options, chunk sizes, etc.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>

<span class="sd">    Raises:</span>
<span class="sd">        OSError: If unable to write to target location</span>
<span class="sd">        ValueError: If invalid scale_factors provided</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Save with default pyramid levels</span>
<span class="sd">        &gt;&gt;&gt; znii.to_ome_zarr(&quot;/path/to/output.zarr&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Save to compressed ZIP with custom pyramid</span>
<span class="sd">        &gt;&gt;&gt; znii.to_ome_zarr(</span>
<span class="sd">        ...     &quot;/path/to/output.zarr.zip&quot;,</span>
<span class="sd">        ...     max_layer=3,</span>
<span class="sd">        ...     scale_factors=[2, 4]</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Chain with other operations</span>
<span class="sd">        &gt;&gt;&gt; result = (znii.downsample(2)</span>
<span class="sd">        ...               .crop((0,0,0), (100,100,100))</span>
<span class="sd">        ...               .to_ome_zarr(&quot;processed.zarr&quot;))</span>

<span class="sd">    Notes:</span>
<span class="sd">        - OME-Zarr files are always saved in ZYX axis order</span>
<span class="sd">        - Automatic axis reordering if current order is XYZ</span>
<span class="sd">        - Spatial transformations and metadata are preserved</span>
<span class="sd">        - Orientation information is stored using the new &#39;xyz_orientation&#39;</span>
<span class="sd">          metadata key for consistency and future compatibility</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the image to save</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
        <span class="c1"># Need to reorder data from XYZ to ZYX for OME-Zarr</span>
        <span class="n">ngff_image_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_zyx_ngff_image</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Already in ZYX order</span>
        <span class="n">ngff_image_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span>

    <span class="n">save_ngff_image</span><span class="p">(</span>
        <span class="n">ngff_image_to_save</span><span class="p">,</span>
        <span class="n">store_or_path</span><span class="p">,</span>
        <span class="n">max_layer</span><span class="p">,</span>
        <span class="n">scale_factors</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xyz_orientation&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Add orientation metadata to the zarr store (only for non-ZIP files)</span>
    <span class="c1"># For ZIP files, orientation is handled inside save_ngff_image</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span>

            <span class="c1"># Add metadata for xyz_orientation (new format)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xyz_orientation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;xyz_orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If we can&#39;t write orientation metadata, that&#39;s not critical</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="to_nifti"><code>to_nifti</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.to_nifti"></a>
    <div class="doc doc-contents first">

        <p>Convert to NIfTI format with automatic dimension handling.</p>
<p>Converts the ZarrNii image to NIfTI-1 format, handling dimension
reordering, singleton dimension removal, and spatial transformation
conversion. NIfTI files are always written in XYZ axis order.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bytes">bytes</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output file path for saving. Supported extensions:
- .nii: Uncompressed NIfTI
- .nii.gz: Compressed NIfTI (recommended)
If None, returns nibabel image object without saving</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="nibabel.Nifti1Image">Nifti1Image</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filename is None: nibabel.Nifti1Image object</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="nibabel.Nifti1Image">Nifti1Image</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filename provided: path to saved file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If data has non-singleton time or channel dimensions
(NIfTI doesn't support &gt;4D data)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to write to specified filename</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Automatically reorders data from ZYX to XYZ if necessary</li>
<li>Removes singleton time/channel dimensions automatically</li>
<li>Spatial transformations are converted to NIfTI affine format</li>
<li>For 5D data (T,C,Z,Y,X), only singleton T/C dimensions are supported</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save to compressed NIfTI file</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_nifti</span><span class="p">(</span><span class="s2">&quot;output.nii.gz&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Get nibabel object without saving</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nifti_img</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">to_nifti</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">nifti_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Handle multi-channel data by selecting single channel first</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">select_channels</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to_nifti</span><span class="p">(</span><span class="s2">&quot;channel0.nii.gz&quot;</span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_nifti</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert to NIfTI format with automatic dimension handling.</span>

<span class="sd">    Converts the ZarrNii image to NIfTI-1 format, handling dimension</span>
<span class="sd">    reordering, singleton dimension removal, and spatial transformation</span>
<span class="sd">    conversion. NIfTI files are always written in XYZ axis order.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Output file path for saving. Supported extensions:</span>
<span class="sd">            - .nii: Uncompressed NIfTI</span>
<span class="sd">            - .nii.gz: Compressed NIfTI (recommended)</span>
<span class="sd">            If None, returns nibabel image object without saving</span>

<span class="sd">    Returns:</span>
<span class="sd">        If filename is None: nibabel.Nifti1Image object</span>
<span class="sd">        If filename provided: path to saved file</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If data has non-singleton time or channel dimensions</span>
<span class="sd">            (NIfTI doesn&#39;t support &gt;4D data)</span>
<span class="sd">        OSError: If unable to write to specified filename</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Automatically reorders data from ZYX to XYZ if necessary</span>
<span class="sd">        - Removes singleton time/channel dimensions automatically</span>
<span class="sd">        - Spatial transformations are converted to NIfTI affine format</span>
<span class="sd">        - For 5D data (T,C,Z,Y,X), only singleton T/C dimensions are supported</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Save to compressed NIfTI file</span>
<span class="sd">        &gt;&gt;&gt; znii.to_nifti(&quot;output.nii.gz&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Get nibabel object without saving</span>
<span class="sd">        &gt;&gt;&gt; nifti_img = znii.to_nifti()</span>
<span class="sd">        &gt;&gt;&gt; print(nifti_img.shape)</span>

<span class="sd">        &gt;&gt;&gt; # Handle multi-channel data by selecting single channel first</span>
<span class="sd">        &gt;&gt;&gt; znii.select_channels([0]).to_nifti(&quot;channel0.nii.gz&quot;)</span>

<span class="sd">    Warnings:</span>
<span class="sd">        Large images will be computed in memory during conversion.</span>
<span class="sd">        Consider downsampling or cropping first for very large datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get data and dimensions</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>

    <span class="c1"># Handle dimensional reduction for NIfTI compatibility</span>
    <span class="c1"># NIfTI supports up to 4D, so we need to remove singleton dimensions</span>
    <span class="n">squeeze_axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining_dims</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Remove singleton time or channel dimensions</span>
            <span class="n">squeeze_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Non-singleton time or channel dimensions - NIfTI can&#39;t handle this</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;NIfTI format doesn&#39;t support non-singleton </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2"> dimension. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Dimension &#39;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&#39; has size </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Consider selecting specific timepoints/channels first.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remaining_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

    <span class="c1"># Squeeze out singleton dimensions</span>
    <span class="k">if</span> <span class="n">squeeze_axes</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">squeeze_axes</span><span class="p">))</span>

    <span class="c1"># Check final dimensionality</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Resulting data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2"> dimensions, but NIfTI supports maximum 4D&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Now handle spatial reordering based on axes_order</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">:</span>
        <span class="c1"># Data spatial dimensions are in ZYX order, need to transpose to XYZ</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Pure spatial data: ZYX -&gt; XYZ</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># 4D data with one non-spatial dimension remaining</span>
            <span class="c1"># Could be (T,Z,Y,X) or (C,Z,Y,X) - spatial part needs ZYX-&gt;XYZ</span>
            <span class="c1"># The non-spatial dimension stays first</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get affine matrix in XYZ order</span>
        <span class="n">affine_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_affine_matrix</span><span class="p">(</span><span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;XYZ&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Data is already in XYZ order</span>
        <span class="n">affine_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_affine_matrix</span><span class="p">(</span><span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;XYZ&quot;</span><span class="p">)</span>

    <span class="c1"># Create NIfTI image</span>
    <span class="n">nifti_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nifti_img</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nifti_img</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="to_tiff_stack"><code>to_tiff_stack</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.to_tiff_stack"></a>
    <div class="doc doc-contents first">

        <p>Save data as a stack of 2D TIFF images.</p>
<p>Saves the image data as a series of 2D TIFF files, with each Z-slice
saved as a separate file. This format is useful for compatibility with
tools that don't support OME-Zarr or napari plugins that require
individual TIFF files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename_pattern</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output filename pattern. Should contain '{z:04d}' or similar
format specifier for the Z-slice number. Examples:
- "output_z{z:04d}.tif"
- "data/slice_{z:03d}.tiff"
If pattern doesn't contain format specifier, '_{z:04d}' is appended
before the extension.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Channel index to save (0-based). If None and data has multiple
channels, all channels will be saved as separate channel dimensions
in each TIFF file (multi-channel TIFFs).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timepoint</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timepoint index to save (0-based). If None and data has multiple
timepoints, raises ValueError (must select single timepoint).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use LZW compression (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output data type for TIFF files. Options:
- 'uint8': 8-bit unsigned integer (0-255)
- 'uint16': 16-bit unsigned integer (0-65535) [default]
- 'int16': 16-bit signed integer (-32768 to 32767)
- 'float32': 32-bit float (preserves original data)
Default 'uint16' provides good range and compatibility.</p>
              </div>
            </td>
            <td>
                  <code>&#39;uint16&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rescale</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to rescale data to fit the output dtype range.
If True, data is linearly scaled from [min, max] to the full
range of the output dtype. If False, data is clipped to the
output dtype range. Default: True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base directory path where files were saved</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If data has multiple timepoints but none selected,
or if selected channel/timepoint is out of range,
or if dtype is not supported</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to write to specified directory</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save as 16-bit with auto-rescaling (default, recommended)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_tiff_stack</span><span class="p">(</span><span class="s2">&quot;output_z</span><span class="si">{z:04d}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save as 8-bit for smaller file sizes</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_tiff_stack</span><span class="p">(</span><span class="s2">&quot;output_z</span><span class="si">{z:04d}</span><span class="s2">.tif&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save specific channel without rescaling</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_tiff_stack</span><span class="p">(</span><span class="s2">&quot;channel0_z</span><span class="si">{z:04d}</span><span class="s2">.tif&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save as float32 to preserve original precision</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_tiff_stack</span><span class="p">(</span><span class="s2">&quot;precise_z</span><span class="si">{z:04d}</span><span class="s2">.tif&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Z-dimension becomes the stack (file) dimension</li>
<li>Time and channel dimensions are handled as specified</li>
<li>Spatial transformations are not preserved in TIFF format</li>
<li>For 5D data (T,C,Z,Y,X), you must select a single timepoint</li>
<li>Multi-channel data can be saved as multi-channel TIFFs or selected</li>
<li>Data type conversion helps ensure compatibility with analysis tools</li>
<li>uint16 is recommended for most scientific applications (good range + compatibility)</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_tiff_stack</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">filename_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">channel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timepoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uint16&quot;</span><span class="p">,</span>
    <span class="n">rescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save data as a stack of 2D TIFF images.</span>

<span class="sd">    Saves the image data as a series of 2D TIFF files, with each Z-slice</span>
<span class="sd">    saved as a separate file. This format is useful for compatibility with</span>
<span class="sd">    tools that don&#39;t support OME-Zarr or napari plugins that require</span>
<span class="sd">    individual TIFF files.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename_pattern: Output filename pattern. Should contain &#39;{z:04d}&#39; or similar</span>
<span class="sd">            format specifier for the Z-slice number. Examples:</span>
<span class="sd">            - &quot;output_z{z:04d}.tif&quot;</span>
<span class="sd">            - &quot;data/slice_{z:03d}.tiff&quot;</span>
<span class="sd">            If pattern doesn&#39;t contain format specifier, &#39;_{z:04d}&#39; is appended</span>
<span class="sd">            before the extension.</span>
<span class="sd">        channel: Channel index to save (0-based). If None and data has multiple</span>
<span class="sd">            channels, all channels will be saved as separate channel dimensions</span>
<span class="sd">            in each TIFF file (multi-channel TIFFs).</span>
<span class="sd">        timepoint: Timepoint index to save (0-based). If None and data has multiple</span>
<span class="sd">            timepoints, raises ValueError (must select single timepoint).</span>
<span class="sd">        compress: Whether to use LZW compression (default: True)</span>
<span class="sd">        dtype: Output data type for TIFF files. Options:</span>
<span class="sd">            - &#39;uint8&#39;: 8-bit unsigned integer (0-255)</span>
<span class="sd">            - &#39;uint16&#39;: 16-bit unsigned integer (0-65535) [default]</span>
<span class="sd">            - &#39;int16&#39;: 16-bit signed integer (-32768 to 32767)</span>
<span class="sd">            - &#39;float32&#39;: 32-bit float (preserves original data)</span>
<span class="sd">            Default &#39;uint16&#39; provides good range and compatibility.</span>
<span class="sd">        rescale: Whether to rescale data to fit the output dtype range.</span>
<span class="sd">            If True, data is linearly scaled from [min, max] to the full</span>
<span class="sd">            range of the output dtype. If False, data is clipped to the</span>
<span class="sd">            output dtype range. Default: True</span>

<span class="sd">    Returns:</span>
<span class="sd">        Base directory path where files were saved</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If data has multiple timepoints but none selected,</span>
<span class="sd">            or if selected channel/timepoint is out of range,</span>
<span class="sd">            or if dtype is not supported</span>
<span class="sd">        OSError: If unable to write to specified directory</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Save as 16-bit with auto-rescaling (default, recommended)</span>
<span class="sd">        &gt;&gt;&gt; znii.to_tiff_stack(&quot;output_z{z:04d}.tif&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Save as 8-bit for smaller file sizes</span>
<span class="sd">        &gt;&gt;&gt; znii.to_tiff_stack(&quot;output_z{z:04d}.tif&quot;, dtype=&#39;uint8&#39;)</span>

<span class="sd">        &gt;&gt;&gt; # Save specific channel without rescaling</span>
<span class="sd">        &gt;&gt;&gt; znii.to_tiff_stack(&quot;channel0_z{z:04d}.tif&quot;, channel=0, rescale=False)</span>

<span class="sd">        &gt;&gt;&gt; # Save as float32 to preserve original precision</span>
<span class="sd">        &gt;&gt;&gt; znii.to_tiff_stack(&quot;precise_z{z:04d}.tif&quot;, dtype=&#39;float32&#39;)</span>

<span class="sd">    Warnings:</span>
<span class="sd">        This method loads all data into memory. For large datasets,</span>
<span class="sd">        consider cropping or downsampling first to reduce memory usage.</span>
<span class="sd">        The cellseg3d napari plugin and similar tools work best with</span>
<span class="sd">        cropped regions rather than full-resolution whole-brain images.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Z-dimension becomes the stack (file) dimension</span>
<span class="sd">        - Time and channel dimensions are handled as specified</span>
<span class="sd">        - Spatial transformations are not preserved in TIFF format</span>
<span class="sd">        - For 5D data (T,C,Z,Y,X), you must select a single timepoint</span>
<span class="sd">        - Multi-channel data can be saved as multi-channel TIFFs or selected</span>
<span class="sd">        - Data type conversion helps ensure compatibility with analysis tools</span>
<span class="sd">        - uint16 is recommended for most scientific applications (good range + compatibility)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tifffile</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;tifffile is required for TIFF stack support. &quot;</span>
            <span class="s2">&quot;Install with: pip install tifffile&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get data and dimensions</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>

    <span class="c1"># Create output directory if needed</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename_pattern</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Handle dimensional selection and validation</span>
    <span class="c1"># Remove singleton dimensions first, similar to to_nifti</span>
    <span class="n">squeeze_axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining_dims</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_dim_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">channel_dim_size</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">time_dim_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">squeeze_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">timepoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> timepoints. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Must specify &#39;timepoint&#39; parameter to select a single timepoint.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">timepoint</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Timepoint </span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2"> is out of range (data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> timepoints)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remaining_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
            <span class="n">channel_dim_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">squeeze_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">channel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> channels. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Must specify &#39;channel&#39; parameter to select a single channel.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> is out of range (data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> channels)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remaining_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remaining_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

    <span class="c1"># Select specific timepoint if needed</span>
    <span class="k">if</span> <span class="n">time_dim_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">timepoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timepoint</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">)</span>
        <span class="c1"># Update dims list</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">time_axis</span><span class="p">]</span>

    <span class="c1"># Select specific channel if needed</span>
    <span class="k">if</span> <span class="n">channel_dim_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">channel_axis</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">channel_axis</span><span class="p">)</span>
        <span class="c1"># Update dims list</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">channel_axis</span><span class="p">]</span>

    <span class="c1"># Squeeze singleton dimensions</span>
    <span class="k">if</span> <span class="n">squeeze_axes</span><span class="p">:</span>
        <span class="c1"># Recalculate squeeze axes after potential dimension removal</span>
        <span class="n">current_squeeze_axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">squeeze_axes</span><span class="p">:</span>
            <span class="c1"># Count how many axes were removed before this one</span>
            <span class="n">removed_before</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="mi">1</span>
                <span class="k">for</span> <span class="n">removed_axis</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">time_dim_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">timepoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="p">),</span>
                    <span class="p">(</span>
                        <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">channel_dim_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="p">),</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">removed_axis</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">removed_axis</span> <span class="o">&lt;</span> <span class="n">axis</span>
            <span class="p">)</span>
            <span class="n">current_squeeze_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span> <span class="o">-</span> <span class="n">removed_before</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">current_squeeze_axes</span><span class="p">))</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_squeeze_axes</span><span class="p">]</span>

    <span class="c1"># Find Z dimension for stacking</span>
    <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data must have a Z dimension for TIFF stack export&quot;</span><span class="p">)</span>

    <span class="n">z_axis</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
    <span class="n">z_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">z_axis</span><span class="p">]</span>

    <span class="c1"># Check filename pattern contains format specifier</span>
    <span class="k">if</span> <span class="s2">&quot;{z&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename_pattern</span><span class="p">:</span>
        <span class="c1"># Add default z format before extension</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_pattern</span><span class="p">)</span>
        <span class="n">filename_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="se">{{</span><span class="s2">z:04d</span><span class="se">}}</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Move Z axis to first position for easy iteration</span>
    <span class="n">axes_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
    <span class="n">axes_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes_order</span><span class="p">[</span><span class="n">z_axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_order</span><span class="p">[</span><span class="n">z_axis</span><span class="p">],</span> <span class="n">axes_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axes_order</span><span class="p">)</span>

    <span class="c1"># Handle data type conversion and rescaling</span>
    <span class="n">supported_dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;uint8&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="s2">&quot;uint16&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
        <span class="s2">&quot;int16&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
        <span class="s2">&quot;float32&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_dtypes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported dtype &#39;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&#39;. Supported types: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">supported_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">target_dtype</span> <span class="o">=</span> <span class="n">supported_dtypes</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">rescale</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
        <span class="c1"># Get the data range</span>
        <span class="n">data_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data_min</span> <span class="o">==</span> <span class="n">data_max</span><span class="p">:</span>
            <span class="c1"># Handle constant data case</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">target_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get target range for the dtype</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
                <span class="n">target_min</span><span class="p">,</span> <span class="n">target_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span>
            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
                <span class="n">target_min</span><span class="p">,</span> <span class="n">target_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span>
            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;int16&quot;</span><span class="p">:</span>
                <span class="n">target_min</span><span class="p">,</span> <span class="n">target_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">,</span> <span class="mi">32767</span>

            <span class="c1"># Linear rescaling: new_value = (value - data_min) * (target_max - target_min) / (data_max - data_min) + target_min</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">data_min</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">target_max</span> <span class="o">-</span> <span class="n">target_min</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">data_max</span> <span class="o">-</span> <span class="n">data_min</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">target_min</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Rescaled data from [</span><span class="si">{</span><span class="n">data_min</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">data_max</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] to </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> range&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No rescaling - just clip and convert</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;int16&quot;</span><span class="p">:</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">32768</span><span class="p">,</span> <span class="mi">32767</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># float32</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted data to </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> with clipping (no rescaling)&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_scaled</span>

    <span class="c1"># Save each Z-slice as a separate TIFF file</span>
    <span class="n">compression</span> <span class="o">=</span> <span class="s2">&quot;lzw&quot;</span> <span class="k">if</span> <span class="n">compress</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">saved_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">z_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_size</span><span class="p">):</span>
        <span class="n">slice_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">z_idx</span><span class="p">]</span>

        <span class="c1"># Generate filename for this slice</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z_idx</span><span class="p">)</span>

        <span class="c1"># Save the 2D slice</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">slice_data</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">)</span>
        <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">saved_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> TIFF files to </span><span class="si">{</span><span class="n">output_dir</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Files: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">saved_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> ... </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">saved_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">output_dir</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="to_imaris"><code>to_imaris</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.to_imaris"></a>
    <div class="doc doc-contents first">

        <p>Save to Imaris (.ims) file format using HDF5.</p>
<p>This method creates Imaris files compatible with Imaris software by
following the exact HDF5 structure from correctly-formed reference files.
All attributes use byte-array encoding as required by Imaris.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output path for Imaris (.ims) file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HDF5 compression method (default: "gzip")</p>
              </div>
            </td>
            <td>
                  <code>&#39;gzip&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression_opts</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression level (default: 6)</p>
              </div>
            </td>
            <td>
                  <code>6</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If h5py is not available</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_imaris</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="n">compression_opts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save to Imaris (.ims) file format using HDF5.</span>

<span class="sd">    This method creates Imaris files compatible with Imaris software by</span>
<span class="sd">    following the exact HDF5 structure from correctly-formed reference files.</span>
<span class="sd">    All attributes use byte-array encoding as required by Imaris.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Output path for Imaris (.ims) file</span>
<span class="sd">        compression: HDF5 compression method (default: &quot;gzip&quot;)</span>
<span class="sd">        compression_opts: Compression level (default: 6)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the saved file</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If h5py is not available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;h5py is required for Imaris support. &quot;</span>
            <span class="s2">&quot;Install with: pip install zarrnii[imaris] or pip install h5py&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Ensure path has .ims extension</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ims&quot;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.ims&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_string_to_byte_array</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert string to byte array as required by Imaris.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span>

    <span class="c1"># Get data and metadata</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>  <span class="c1"># Convert Dask array to numpy array</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="p">)</span>  <span class="c1"># Handle numpy arrays directly</span>

    <span class="c1"># Handle dimensions: expect ZYX or CZYX</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># CZYX format</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># ZYX format - single channel</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># Add channel dimension</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported data shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Expected 3D (ZYX) or 4D (CZYX)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Create Imaris file structure exactly matching reference file</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Root attributes - use exact byte array format from reference</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;DataSetDirectoryName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;DataSet&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;DataSetInfoDirectoryName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;DataSetInfo&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImarisDataSet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;ImarisDataSet&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImarisVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;5.5.0&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumberOfDataSets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ThumbnailDirectoryName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;Thumbnail&quot;</span><span class="p">)</span>

        <span class="c1"># Create main DataSet group structure</span>
        <span class="n">dataset_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;DataSet&quot;</span><span class="p">)</span>
        <span class="n">res_group</span> <span class="o">=</span> <span class="n">dataset_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ResolutionLevel 0&quot;</span><span class="p">)</span>
        <span class="n">time_group</span> <span class="o">=</span> <span class="n">res_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;TimePoint 0&quot;</span><span class="p">)</span>

        <span class="c1"># Create channels with proper attributes</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channels</span><span class="p">):</span>
            <span class="n">channel_group</span> <span class="o">=</span> <span class="n">time_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">channel_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>  <span class="c1"># (Z, Y, X)</span>

            <span class="c1"># Channel attributes - use byte array format exactly like reference</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageBlockSizeX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageBlockSizeY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageBlockSizeZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># Histogram range attributes</span>
            <span class="n">data_min</span><span class="p">,</span> <span class="n">data_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">channel_data</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">channel_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;HistogramMin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_min</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;HistogramMax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_max</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Create data dataset with proper compression</span>
            <span class="c1"># Preserve original data type but ensure it&#39;s compatible with Imaris</span>
            <span class="k">if</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="ow">or</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="c1"># Keep float data as is for round-trip compatibility</span>
                <span class="n">data_for_storage</span> <span class="o">=</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">]:</span>
                <span class="c1"># Keep 16-bit data as is</span>
                <span class="n">data_for_storage</span> <span class="o">=</span> <span class="n">channel_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Convert other types to uint8</span>
                <span class="n">data_for_storage</span> <span class="o">=</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="n">channel_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;Data&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data_for_storage</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                <span class="n">compression_opts</span><span class="o">=</span><span class="n">compression_opts</span><span class="p">,</span>
                <span class="n">chunks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create histogram</span>
            <span class="n">hist_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">channel_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span> <span class="n">data_max</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;Histogram&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Get spacing directly from scale dictionary with proper XYZ order</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract voxel sizes directly from ngff_image scale dictionary</span>
            <span class="c1"># This ensures we get X, Y, Z in the correct order regardless of axes_order</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Calculate extents (physical coordinates)</span>
        <span class="n">ext_x</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">x</span>
        <span class="n">ext_y</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">y</span>
        <span class="n">ext_z</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">*</span> <span class="n">z</span>

        <span class="c1"># Create comprehensive DataSetInfo structure matching reference</span>
        <span class="n">info_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;DataSetInfo&quot;</span><span class="p">)</span>

        <span class="c1"># Create channel info groups</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channels</span><span class="p">):</span>
            <span class="n">channel_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Essential channel attributes in byte array format</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="s2">&quot;1.000 0.000 0.000&quot;</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;0.000 </span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mf">0.0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mf">0.0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ColorMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;BaseColor&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ColorOpacity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1.000&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ColorRange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;0 255&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;GammaCorrection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1.000&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LSMEmissionWavelength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="s2">&quot;500&quot;</span>
            <span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LSMExcitationWavelength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="s2">&quot;500&quot;</span>
            <span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LSMPhotons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LSMPinhole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>

            <span class="c1"># Add description</span>
            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> created by ZarrNii&quot;</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># Create CRITICAL Image group with voxel size information (this was missing!)</span>
        <span class="n">image_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;Image&quot;</span><span class="p">)</span>

        <span class="c1"># Add essential image metadata with proper voxel size information</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;um&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Noc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n_channels</span><span class="p">))</span>

        <span class="c1"># CRITICAL: Set proper physical extents that define voxel size</span>
        <span class="c1"># Imaris reads voxel size from these extent values</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMin0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="n">ext_x</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMax0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ext_x</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMin1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="n">ext_y</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMax1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ext_y</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMin2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="n">ext_z</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMax2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ext_z</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add device/acquisition metadata</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ManufactorString&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;ZarrNii&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ManufactorType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;Generic&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LensPower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumericalAperture&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;RecordingDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
            <span class="s2">&quot;2024-01-01 00:00:00.000&quot;</span>
        <span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;ZarrNii Export&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Compression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;5794&quot;</span><span class="p">)</span>

        <span class="c1"># Add description</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Imaris file created by ZarrNii from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="si">}</span><span class="s2"> format data. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Original shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Converted to Imaris format &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;with </span><span class="si">{</span><span class="n">n_channels</span><span class="si">}</span><span class="s2"> channel(s) and dimensions </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Voxel size: </span><span class="si">{</span><span class="n">sx</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">sy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">sz</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> um.&quot;</span>
        <span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># Create Imaris metadata group</span>
        <span class="n">imaris_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;Imaris&quot;</span><span class="p">)</span>
        <span class="n">imaris_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;7.0&quot;</span><span class="p">)</span>
        <span class="n">imaris_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ThumbnailMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;thumbnailMIP&quot;</span><span class="p">)</span>
        <span class="n">imaris_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ThumbnailSize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;256&quot;</span><span class="p">)</span>

        <span class="c1"># Create ImarisDataSet metadata</span>
        <span class="n">dataset_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ImarisDataSet&quot;</span><span class="p">)</span>
        <span class="n">dataset_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Creator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;Imaris&quot;</span><span class="p">)</span>
        <span class="n">dataset_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;7.0&quot;</span><span class="p">)</span>
        <span class="n">dataset_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumberOfImages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="c1"># Add version-specific groups as seen in reference</span>
        <span class="n">dataset_info_ver</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ImarisDataSet       0.0.0&quot;</span><span class="p">)</span>
        <span class="n">dataset_info_ver</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumberOfImages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">dataset_info_ver2</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ImarisDataSet      0.0.0&quot;</span><span class="p">)</span>
        <span class="n">dataset_info_ver2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumberOfImages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="c1"># Create TimeInfo group</span>
        <span class="n">time_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;TimeInfo&quot;</span><span class="p">)</span>
        <span class="n">time_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;DatasetTimePoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">time_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;FileTimePoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">time_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;TimePoint1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
            <span class="s2">&quot;2024-01-01 00:00:00.000&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create Log group (basic processing log)</span>
        <span class="n">log_group</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;Log&quot;</span><span class="p">)</span>
        <span class="n">log_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Entries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">log_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Entry0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;ZarrNiiExport channels=</span><span class="se">\&quot;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;on&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_channels</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">/&gt;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create thumbnail group with proper multi-channel thumbnail</span>
        <span class="n">thumbnail_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;Thumbnail&quot;</span><span class="p">)</span>

        <span class="c1"># Create a combined thumbnail (256x1024 for multi-channel as in reference)</span>
        <span class="k">if</span> <span class="n">n_channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Multi-channel thumbnail: concatenate channels horizontally</span>
            <span class="n">thumb_width</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">n_channels</span>
            <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="n">thumb_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channels</span><span class="p">):</span>
                <span class="c1"># Downsample each channel to 256x256</span>
                <span class="n">channel_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="c1"># Take MIP (Maximum Intensity Projection) along Z</span>
                <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channel_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Resize to 256x256 (simple decimation)</span>
                <span class="n">step_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span>
                <span class="n">step_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span>
                <span class="n">thumb_channel</span> <span class="o">=</span> <span class="n">mip</span><span class="p">[::</span><span class="n">step_y</span><span class="p">,</span> <span class="p">::</span><span class="n">step_x</span><span class="p">]</span>

                <span class="c1"># Pad or crop to exactly 256x256</span>
                <span class="k">if</span> <span class="n">thumb_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="ow">or</span> <span class="n">thumb_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
                    <span class="n">padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">thumb_channel</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">thumb_channel</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">padded</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">thumb_channel</span>
                    <span class="n">thumb_channel</span> <span class="o">=</span> <span class="n">padded</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">thumb_channel</span> <span class="o">=</span> <span class="n">thumb_channel</span><span class="p">[:</span><span class="mi">256</span><span class="p">,</span> <span class="p">:</span><span class="mi">256</span><span class="p">]</span>

                <span class="c1"># Place in thumbnail</span>
                <span class="n">thumbnail_data</span><span class="p">[:,</span> <span class="n">c</span> <span class="o">*</span> <span class="mi">256</span> <span class="p">:</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="n">thumb_channel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single channel: 256x256 thumbnail</span>
            <span class="n">channel_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channel_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">step_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span>
            <span class="n">step_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span>
            <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">mip</span><span class="p">[::</span><span class="n">step_y</span><span class="p">,</span> <span class="p">::</span><span class="n">step_x</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">thumbnail_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="ow">or</span> <span class="n">thumbnail_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
                <span class="n">padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">thumbnail_data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">thumbnail_data</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">padded</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">thumbnail_data</span>
                <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">padded</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">thumbnail_data</span><span class="p">[:</span><span class="mi">256</span><span class="p">,</span> <span class="p">:</span><span class="mi">256</span><span class="p">]</span>

        <span class="n">thumbnail_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">thumbnail_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="crop"><code>crop</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.crop"></a>
    <div class="doc doc-contents first">

        <p>Extract a spatial region or multiple regions from the image.</p>
<p>Crops the image to the specified bounding box coordinates, preserving
all metadata and non-spatial dimensions (channels, time). The cropping
is performed in voxel coordinates by default, or physical coordinates
if specified. Can crop a single region or multiple regions at once.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bbox_min</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, ...], <span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, ...], <span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, ...]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either:
- Minimum corner coordinates of bounding box as tuple
  (when bbox_max is provided). Length should match number of
  spatial dimensions (x, y, z order)
- List of (bbox_min, bbox_max) tuples for batch cropping
  (when bbox_max is None)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox_max</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum corner coordinates of bounding box as tuple.
Length should match number of spatial dimensions (x, y, z order).
Should be None when bbox_min is a list of bounding boxes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spatial_dims</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of spatial dimensions to crop. If None,
automatically derived from axes_order ("z","y","x" for ZYX
or "x","y","z" for XYZ)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>physical_coords</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, bbox_min and bbox_max are in physical/world
coordinates (mm). If False, they are in voxel coordinates.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[&#39;ZarrNii&#39;, <span title="typing.List">List</span>[&#39;ZarrNii&#39;]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with cropped data (single crop) or list of</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[&#39;ZarrNii&#39;, <span title="typing.List">List</span>[&#39;ZarrNii&#39;]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instances (batch crop) with updated spatial metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If bbox coordinates are invalid or out of bounds, or
if both list and bbox_max are provided</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="IndexError">IndexError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If bbox dimensions don't match spatial dimensions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Crop 3D region (voxel coordinates)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cropped</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">130</span><span class="p">))</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Crop with physical coordinates</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cropped</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="mf">10.5</span><span class="p">,</span> <span class="mf">20.5</span><span class="p">,</span> <span class="mf">30.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">110.5</span><span class="p">,</span> <span class="mf">120.5</span><span class="p">,</span> <span class="mf">130.5</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="n">physical_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Crop with explicit spatial dimensions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cropped</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">170</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">spatial_dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Batch crop multiple regions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">)),</span>
<span class="gp">... </span>    <span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">170</span><span class="p">))</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cropped_list</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">physical_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Coordinates are in voxel space (0-based indexing) by default</li>
<li>Physical coordinates are in RAS orientation (Right-Anterior-Superior)</li>
<li>The cropped region includes bbox_min but excludes bbox_max</li>
<li>All non-spatial dimensions (channels, time) are preserved</li>
<li>Spatial transformations are automatically updated</li>
<li>When batch cropping, all patches share the same spatial_dims and
  physical_coords settings</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">bbox_min</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span>
    <span class="p">],</span>
    <span class="n">bbox_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spatial_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">physical_coords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;ZarrNii&quot;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;ZarrNii&quot;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract a spatial region or multiple regions from the image.</span>

<span class="sd">    Crops the image to the specified bounding box coordinates, preserving</span>
<span class="sd">    all metadata and non-spatial dimensions (channels, time). The cropping</span>
<span class="sd">    is performed in voxel coordinates by default, or physical coordinates</span>
<span class="sd">    if specified. Can crop a single region or multiple regions at once.</span>

<span class="sd">    Args:</span>
<span class="sd">        bbox_min: Either:</span>
<span class="sd">            - Minimum corner coordinates of bounding box as tuple</span>
<span class="sd">              (when bbox_max is provided). Length should match number of</span>
<span class="sd">              spatial dimensions (x, y, z order)</span>
<span class="sd">            - List of (bbox_min, bbox_max) tuples for batch cropping</span>
<span class="sd">              (when bbox_max is None)</span>
<span class="sd">        bbox_max: Maximum corner coordinates of bounding box as tuple.</span>
<span class="sd">            Length should match number of spatial dimensions (x, y, z order).</span>
<span class="sd">            Should be None when bbox_min is a list of bounding boxes.</span>
<span class="sd">        spatial_dims: Names of spatial dimensions to crop. If None,</span>
<span class="sd">            automatically derived from axes_order (&quot;z&quot;,&quot;y&quot;,&quot;x&quot; for ZYX</span>
<span class="sd">            or &quot;x&quot;,&quot;y&quot;,&quot;z&quot; for XYZ)</span>
<span class="sd">        physical_coords: If True, bbox_min and bbox_max are in physical/world</span>
<span class="sd">            coordinates (mm). If False, they are in voxel coordinates.</span>
<span class="sd">            Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with cropped data (single crop) or list of</span>
<span class="sd">        ZarrNii instances (batch crop) with updated spatial metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If bbox coordinates are invalid or out of bounds, or</span>
<span class="sd">            if both list and bbox_max are provided</span>
<span class="sd">        IndexError: If bbox dimensions don&#39;t match spatial dimensions</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Crop 3D region (voxel coordinates)</span>
<span class="sd">        &gt;&gt;&gt; cropped = znii.crop((10, 20, 30), (110, 120, 130))</span>

<span class="sd">        &gt;&gt;&gt; # Crop with physical coordinates</span>
<span class="sd">        &gt;&gt;&gt; cropped = znii.crop((10.5, 20.5, 30.5), (110.5, 120.5, 130.5),</span>
<span class="sd">        ...                      physical_coords=True)</span>

<span class="sd">        &gt;&gt;&gt; # Crop with explicit spatial dimensions</span>
<span class="sd">        &gt;&gt;&gt; cropped = znii.crop(</span>
<span class="sd">        ...     (50, 60, 70), (150, 160, 170),</span>
<span class="sd">        ...     spatial_dims=[&quot;x&quot;, &quot;y&quot;, &quot;z&quot;]</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Batch crop multiple regions</span>
<span class="sd">        &gt;&gt;&gt; bboxes = [</span>
<span class="sd">        ...     ((10, 20, 30), (60, 70, 80)),</span>
<span class="sd">        ...     ((100, 110, 120), (150, 160, 170))</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; cropped_list = znii.crop(bboxes, physical_coords=True)</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Coordinates are in voxel space (0-based indexing) by default</span>
<span class="sd">        - Physical coordinates are in RAS orientation (Right-Anterior-Superior)</span>
<span class="sd">        - The cropped region includes bbox_min but excludes bbox_max</span>
<span class="sd">        - All non-spatial dimensions (channels, time) are preserved</span>
<span class="sd">        - Spatial transformations are automatically updated</span>
<span class="sd">        - When batch cropping, all patches share the same spatial_dims and</span>
<span class="sd">          physical_coords settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if this is batch cropping (list of bounding boxes)</span>
    <span class="c1"># A batch crop is a list of (bbox_min, bbox_max) tuples</span>
    <span class="c1"># Each element should be a tuple/list of two elements</span>
    <span class="n">is_batch_crop</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_batch_crop</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bbox_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;bbox_max should be None when bbox_min is a list of bounding boxes&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Batch crop: recursively call crop for each bounding box</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span> <span class="n">bmax</span><span class="p">,</span> <span class="n">spatial_dims</span><span class="p">,</span> <span class="n">physical_coords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bmax</span> <span class="ow">in</span> <span class="n">bbox_min</span>
        <span class="p">]</span>

    <span class="c1"># Single crop: original implementation</span>
    <span class="k">if</span> <span class="n">bbox_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bbox_max is required when bbox_min is not a list&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spatial_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Convert physical coordinates to voxel coordinates if needed</span>
    <span class="k">if</span> <span class="n">physical_coords</span><span class="p">:</span>
        <span class="c1"># Physical coords are always in (x, y, z) order</span>
        <span class="c1"># Convert to homogeneous coordinates</span>
        <span class="n">phys_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>
        <span class="n">phys_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bbox_max</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>

        <span class="c1"># Get inverse affine to convert from physical to voxel</span>
        <span class="n">affine_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

        <span class="c1"># Transform to voxel coordinates</span>
        <span class="n">voxel_min</span> <span class="o">=</span> <span class="n">affine_inv</span> <span class="o">@</span> <span class="n">phys_min</span>
        <span class="n">voxel_max</span> <span class="o">=</span> <span class="n">affine_inv</span> <span class="o">@</span> <span class="n">phys_max</span>

        <span class="c1"># Extract voxel coordinates (x, y, z)</span>
        <span class="n">voxel_min_xyz</span> <span class="o">=</span> <span class="n">voxel_min</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">voxel_max_xyz</span> <span class="o">=</span> <span class="n">voxel_max</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Round to nearest integer voxel indices</span>
        <span class="n">voxel_min_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">voxel_min_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">voxel_max_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">voxel_max_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Ensure max &gt;= min</span>
        <span class="n">voxel_min_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">voxel_min_xyz</span><span class="p">,</span> <span class="n">voxel_max_xyz</span><span class="p">)</span>
        <span class="n">voxel_max_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">affine_inv</span> <span class="o">@</span> <span class="n">phys_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">affine_inv</span> <span class="o">@</span> <span class="n">phys_max</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Create mapping from x,y,z to voxel coordinates</span>
        <span class="n">xyz_to_voxel</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">voxel_min_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">voxel_min_xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">voxel_min_xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">xyz_to_voxel_max</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">voxel_max_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">voxel_max_xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">voxel_max_xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Reorder according to spatial_dims</span>
        <span class="n">bbox_min</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xyz_to_voxel</span><span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">spatial_dims</span><span class="p">)</span>
        <span class="n">bbox_max</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xyz_to_voxel_max</span><span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">spatial_dims</span><span class="p">)</span>

    <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">crop_ngff_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">bbox_min</span><span class="p">,</span> <span class="n">bbox_max</span><span class="p">,</span> <span class="n">spatial_dims</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">cropped_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="downsample"><code>downsample</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.downsample"></a>
    <div class="doc doc-contents first">

        <p>Reduce image resolution by downsampling.</p>
<p>Performs spatial downsampling by averaging blocks of voxels, effectively
reducing image resolution and size. Multiple parameter options provide
flexibility for different downsampling strategies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>factors</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="typing.List">List</span>[<span title="int">int</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Downsampling factors for spatial dimensions. Can be:
- int: Same factor applied to all spatial dimensions
- List[int]: Per-dimension factors matching spatial_dims order
- None: Use other parameters to determine factors</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_x</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Downsampling factor for X dimension (legacy parameter)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_y</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Downsampling factor for Y dimension (legacy parameter)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_z</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Downsampling factor for Z dimension (legacy parameter)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>level</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Power-of-2 downsampling level (factors = 2^level).
Takes precedence over along_* parameters</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spatial_dims</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of spatial dimensions. If None, derived
from axes_order</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with downsampled data and updated metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If conflicting parameters provided or invalid factors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Isotropic downsampling by factor of 2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">downsampled</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Anisotropic downsampling</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">downsampled</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using legacy parameters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">downsampled</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">along_x</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">along_y</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">along_z</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Power-of-2 downsampling</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">downsampled</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># factors = 4</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Downsampling uses block averaging for anti-aliasing</li>
<li>Spatial transformations are automatically scaled</li>
<li>Non-spatial dimensions (channels, time) are preserved</li>
<li>Original data remains unchanged (creates new instance)</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">downsample</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">factors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">along_x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">along_y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">along_z</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spatial_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reduce image resolution by downsampling.</span>

<span class="sd">    Performs spatial downsampling by averaging blocks of voxels, effectively</span>
<span class="sd">    reducing image resolution and size. Multiple parameter options provide</span>
<span class="sd">    flexibility for different downsampling strategies.</span>

<span class="sd">    Args:</span>
<span class="sd">        factors: Downsampling factors for spatial dimensions. Can be:</span>
<span class="sd">            - int: Same factor applied to all spatial dimensions</span>
<span class="sd">            - List[int]: Per-dimension factors matching spatial_dims order</span>
<span class="sd">            - None: Use other parameters to determine factors</span>
<span class="sd">        along_x: Downsampling factor for X dimension (legacy parameter)</span>
<span class="sd">        along_y: Downsampling factor for Y dimension (legacy parameter)</span>
<span class="sd">        along_z: Downsampling factor for Z dimension (legacy parameter)</span>
<span class="sd">        level: Power-of-2 downsampling level (factors = 2^level).</span>
<span class="sd">            Takes precedence over along_* parameters</span>
<span class="sd">        spatial_dims: Names of spatial dimensions. If None, derived</span>
<span class="sd">            from axes_order</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with downsampled data and updated metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If conflicting parameters provided or invalid factors</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Isotropic downsampling by factor of 2</span>
<span class="sd">        &gt;&gt;&gt; downsampled = znii.downsample(factors=2)</span>

<span class="sd">        &gt;&gt;&gt; # Anisotropic downsampling</span>
<span class="sd">        &gt;&gt;&gt; downsampled = znii.downsample(factors=[1, 2, 2])</span>

<span class="sd">        &gt;&gt;&gt; # Using legacy parameters</span>
<span class="sd">        &gt;&gt;&gt; downsampled = znii.downsample(along_x=2, along_y=2, along_z=1)</span>

<span class="sd">        &gt;&gt;&gt; # Power-of-2 downsampling</span>
<span class="sd">        &gt;&gt;&gt; downsampled = znii.downsample(level=2)  # factors = 4</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Downsampling uses block averaging for anti-aliasing</span>
<span class="sd">        - Spatial transformations are automatically scaled</span>
<span class="sd">        - Non-spatial dimensions (channels, time) are preserved</span>
<span class="sd">        - Original data remains unchanged (creates new instance)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle legacy parameters</span>
    <span class="k">if</span> <span class="n">factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">level</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">along_z</span><span class="p">,</span> <span class="n">along_y</span><span class="p">,</span> <span class="n">along_x</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span>
                <span class="k">else</span> <span class="p">[</span><span class="n">along_x</span><span class="p">,</span> <span class="n">along_y</span><span class="p">,</span> <span class="n">along_z</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">spatial_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">downsampled_image</span> <span class="o">=</span> <span class="n">downsample_ngff_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">factors</span><span class="p">,</span> <span class="n">spatial_dims</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">downsampled_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="upsample"><code>upsample</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.upsample"></a>
    <div class="doc doc-contents first">

        <p>Upsamples the ZarrNii instance using <code>scipy.ndimage.zoom</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>along_x</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upsampling factor along the X-axis (default: 1).</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_y</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upsampling factor along the Y-axis (default: 1).</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_z</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upsampling factor along the Z-axis (default: 1).</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>to_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target shape for upsampling. Should include all dimensions
                         (e.g., <code>(c, z, y, x)</code> for ZYX or <code>(c, x, y, z)</code> for XYZ).
                         If provided, <code>along_x</code>, <code>along_y</code>, and <code>along_z</code> are ignored.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>ZarrNii</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new ZarrNii instance with the upsampled data and updated affine.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>This method supports both direct scaling via <code>along_*</code> factors or target shape via <code>to_shape</code>.</li>
<li>If <code>to_shape</code> is provided, chunk sizes and scaling factors are dynamically calculated.</li>
<li>The affine matrix is updated to reflect the new voxel size after upsampling.</li>
</ul>
</details>

<details class="example" open>
  <summary>Example</summary>
  <h2 id="zarrnii.ZarrNii.upsample--upsample-with-scaling-factors">Upsample with scaling factors</h2>
<p>upsampled_znimg = znimg.upsample(along_x=2, along_y=2, along_z=2)</p>
<h2 id="zarrnii.ZarrNii.upsample--upsample-to-a-specific-shape">Upsample to a specific shape</h2>
<p>upsampled_znimg = znimg.upsample(to_shape=(1, 256, 256, 256))</p>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">upsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">along_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_z</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">to_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upsamples the ZarrNii instance using `scipy.ndimage.zoom`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        along_x (int, optional): Upsampling factor along the X-axis (default: 1).</span>
<span class="sd">        along_y (int, optional): Upsampling factor along the Y-axis (default: 1).</span>
<span class="sd">        along_z (int, optional): Upsampling factor along the Z-axis (default: 1).</span>
<span class="sd">        to_shape (tuple, optional): Target shape for upsampling. Should include all dimensions</span>
<span class="sd">                                     (e.g., `(c, z, y, x)` for ZYX or `(c, x, y, z)` for XYZ).</span>
<span class="sd">                                     If provided, `along_x`, `along_y`, and `along_z` are ignored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii: A new ZarrNii instance with the upsampled data and updated affine.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - This method supports both direct scaling via `along_*` factors or target shape via `to_shape`.</span>
<span class="sd">        - If `to_shape` is provided, chunk sizes and scaling factors are dynamically calculated.</span>
<span class="sd">        - The affine matrix is updated to reflect the new voxel size after upsampling.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Upsample with scaling factors</span>
<span class="sd">        upsampled_znimg = znimg.upsample(along_x=2, along_y=2, along_z=2)</span>

<span class="sd">        # Upsample to a specific shape</span>
<span class="sd">        upsampled_znimg = znimg.upsample(to_shape=(1, 256, 256, 256))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine scaling and chunks based on input parameters</span>
    <span class="k">if</span> <span class="n">to_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_x</span><span class="p">,</span> <span class="n">along_y</span><span class="p">,</span> <span class="n">along_z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_z</span><span class="p">,</span> <span class="n">along_y</span><span class="p">,</span> <span class="n">along_x</span><span class="p">)</span>

        <span class="n">chunks_out</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks_i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chunks_i</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span><span class="p">,</span> <span class="n">scaling</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunks_out</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_upsampled_chunks</span><span class="p">(</span><span class="n">to_shape</span><span class="p">)</span>

    <span class="c1"># Define block-wise upsampling function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zoom_blocks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">block_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scales blocks to the desired size using `scipy.ndimage.zoom`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x (np.ndarray): Input block data.</span>
<span class="sd">            block_info (dict, optional): Metadata about the current block.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The upscaled block.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate scaling factors based on input and output chunk shapes</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">out_n</span> <span class="o">/</span> <span class="n">in_n</span>
            <span class="k">for</span> <span class="n">out_n</span><span class="p">,</span> <span class="n">in_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">block_info</span><span class="p">[</span><span class="kc">None</span><span class="p">][</span><span class="s2">&quot;chunk-shape&quot;</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">zoom</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scaling</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prefilter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Perform block-wise upsampling</span>
    <span class="n">darr_scaled</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">zoom_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks_out</span>
    <span class="p">)</span>

    <span class="c1"># Update the affine matrix to reflect the new voxel size</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
        <span class="n">scaling_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scaling_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">new_affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">scaling_matrix</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

    <span class="c1"># Create new NgffImage with upsampled data</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
        <span class="n">new_scale</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_scale</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="n">upsampled_ngff</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">to_ngff_image</span><span class="p">(</span>
        <span class="n">darr_scaled</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">new_scale</span><span class="p">,</span>
        <span class="n">translation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Return a new ZarrNii instance with the upsampled data</span>
    <span class="k">return</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ngff_image</span><span class="p">(</span>
        <span class="n">upsampled_ngff</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="apply_transform"><code>apply_transform</code></h3>


<div class="doc doc-object doc-function">



<a id="zarrnii.ZarrNii.apply_transform"></a>
    <div class="doc doc-contents first">

        <p>Apply spatial transformations to image data.</p>
<p>Transforms the image data to align with a reference image space using
the provided transformation(s). This enables registration, resampling,
and coordinate system conversions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>*transforms</code>
            </td>
            <td>
                  <code><span title="zarrnii.transform.Transform">Transform</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Variable number of Transform objects to apply sequentially.
Supported transform types:
- AffineTransform: Linear transformations (rotation, scaling, translation)
- DisplacementTransform: Non-linear deformation fields</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ref_znimg</code>
            </td>
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference ZarrNii image defining the target coordinate system,
grid spacing, and field of view for the output</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spatial_dims</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of spatial dimensions for transformation. If None,
automatically derived from axes_order</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with transformed data in reference space</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no transforms provided or reference image incompatible</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If transforms are not valid Transform objects</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Apply affine transformation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_txt</span><span class="p">(</span><span class="s2">&quot;transform.txt&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transformed</span> <span class="o">=</span> <span class="n">moving</span><span class="o">.</span><span class="n">apply_transform</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Apply multiple transforms sequentially</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">warp</span> <span class="o">=</span> <span class="n">DisplacementTransform</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span><span class="s2">&quot;warp.nii.gz&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">moving</span><span class="o">.</span><span class="n">apply_transform</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">warp</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Transformations are applied in the order specified</li>
<li>Output data inherits spatial properties from ref_znimg</li>
<li>Uses interpolation for non-integer coordinate mappings</li>
<li>Non-spatial dimensions (channels, time) are preserved</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_transform</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="n">transforms</span><span class="p">:</span> <span class="n">Transform</span><span class="p">,</span>
    <span class="n">ref_znimg</span><span class="p">:</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">,</span>
    <span class="n">spatial_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply spatial transformations to image data.</span>

<span class="sd">    Transforms the image data to align with a reference image space using</span>
<span class="sd">    the provided transformation(s). This enables registration, resampling,</span>
<span class="sd">    and coordinate system conversions.</span>

<span class="sd">    Args:</span>
<span class="sd">        *transforms: Variable number of Transform objects to apply sequentially.</span>
<span class="sd">            Supported transform types:</span>
<span class="sd">            - AffineTransform: Linear transformations (rotation, scaling, translation)</span>
<span class="sd">            - DisplacementTransform: Non-linear deformation fields</span>
<span class="sd">        ref_znimg: Reference ZarrNii image defining the target coordinate system,</span>
<span class="sd">            grid spacing, and field of view for the output</span>
<span class="sd">        spatial_dims: Names of spatial dimensions for transformation. If None,</span>
<span class="sd">            automatically derived from axes_order</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with transformed data in reference space</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no transforms provided or reference image incompatible</span>
<span class="sd">        TypeError: If transforms are not valid Transform objects</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Apply affine transformation</span>
<span class="sd">        &gt;&gt;&gt; affine = AffineTransform.from_txt(&quot;transform.txt&quot;)</span>
<span class="sd">        &gt;&gt;&gt; transformed = moving.apply_transform(affine, ref_znimg=reference)</span>

<span class="sd">        &gt;&gt;&gt; # Apply multiple transforms sequentially</span>
<span class="sd">        &gt;&gt;&gt; affine = AffineTransform.identity()</span>
<span class="sd">        &gt;&gt;&gt; warp = DisplacementTransform.from_nifti(&quot;warp.nii.gz&quot;)</span>
<span class="sd">        &gt;&gt;&gt; result = moving.apply_transform(affine, warp, ref_znimg=reference)</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Transformations are applied in the order specified</span>
<span class="sd">        - Output data inherits spatial properties from ref_znimg</span>
<span class="sd">        - Uses interpolation for non-integer coordinate mappings</span>
<span class="sd">        - Non-spatial dimensions (channels, time) are preserved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spatial_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># For now, just apply the first transform (placeholder)</span>
    <span class="k">if</span> <span class="n">transforms</span><span class="p">:</span>
        <span class="n">transformed_image</span> <span class="o">=</span> <span class="n">apply_transform_to_ngff_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">transforms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ref_znimg</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">spatial_dims</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transformed_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span>

    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">transformed_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><hr />
<h2 id="remaining-methods-and-functions">Remaining Methods and Functions</h2>


<div class="doc doc-object doc-class">



<a id="zarrnii.ZarrNii"></a>
    <div class="doc doc-contents first">


        <p>Zarr-based image with NIfTI compatibility using NgffImage internally.</p>
<p>This class provides chainable operations on OME-Zarr data while maintaining
compatibility with NIfTI workflows. It uses NgffImage objects internally for
better multiscale support and metadata preservation.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="ngff_image

  
      instance-attribute
   (zarrnii.ZarrNii.ngff_image)" href="#zarrnii.ZarrNii.ngff_image">ngff_image</a></code></td>
            <td>
                  <code><span title="ngff_zarr.NgffImage">NgffImage</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The internal NgffImage object containing data and metadata.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="axes_order = 'ZYX'

  
      class-attribute
      instance-attribute
   (zarrnii.ZarrNii.axes_order)" href="#zarrnii.ZarrNii.axes_order">axes_order</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The order of the axes for NIfTI compatibility ('ZYX' or 'XYZ').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="xyz_orientation = 'RAS'

  
      class-attribute
      instance-attribute
   (zarrnii.ZarrNii.xyz_orientation)" href="#zarrnii.ZarrNii.xyz_orientation">xyz_orientation</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The anatomical orientation string in XYZ axes order (e.g., 'RAS', 'LPI').</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

        <p>Constructor with backward compatibility for old signature.</p>








                  <details class="quote">
                    <summary>Source code in <code>zarrnii/core.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">darr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">affine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;ZYX&quot;</span><span class="p">,</span>
    <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
    <span class="n">xyz_orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ngff_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_omero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructor with backward compatibility for old signature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle backwards compatibility: if xyz_orientation is provided, use it</span>
    <span class="c1"># Otherwise, use orientation for backwards compatibility</span>
    <span class="n">final_orientation</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">xyz_orientation</span> <span class="k">if</span> <span class="n">xyz_orientation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">orientation</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">ngff_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># New signature</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ngff_image&quot;</span><span class="p">,</span> <span class="n">ngff_image</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;axes_order&quot;</span><span class="p">,</span> <span class="n">axes_order</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xyz_orientation&quot;</span><span class="p">,</span> <span class="n">final_orientation</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_omero&quot;</span><span class="p">,</span> <span class="n">_omero</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">darr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Legacy signature - delegate to from_darr</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_darr</span><span class="p">(</span>
            <span class="n">darr</span><span class="o">=</span><span class="n">darr</span><span class="p">,</span>
            <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">,</span>
            <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">final_orientation</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ngff_image&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;axes_order&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">axes_order</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xyz_orientation&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_omero&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">_omero</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either ngff_image or darr&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii._omero" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_omero</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.affine" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">affine</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Affine transformation matrix derived from NgffImage scale and translation.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>AffineTransform</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="zarrnii.transform.AffineTransform" href="#zarrnii.transform.AffineTransform">AffineTransform</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>4x4 affine transformation matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.axes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">axes</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Axes metadata - derived from NgffImage for compatibility.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.axes_order" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">axes_order</span> <span class="o">=</span> <span class="s1">&#39;ZYX&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.coordinate_transformations" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">coordinate_transformations</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Coordinate transformations - derived from NgffImage scale/translation.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.darr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">darr</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Legacy property name for image data.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">data</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Access the image data (dask array).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.dims" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dims</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Dimension names.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">name</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Image name from NgffImage.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.ngff_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ngff_image</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.omero" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">omero</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Omero metadata object.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.orientation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">orientation</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Legacy property for backward compatibility.</p>
<p>Returns the xyz_orientation attribute to maintain backward compatibility
with code that expects the 'orientation' property.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The anatomical orientation string in XYZ axes order</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.scale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">scale</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Scale information from NgffImage.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.shape" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">shape</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Shape of the image data.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.translation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">translation</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Translation information from NgffImage.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.ZarrNii.xyz_orientation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">xyz_orientation</span> <span class="o">=</span> <span class="s1">&#39;RAS&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.__get_upsampled_chunks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__get_upsampled_chunks</span><span class="p">(</span><span class="n">target_shape</span><span class="p">,</span> <span class="n">return_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculates new chunk sizes for a dask array to match a target shape,
while ensuring the chunks sum precisely to the target shape. Optionally,
returns the scaling factors for each dimension.</p>
<p>This method is useful for upsampling data or ensuring 1:1 correspondence
between downsampled and upsampled arrays.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>target_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The desired shape of the array after upsampling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_scaling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to return the scaling factors
                             for each dimension (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>new_chunks (tuple): A tuple of tuples specifying the new chunk sizes
                    for each dimension.
scaling (list): A list of scaling factors for each dimension
                (only if <code>return_scaling=True</code>).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OR</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>new_chunks (tuple): A tuple of tuples specifying the new chunk sizes
                    for each dimension (if <code>return_scaling=False</code>).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>The scaling factor for each dimension is calculated as:
  <code>scaling_factor = target_shape[dim] / original_shape[dim]</code></li>
<li>The last chunk in each dimension is adjusted to account for rounding
  errors, ensuring the sum of chunks matches the target shape.</li>
</ul>
</details>

<details class="example" open>
  <summary>Example</summary>
  <h3 id="zarrnii.ZarrNii.__get_upsampled_chunks--calculate-upsampled-chunks-and-scaling-factors">Calculate upsampled chunks and scaling factors</h3>
<p>new_chunks, scaling = znimg.__get_upsampled_chunks((256, 256, 256))
print("New chunks:", new_chunks)
print("Scaling factors:", scaling)</p>
<h3 id="zarrnii.ZarrNii.__get_upsampled_chunks--calculate-only-the-new-chunks">Calculate only the new chunks</h3>
<p>new_chunks = znimg.__get_upsampled_chunks((256, 256, 256), return_scaling=False)</p>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__get_upsampled_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">return_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates new chunk sizes for a dask array to match a target shape,</span>
<span class="sd">    while ensuring the chunks sum precisely to the target shape. Optionally,</span>
<span class="sd">    returns the scaling factors for each dimension.</span>

<span class="sd">    This method is useful for upsampling data or ensuring 1:1 correspondence</span>
<span class="sd">    between downsampled and upsampled arrays.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        target_shape (tuple): The desired shape of the array after upsampling.</span>
<span class="sd">        return_scaling (bool, optional): Whether to return the scaling factors</span>
<span class="sd">                                         for each dimension (default: True).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            new_chunks (tuple): A tuple of tuples specifying the new chunk sizes</span>
<span class="sd">                                for each dimension.</span>
<span class="sd">            scaling (list): A list of scaling factors for each dimension</span>
<span class="sd">                            (only if `return_scaling=True`).</span>

<span class="sd">        OR</span>

<span class="sd">        tuple:</span>
<span class="sd">            new_chunks (tuple): A tuple of tuples specifying the new chunk sizes</span>
<span class="sd">                                for each dimension (if `return_scaling=False`).</span>

<span class="sd">    Notes:</span>
<span class="sd">        - The scaling factor for each dimension is calculated as:</span>
<span class="sd">          `scaling_factor = target_shape[dim] / original_shape[dim]`</span>
<span class="sd">        - The last chunk in each dimension is adjusted to account for rounding</span>
<span class="sd">          errors, ensuring the sum of chunks matches the target shape.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Calculate upsampled chunks and scaling factors</span>
<span class="sd">        new_chunks, scaling = znimg.__get_upsampled_chunks((256, 256, 256))</span>
<span class="sd">        print(&quot;New chunks:&quot;, new_chunks)</span>
<span class="sd">        print(&quot;Scaling factors:&quot;, scaling)</span>

<span class="sd">        # Calculate only the new chunks</span>
<span class="sd">        new_chunks = znimg.__get_upsampled_chunks((256, 256, 256), return_scaling=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scaling</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="p">(</span><span class="n">orig_shape</span><span class="p">,</span> <span class="n">orig_chunks</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="c1"># Calculate the scaling factor for this dimension</span>
        <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">new_shape</span> <span class="o">/</span> <span class="n">orig_shape</span>

        <span class="c1"># Scale each chunk size and round to get an initial estimate</span>
        <span class="n">scaled_chunks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">chunk</span> <span class="o">*</span> <span class="n">scaling_factor</span><span class="p">))</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">orig_chunks</span>
        <span class="p">]</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scaled_chunks</span><span class="p">)</span>

        <span class="c1"># Adjust the chunks to ensure they sum up to the target shape exactly</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">new_shape</span> <span class="o">-</span> <span class="n">total</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Correct rounding errors by adjusting the last chunk size in the dimension</span>
            <span class="n">scaled_chunks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diff</span>

        <span class="n">new_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scaled_chunks</span><span class="p">))</span>
        <span class="n">scaling</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaling_factor</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_scaling</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_chunks</span><span class="p">),</span> <span class="n">scaling</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_chunks</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>String representation.</p>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3661</span>
<span class="normal">3662</span>
<span class="normal">3663</span>
<span class="normal">3664</span>
<span class="normal">3665</span>
<span class="normal">3666</span>
<span class="normal">3667</span>
<span class="normal">3668</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;ZarrNii(name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;dims=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;scale=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii._create_zyx_ngff_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_create_zyx_ngff_image</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Create a new NgffImage with data reordered from XYZ to ZYX.</p>
<p>This is used when saving to OME-Zarr format which expects ZYX ordering.
The data array is transposed and scale/translation are reordered accordingly.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>NgffImage</code></td>            <td>
                  <code><span title="ngff_zarr.NgffImage">NgffImage</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New image with ZYX-ordered data and metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_create_zyx_ngff_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new NgffImage with data reordered from XYZ to ZYX.</span>

<span class="sd">    This is used when saving to OME-Zarr format which expects ZYX ordering.</span>
<span class="sd">    The data array is transposed and scale/translation are reordered accordingly.</span>

<span class="sd">    Returns:</span>
<span class="sd">        NgffImage: New image with ZYX-ordered data and metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">!=</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This method should only be called when axes_order is XYZ&quot;</span><span class="p">)</span>

    <span class="c1"># Transpose data from XYZ to ZYX (reverse the spatial dimensions)</span>
    <span class="c1"># Assuming data shape is [C, X, Y, Z] -&gt; [C, Z, Y, X]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Find spatial dimension indices</span>
    <span class="n">spatial_axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channel_axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]:</span>
            <span class="n">spatial_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channel_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Create transpose indices: reverse the spatial axes order</span>
    <span class="n">transpose_indices</span> <span class="o">=</span> <span class="n">channel_axes</span> <span class="o">+</span> <span class="n">spatial_axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">transposed_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">transpose_indices</span><span class="p">)</span>

    <span class="c1"># Create new dims list with ZYX ordering</span>
    <span class="n">new_dims</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]:</span>
            <span class="n">new_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>
    <span class="c1"># Add spatial dims in ZYX order</span>
    <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spatial_axes</span><span class="p">]</span>
    <span class="n">new_dims</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spatial_dim_names</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Reorder scale and translation from XYZ to ZYX</span>
    <span class="n">current_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span>
    <span class="n">current_translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">translation</span>

    <span class="n">new_scale</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">new_translation</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Copy non-spatial dimensions</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">current_scale</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]:</span>
            <span class="n">new_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">current_translation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]:</span>
            <span class="n">new_translation</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Reorder spatial dimensions from XYZ to ZYX</span>
    <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">current_scale</span> <span class="ow">and</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">current_scale</span> <span class="ow">and</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">current_scale</span><span class="p">:</span>
        <span class="n">new_scale</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_scale</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="n">new_scale</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_scale</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="n">new_scale</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_scale</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">current_translation</span>
        <span class="ow">and</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">current_translation</span>
        <span class="ow">and</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">current_translation</span>
    <span class="p">):</span>
        <span class="n">new_translation</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_translation</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="n">new_translation</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_translation</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="n">new_translation</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_translation</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>

    <span class="c1"># Create new NgffImage with ZYX ordering</span>
    <span class="n">zyx_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">transposed_data</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">new_dims</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">new_scale</span><span class="p">,</span>
        <span class="n">translation</span><span class="o">=</span><span class="n">new_translation</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">zyx_image</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.apply_scaled_processing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_scaled_processing</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">downsample_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upsampled_ome_zarr_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply scaled processing plugin using multi-resolution approach.</p>
<p>This method implements a multi-resolution processing pipeline where:
1. The image is downsampled for efficient computation
2. The plugin's lowres_func is applied to the downsampled data
3. The result is upsampled using dask-based upsampling
4. The plugin's highres_func applies the result to full-resolution data</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plugin</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ScaledProcessingPlugin instance or class to apply</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>downsample_factor</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Factor for downsampling (default: 4)</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_size</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional chunk size for low-res processing. If None, uses (1, 10, 10, 10).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>upsampled_ome_zarr_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save intermediate OME-Zarr, default saved in system temp directory.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the plugin</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with processed data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3588</span>
<span class="normal">3589</span>
<span class="normal">3590</span>
<span class="normal">3591</span>
<span class="normal">3592</span>
<span class="normal">3593</span>
<span class="normal">3594</span>
<span class="normal">3595</span>
<span class="normal">3596</span>
<span class="normal">3597</span>
<span class="normal">3598</span>
<span class="normal">3599</span>
<span class="normal">3600</span>
<span class="normal">3601</span>
<span class="normal">3602</span>
<span class="normal">3603</span>
<span class="normal">3604</span>
<span class="normal">3605</span>
<span class="normal">3606</span>
<span class="normal">3607</span>
<span class="normal">3608</span>
<span class="normal">3609</span>
<span class="normal">3610</span>
<span class="normal">3611</span>
<span class="normal">3612</span>
<span class="normal">3613</span>
<span class="normal">3614</span>
<span class="normal">3615</span>
<span class="normal">3616</span>
<span class="normal">3617</span>
<span class="normal">3618</span>
<span class="normal">3619</span>
<span class="normal">3620</span>
<span class="normal">3621</span>
<span class="normal">3622</span>
<span class="normal">3623</span>
<span class="normal">3624</span>
<span class="normal">3625</span>
<span class="normal">3626</span>
<span class="normal">3627</span>
<span class="normal">3628</span>
<span class="normal">3629</span>
<span class="normal">3630</span>
<span class="normal">3631</span>
<span class="normal">3632</span>
<span class="normal">3633</span>
<span class="normal">3634</span>
<span class="normal">3635</span>
<span class="normal">3636</span>
<span class="normal">3637</span>
<span class="normal">3638</span>
<span class="normal">3639</span>
<span class="normal">3640</span>
<span class="normal">3641</span>
<span class="normal">3642</span>
<span class="normal">3643</span>
<span class="normal">3644</span>
<span class="normal">3645</span>
<span class="normal">3646</span>
<span class="normal">3647</span>
<span class="normal">3648</span>
<span class="normal">3649</span>
<span class="normal">3650</span>
<span class="normal">3651</span>
<span class="normal">3652</span>
<span class="normal">3653</span>
<span class="normal">3654</span>
<span class="normal">3655</span>
<span class="normal">3656</span>
<span class="normal">3657</span>
<span class="normal">3658</span>
<span class="normal">3659</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_scaled_processing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">plugin</span><span class="p">,</span>
    <span class="n">downsample_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">upsampled_ome_zarr_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply scaled processing plugin using multi-resolution approach.</span>

<span class="sd">    This method implements a multi-resolution processing pipeline where:</span>
<span class="sd">    1. The image is downsampled for efficient computation</span>
<span class="sd">    2. The plugin&#39;s lowres_func is applied to the downsampled data</span>
<span class="sd">    3. The result is upsampled using dask-based upsampling</span>
<span class="sd">    4. The plugin&#39;s highres_func applies the result to full-resolution data</span>

<span class="sd">    Args:</span>
<span class="sd">        plugin: ScaledProcessingPlugin instance or class to apply</span>
<span class="sd">        downsample_factor: Factor for downsampling (default: 4)</span>
<span class="sd">        chunk_size: Optional chunk size for low-res processing. If None, uses (1, 10, 10, 10).</span>
<span class="sd">        upsampled_ome_zarr_path: Path to save intermediate OME-Zarr, default saved in system temp directory.</span>
<span class="sd">        **kwargs: Additional arguments passed to the plugin</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with processed data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.plugins.scaled_processing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScaledProcessingPlugin</span>

    <span class="c1"># Handle plugin instance or class</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">ScaledProcessingPlugin</span><span class="p">):</span>
        <span class="n">plugin</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">ScaledProcessingPlugin</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Plugin must be an instance or subclass of ScaledProcessingPlugin&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Step 1: Downsample the data for low-resolution processing</span>
    <span class="n">lowres_znimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">downsample_factor</span><span class="p">)))</span>

    <span class="c1"># Convert to numpy array for lowres processing</span>
    <span class="n">lowres_array</span> <span class="o">=</span> <span class="n">lowres_znimg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1"># Step 2: Apply low-resolution function and prepare for upsampling</span>
    <span class="c1"># Use chunk_size parameter for the low-res processing chunks</span>
    <span class="n">lowres_chunks</span> <span class="o">=</span> <span class="n">chunk_size</span> <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">lowres_znimg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span>
        <span class="n">plugin</span><span class="o">.</span><span class="n">lowres_func</span><span class="p">(</span><span class="n">lowres_array</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="n">lowres_chunks</span>
    <span class="p">)</span>

    <span class="c1"># Use temporary OME-Zarr to break up dask graph for performance</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>

    <span class="k">if</span> <span class="n">upsampled_ome_zarr_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">upsampled_ome_zarr_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_SPIM.ome.zarr&quot;</span><span class="p">)</span>

    <span class="c1"># Step 3: Upsample using dask-based upsampling, save to ome zarr</span>
    <span class="n">lowres_znimg</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span><span class="n">to_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to_ome_zarr</span><span class="p">(</span>
        <span class="n">upsampled_ome_zarr_path</span><span class="p">,</span> <span class="n">max_layer</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="n">upsampled_znimg</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ome_zarr</span><span class="p">(</span><span class="n">upsampled_ome_zarr_path</span><span class="p">)</span>

    <span class="n">corrected_znimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Step 4: Apply high-resolution function</span>
    <span class="c1"># rechunk original data to use same chunksize as upsampled_data, before multiplying</span>
    <span class="n">corrected_znimg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">highres_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">upsampled_znimg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span><span class="p">),</span> <span class="n">upsampled_znimg</span><span class="o">.</span><span class="n">data</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">corrected_znimg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.apply_transform" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_transform</span><span class="p">(</span><span class="o">*</span><span class="n">transforms</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="p">,</span> <span class="n">spatial_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply spatial transformations to image data.</p>
<p>Transforms the image data to align with a reference image space using
the provided transformation(s). This enables registration, resampling,
and coordinate system conversions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>*transforms</code>
            </td>
            <td>
                  <code><span title="zarrnii.transform.Transform">Transform</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Variable number of Transform objects to apply sequentially.
Supported transform types:
- AffineTransform: Linear transformations (rotation, scaling, translation)
- DisplacementTransform: Non-linear deformation fields</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ref_znimg</code>
            </td>
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference ZarrNii image defining the target coordinate system,
grid spacing, and field of view for the output</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spatial_dims</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of spatial dimensions for transformation. If None,
automatically derived from axes_order</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with transformed data in reference space</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no transforms provided or reference image incompatible</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If transforms are not valid Transform objects</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Apply affine transformation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_txt</span><span class="p">(</span><span class="s2">&quot;transform.txt&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transformed</span> <span class="o">=</span> <span class="n">moving</span><span class="o">.</span><span class="n">apply_transform</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Apply multiple transforms sequentially</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">warp</span> <span class="o">=</span> <span class="n">DisplacementTransform</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span><span class="s2">&quot;warp.nii.gz&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">moving</span><span class="o">.</span><span class="n">apply_transform</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">warp</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Transformations are applied in the order specified</li>
<li>Output data inherits spatial properties from ref_znimg</li>
<li>Uses interpolation for non-integer coordinate mappings</li>
<li>Non-spatial dimensions (channels, time) are preserved</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_transform</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="n">transforms</span><span class="p">:</span> <span class="n">Transform</span><span class="p">,</span>
    <span class="n">ref_znimg</span><span class="p">:</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">,</span>
    <span class="n">spatial_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply spatial transformations to image data.</span>

<span class="sd">    Transforms the image data to align with a reference image space using</span>
<span class="sd">    the provided transformation(s). This enables registration, resampling,</span>
<span class="sd">    and coordinate system conversions.</span>

<span class="sd">    Args:</span>
<span class="sd">        *transforms: Variable number of Transform objects to apply sequentially.</span>
<span class="sd">            Supported transform types:</span>
<span class="sd">            - AffineTransform: Linear transformations (rotation, scaling, translation)</span>
<span class="sd">            - DisplacementTransform: Non-linear deformation fields</span>
<span class="sd">        ref_znimg: Reference ZarrNii image defining the target coordinate system,</span>
<span class="sd">            grid spacing, and field of view for the output</span>
<span class="sd">        spatial_dims: Names of spatial dimensions for transformation. If None,</span>
<span class="sd">            automatically derived from axes_order</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with transformed data in reference space</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no transforms provided or reference image incompatible</span>
<span class="sd">        TypeError: If transforms are not valid Transform objects</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Apply affine transformation</span>
<span class="sd">        &gt;&gt;&gt; affine = AffineTransform.from_txt(&quot;transform.txt&quot;)</span>
<span class="sd">        &gt;&gt;&gt; transformed = moving.apply_transform(affine, ref_znimg=reference)</span>

<span class="sd">        &gt;&gt;&gt; # Apply multiple transforms sequentially</span>
<span class="sd">        &gt;&gt;&gt; affine = AffineTransform.identity()</span>
<span class="sd">        &gt;&gt;&gt; warp = DisplacementTransform.from_nifti(&quot;warp.nii.gz&quot;)</span>
<span class="sd">        &gt;&gt;&gt; result = moving.apply_transform(affine, warp, ref_znimg=reference)</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Transformations are applied in the order specified</span>
<span class="sd">        - Output data inherits spatial properties from ref_znimg</span>
<span class="sd">        - Uses interpolation for non-integer coordinate mappings</span>
<span class="sd">        - Non-spatial dimensions (channels, time) are preserved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spatial_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># For now, just apply the first transform (placeholder)</span>
    <span class="k">if</span> <span class="n">transforms</span><span class="p">:</span>
        <span class="n">transformed_image</span> <span class="o">=</span> <span class="n">apply_transform_to_ngff_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">transforms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ref_znimg</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">spatial_dims</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transformed_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span>

    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">transformed_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.apply_transform_flo_to_ref_indices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_transform_flo_to_ref_indices</span><span class="p">(</span><span class="o">*</span><span class="n">transforms</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Transform indices from floating to reference space.</p>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_transform_flo_to_ref_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">transforms</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform indices from floating to reference space.&quot;&quot;&quot;</span>
    <span class="c1"># Placeholder implementation - would need full transform logic</span>
    <span class="k">return</span> <span class="n">indices</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.apply_transform_ref_to_flo_indices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_transform_ref_to_flo_indices</span><span class="p">(</span><span class="o">*</span><span class="n">transforms</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Transform indices from reference to floating space.</p>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_transform_ref_to_flo_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">transforms</span><span class="p">,</span> <span class="n">ref_znimg</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform indices from reference to floating space.&quot;&quot;&quot;</span>
    <span class="c1"># Placeholder implementation - would need full transform logic</span>
    <span class="k">return</span> <span class="n">indices</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.compute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute the dask array and return the underlying NgffImage.</p>
<p>This triggers computation of any lazy operations and returns
the NgffImage with computed data.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ngff_zarr.NgffImage">NgffImage</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NgffImage with computed data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the dask array and return the underlying NgffImage.</span>

<span class="sd">    This triggers computation of any lazy operations and returns</span>
<span class="sd">    the NgffImage with computed data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        NgffImage with computed data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">computed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1"># Create new NgffImage with computed data</span>
    <span class="n">computed_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">computed_data</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">translation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">computed_image</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.compute_histogram" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute histogram of the image.</p>
<p>This method computes the histogram of image intensities, optionally using
a mask to weight the computation. The histogram is computed using dask for
efficient processing of large datasets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bins</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of histogram bins (default: 256)</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>range</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tuple (min, max) defining histogram range. If None,
uses the full range of the data</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[&#39;ZarrNii&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional ZarrNii mask of same shape as image. Only pixels
where mask &gt; 0 are included in histogram computation</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to dask.array.histogram</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dask.array.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (histogram_counts, bin_edges) where:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dask.array.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>histogram_counts: dask array of histogram bin counts</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="dask.array.Array">Array</span>, <span title="dask.array.Array">Array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>bin_edges: dask array of bin edge values (length = bins + 1)</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Compute histogram</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">compute_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Compute histogram with mask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mask</span> <span class="o">=</span> <span class="n">znimg</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hist_masked</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">compute_histogram</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3501</span>
<span class="normal">3502</span>
<span class="normal">3503</span>
<span class="normal">3504</span>
<span class="normal">3505</span>
<span class="normal">3506</span>
<span class="normal">3507</span>
<span class="normal">3508</span>
<span class="normal">3509</span>
<span class="normal">3510</span>
<span class="normal">3511</span>
<span class="normal">3512</span>
<span class="normal">3513</span>
<span class="normal">3514</span>
<span class="normal">3515</span>
<span class="normal">3516</span>
<span class="normal">3517</span>
<span class="normal">3518</span>
<span class="normal">3519</span>
<span class="normal">3520</span>
<span class="normal">3521</span>
<span class="normal">3522</span>
<span class="normal">3523</span>
<span class="normal">3524</span>
<span class="normal">3525</span>
<span class="normal">3526</span>
<span class="normal">3527</span>
<span class="normal">3528</span>
<span class="normal">3529</span>
<span class="normal">3530</span>
<span class="normal">3531</span>
<span class="normal">3532</span>
<span class="normal">3533</span>
<span class="normal">3534</span>
<span class="normal">3535</span>
<span class="normal">3536</span>
<span class="normal">3537</span>
<span class="normal">3538</span>
<span class="normal">3539</span>
<span class="normal">3540</span>
<span class="normal">3541</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_histogram</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="nb">range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ZarrNii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute histogram of the image.</span>

<span class="sd">    This method computes the histogram of image intensities, optionally using</span>
<span class="sd">    a mask to weight the computation. The histogram is computed using dask for</span>
<span class="sd">    efficient processing of large datasets.</span>

<span class="sd">    Args:</span>
<span class="sd">        bins: Number of histogram bins (default: 256)</span>
<span class="sd">        range: Optional tuple (min, max) defining histogram range. If None,</span>
<span class="sd">            uses the full range of the data</span>
<span class="sd">        mask: Optional ZarrNii mask of same shape as image. Only pixels</span>
<span class="sd">            where mask &gt; 0 are included in histogram computation</span>
<span class="sd">        **kwargs: Additional arguments passed to dask.array.histogram</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (histogram_counts, bin_edges) where:</span>
<span class="sd">        - histogram_counts: dask array of histogram bin counts</span>
<span class="sd">        - bin_edges: dask array of bin edge values (length = bins + 1)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Compute histogram</span>
<span class="sd">        &gt;&gt;&gt; hist, bin_edges = znimg.compute_histogram(bins=128)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Compute histogram with mask</span>
<span class="sd">        &gt;&gt;&gt; mask = znimg &gt; 0.5</span>
<span class="sd">        &gt;&gt;&gt; hist_masked, _ = znimg.compute_histogram(mask=mask)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_histogram</span>

    <span class="n">mask_data</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">darr</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">compute_histogram</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.compute_otsu_thresholds" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_otsu_thresholds</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute Otsu multi-level thresholds for the image.</p>
<p>This method first computes the histogram of the image, then uses
scikit-image's threshold_multiotsu to compute optimal threshold values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>classes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of classes to separate data into (default: 2).
Must be &gt;= 2. For classes=2, returns 1 threshold. For classes=k,
returns k-1 thresholds.</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bins</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of histogram bins (default: 256)</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>range</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tuple (min, max) defining histogram range. If None,
uses the full range of the data</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[&#39;ZarrNii&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional ZarrNii mask of same shape as image. Only pixels
where mask &gt; 0 are included in histogram computation</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of threshold values. For classes=k, returns k+1 values:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>[0, threshold1, threshold2, ..., threshold_k-1, max_intensity]</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>where 0 represents the minimum and max_intensity represents the maximum.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Compute binary threshold (2 classes)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">compute_otsu_thresholds</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binary thresholds: </span><span class="si">{</span><span class="n">thresholds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Compute multi-level thresholds (3 classes)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">compute_otsu_thresholds</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multi-level thresholds: </span><span class="si">{</span><span class="n">thresholds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3543</span>
<span class="normal">3544</span>
<span class="normal">3545</span>
<span class="normal">3546</span>
<span class="normal">3547</span>
<span class="normal">3548</span>
<span class="normal">3549</span>
<span class="normal">3550</span>
<span class="normal">3551</span>
<span class="normal">3552</span>
<span class="normal">3553</span>
<span class="normal">3554</span>
<span class="normal">3555</span>
<span class="normal">3556</span>
<span class="normal">3557</span>
<span class="normal">3558</span>
<span class="normal">3559</span>
<span class="normal">3560</span>
<span class="normal">3561</span>
<span class="normal">3562</span>
<span class="normal">3563</span>
<span class="normal">3564</span>
<span class="normal">3565</span>
<span class="normal">3566</span>
<span class="normal">3567</span>
<span class="normal">3568</span>
<span class="normal">3569</span>
<span class="normal">3570</span>
<span class="normal">3571</span>
<span class="normal">3572</span>
<span class="normal">3573</span>
<span class="normal">3574</span>
<span class="normal">3575</span>
<span class="normal">3576</span>
<span class="normal">3577</span>
<span class="normal">3578</span>
<span class="normal">3579</span>
<span class="normal">3580</span>
<span class="normal">3581</span>
<span class="normal">3582</span>
<span class="normal">3583</span>
<span class="normal">3584</span>
<span class="normal">3585</span>
<span class="normal">3586</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_otsu_thresholds</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="nb">range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ZarrNii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Otsu multi-level thresholds for the image.</span>

<span class="sd">    This method first computes the histogram of the image, then uses</span>
<span class="sd">    scikit-image&#39;s threshold_multiotsu to compute optimal threshold values.</span>

<span class="sd">    Args:</span>
<span class="sd">        classes: Number of classes to separate data into (default: 2).</span>
<span class="sd">            Must be &gt;= 2. For classes=2, returns 1 threshold. For classes=k,</span>
<span class="sd">            returns k-1 thresholds.</span>
<span class="sd">        bins: Number of histogram bins (default: 256)</span>
<span class="sd">        range: Optional tuple (min, max) defining histogram range. If None,</span>
<span class="sd">            uses the full range of the data</span>
<span class="sd">        mask: Optional ZarrNii mask of same shape as image. Only pixels</span>
<span class="sd">            where mask &gt; 0 are included in histogram computation</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of threshold values. For classes=k, returns k+1 values:</span>
<span class="sd">        [0, threshold1, threshold2, ..., threshold_k-1, max_intensity]</span>
<span class="sd">        where 0 represents the minimum and max_intensity represents the maximum.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Compute binary threshold (2 classes)</span>
<span class="sd">        &gt;&gt;&gt; thresholds = znimg.compute_otsu_thresholds(classes=2)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Binary thresholds: {thresholds}&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Compute multi-level thresholds (3 classes)</span>
<span class="sd">        &gt;&gt;&gt; thresholds = znimg.compute_otsu_thresholds(classes=3)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Multi-level thresholds: {thresholds}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_otsu_thresholds</span>

    <span class="c1"># First compute histogram</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Then compute thresholds</span>
    <span class="k">return</span> <span class="n">compute_otsu_thresholds</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.copy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">copy</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Create a copy of this ZarrNii.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii with copied data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a copy of this ZarrNii.</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii with copied data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a new NgffImage with the same properties</span>
    <span class="n">copied_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>  <span class="c1"># Dask arrays are lazy so this is efficient</span>
        <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">translation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">copied_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.crop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">crop</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">,</span> <span class="n">bbox_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spatial_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">physical_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Extract a spatial region or multiple regions from the image.</p>
<p>Crops the image to the specified bounding box coordinates, preserving
all metadata and non-spatial dimensions (channels, time). The cropping
is performed in voxel coordinates by default, or physical coordinates
if specified. Can crop a single region or multiple regions at once.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bbox_min</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, ...], <span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, ...], <span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, ...]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either:
- Minimum corner coordinates of bounding box as tuple
  (when bbox_max is provided). Length should match number of
  spatial dimensions (x, y, z order)
- List of (bbox_min, bbox_max) tuples for batch cropping
  (when bbox_max is None)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox_max</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum corner coordinates of bounding box as tuple.
Length should match number of spatial dimensions (x, y, z order).
Should be None when bbox_min is a list of bounding boxes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spatial_dims</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of spatial dimensions to crop. If None,
automatically derived from axes_order ("z","y","x" for ZYX
or "x","y","z" for XYZ)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>physical_coords</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, bbox_min and bbox_max are in physical/world
coordinates (mm). If False, they are in voxel coordinates.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[&#39;ZarrNii&#39;, <span title="typing.List">List</span>[&#39;ZarrNii&#39;]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with cropped data (single crop) or list of</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[&#39;ZarrNii&#39;, <span title="typing.List">List</span>[&#39;ZarrNii&#39;]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instances (batch crop) with updated spatial metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If bbox coordinates are invalid or out of bounds, or
if both list and bbox_max are provided</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="IndexError">IndexError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If bbox dimensions don't match spatial dimensions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Crop 3D region (voxel coordinates)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cropped</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">130</span><span class="p">))</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Crop with physical coordinates</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cropped</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="mf">10.5</span><span class="p">,</span> <span class="mf">20.5</span><span class="p">,</span> <span class="mf">30.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">110.5</span><span class="p">,</span> <span class="mf">120.5</span><span class="p">,</span> <span class="mf">130.5</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="n">physical_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Crop with explicit spatial dimensions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cropped</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">170</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">spatial_dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Batch crop multiple regions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">)),</span>
<span class="gp">... </span>    <span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">170</span><span class="p">))</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cropped_list</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">physical_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Coordinates are in voxel space (0-based indexing) by default</li>
<li>Physical coordinates are in RAS orientation (Right-Anterior-Superior)</li>
<li>The cropped region includes bbox_min but excludes bbox_max</li>
<li>All non-spatial dimensions (channels, time) are preserved</li>
<li>Spatial transformations are automatically updated</li>
<li>When batch cropping, all patches share the same spatial_dims and
  physical_coords settings</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">bbox_min</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span>
    <span class="p">],</span>
    <span class="n">bbox_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spatial_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">physical_coords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;ZarrNii&quot;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;ZarrNii&quot;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract a spatial region or multiple regions from the image.</span>

<span class="sd">    Crops the image to the specified bounding box coordinates, preserving</span>
<span class="sd">    all metadata and non-spatial dimensions (channels, time). The cropping</span>
<span class="sd">    is performed in voxel coordinates by default, or physical coordinates</span>
<span class="sd">    if specified. Can crop a single region or multiple regions at once.</span>

<span class="sd">    Args:</span>
<span class="sd">        bbox_min: Either:</span>
<span class="sd">            - Minimum corner coordinates of bounding box as tuple</span>
<span class="sd">              (when bbox_max is provided). Length should match number of</span>
<span class="sd">              spatial dimensions (x, y, z order)</span>
<span class="sd">            - List of (bbox_min, bbox_max) tuples for batch cropping</span>
<span class="sd">              (when bbox_max is None)</span>
<span class="sd">        bbox_max: Maximum corner coordinates of bounding box as tuple.</span>
<span class="sd">            Length should match number of spatial dimensions (x, y, z order).</span>
<span class="sd">            Should be None when bbox_min is a list of bounding boxes.</span>
<span class="sd">        spatial_dims: Names of spatial dimensions to crop. If None,</span>
<span class="sd">            automatically derived from axes_order (&quot;z&quot;,&quot;y&quot;,&quot;x&quot; for ZYX</span>
<span class="sd">            or &quot;x&quot;,&quot;y&quot;,&quot;z&quot; for XYZ)</span>
<span class="sd">        physical_coords: If True, bbox_min and bbox_max are in physical/world</span>
<span class="sd">            coordinates (mm). If False, they are in voxel coordinates.</span>
<span class="sd">            Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with cropped data (single crop) or list of</span>
<span class="sd">        ZarrNii instances (batch crop) with updated spatial metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If bbox coordinates are invalid or out of bounds, or</span>
<span class="sd">            if both list and bbox_max are provided</span>
<span class="sd">        IndexError: If bbox dimensions don&#39;t match spatial dimensions</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Crop 3D region (voxel coordinates)</span>
<span class="sd">        &gt;&gt;&gt; cropped = znii.crop((10, 20, 30), (110, 120, 130))</span>

<span class="sd">        &gt;&gt;&gt; # Crop with physical coordinates</span>
<span class="sd">        &gt;&gt;&gt; cropped = znii.crop((10.5, 20.5, 30.5), (110.5, 120.5, 130.5),</span>
<span class="sd">        ...                      physical_coords=True)</span>

<span class="sd">        &gt;&gt;&gt; # Crop with explicit spatial dimensions</span>
<span class="sd">        &gt;&gt;&gt; cropped = znii.crop(</span>
<span class="sd">        ...     (50, 60, 70), (150, 160, 170),</span>
<span class="sd">        ...     spatial_dims=[&quot;x&quot;, &quot;y&quot;, &quot;z&quot;]</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Batch crop multiple regions</span>
<span class="sd">        &gt;&gt;&gt; bboxes = [</span>
<span class="sd">        ...     ((10, 20, 30), (60, 70, 80)),</span>
<span class="sd">        ...     ((100, 110, 120), (150, 160, 170))</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; cropped_list = znii.crop(bboxes, physical_coords=True)</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Coordinates are in voxel space (0-based indexing) by default</span>
<span class="sd">        - Physical coordinates are in RAS orientation (Right-Anterior-Superior)</span>
<span class="sd">        - The cropped region includes bbox_min but excludes bbox_max</span>
<span class="sd">        - All non-spatial dimensions (channels, time) are preserved</span>
<span class="sd">        - Spatial transformations are automatically updated</span>
<span class="sd">        - When batch cropping, all patches share the same spatial_dims and</span>
<span class="sd">          physical_coords settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if this is batch cropping (list of bounding boxes)</span>
    <span class="c1"># A batch crop is a list of (bbox_min, bbox_max) tuples</span>
    <span class="c1"># Each element should be a tuple/list of two elements</span>
    <span class="n">is_batch_crop</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_batch_crop</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bbox_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;bbox_max should be None when bbox_min is a list of bounding boxes&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Batch crop: recursively call crop for each bounding box</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span> <span class="n">bmax</span><span class="p">,</span> <span class="n">spatial_dims</span><span class="p">,</span> <span class="n">physical_coords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bmax</span> <span class="ow">in</span> <span class="n">bbox_min</span>
        <span class="p">]</span>

    <span class="c1"># Single crop: original implementation</span>
    <span class="k">if</span> <span class="n">bbox_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bbox_max is required when bbox_min is not a list&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spatial_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Convert physical coordinates to voxel coordinates if needed</span>
    <span class="k">if</span> <span class="n">physical_coords</span><span class="p">:</span>
        <span class="c1"># Physical coords are always in (x, y, z) order</span>
        <span class="c1"># Convert to homogeneous coordinates</span>
        <span class="n">phys_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>
        <span class="n">phys_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bbox_max</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>

        <span class="c1"># Get inverse affine to convert from physical to voxel</span>
        <span class="n">affine_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

        <span class="c1"># Transform to voxel coordinates</span>
        <span class="n">voxel_min</span> <span class="o">=</span> <span class="n">affine_inv</span> <span class="o">@</span> <span class="n">phys_min</span>
        <span class="n">voxel_max</span> <span class="o">=</span> <span class="n">affine_inv</span> <span class="o">@</span> <span class="n">phys_max</span>

        <span class="c1"># Extract voxel coordinates (x, y, z)</span>
        <span class="n">voxel_min_xyz</span> <span class="o">=</span> <span class="n">voxel_min</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">voxel_max_xyz</span> <span class="o">=</span> <span class="n">voxel_max</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Round to nearest integer voxel indices</span>
        <span class="n">voxel_min_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">voxel_min_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">voxel_max_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">voxel_max_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Ensure max &gt;= min</span>
        <span class="n">voxel_min_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">voxel_min_xyz</span><span class="p">,</span> <span class="n">voxel_max_xyz</span><span class="p">)</span>
        <span class="n">voxel_max_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">affine_inv</span> <span class="o">@</span> <span class="n">phys_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">affine_inv</span> <span class="o">@</span> <span class="n">phys_max</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Create mapping from x,y,z to voxel coordinates</span>
        <span class="n">xyz_to_voxel</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">voxel_min_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">voxel_min_xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">voxel_min_xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">xyz_to_voxel_max</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">voxel_max_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">voxel_max_xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">voxel_max_xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Reorder according to spatial_dims</span>
        <span class="n">bbox_min</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xyz_to_voxel</span><span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">spatial_dims</span><span class="p">)</span>
        <span class="n">bbox_max</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xyz_to_voxel_max</span><span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">spatial_dims</span><span class="p">)</span>

    <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">crop_ngff_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">bbox_min</span><span class="p">,</span> <span class="n">bbox_max</span><span class="p">,</span> <span class="n">spatial_dims</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">cropped_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.crop_with_bounding_box" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">crop_with_bounding_box</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">,</span> <span class="n">bbox_max</span><span class="p">,</span> <span class="n">ras_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Legacy method name for crop.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bbox_min</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum corner coordinates</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox_max</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum corner coordinates</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ras_coords</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, coordinates are in RAS physical space (deprecated,
use physical_coords parameter of crop() instead)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">crop_with_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox_min</span><span class="p">,</span> <span class="n">bbox_max</span><span class="p">,</span> <span class="n">ras_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Legacy method name for crop.</span>

<span class="sd">    Args:</span>
<span class="sd">        bbox_min: Minimum corner coordinates</span>
<span class="sd">        bbox_max: Maximum corner coordinates</span>
<span class="sd">        ras_coords: If True, coordinates are in RAS physical space (deprecated,</span>
<span class="sd">            use physical_coords parameter of crop() instead)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bbox_min</span><span class="p">,</span> <span class="n">bbox_max</span><span class="p">,</span> <span class="n">physical_coords</span><span class="o">=</span><span class="n">ras_coords</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.downsample" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">downsample</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">along_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_z</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spatial_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Reduce image resolution by downsampling.</p>
<p>Performs spatial downsampling by averaging blocks of voxels, effectively
reducing image resolution and size. Multiple parameter options provide
flexibility for different downsampling strategies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>factors</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="typing.List">List</span>[<span title="int">int</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Downsampling factors for spatial dimensions. Can be:
- int: Same factor applied to all spatial dimensions
- List[int]: Per-dimension factors matching spatial_dims order
- None: Use other parameters to determine factors</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_x</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Downsampling factor for X dimension (legacy parameter)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_y</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Downsampling factor for Y dimension (legacy parameter)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_z</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Downsampling factor for Z dimension (legacy parameter)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>level</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Power-of-2 downsampling level (factors = 2^level).
Takes precedence over along_* parameters</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spatial_dims</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of spatial dimensions. If None, derived
from axes_order</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with downsampled data and updated metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If conflicting parameters provided or invalid factors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Isotropic downsampling by factor of 2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">downsampled</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Anisotropic downsampling</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">downsampled</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Using legacy parameters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">downsampled</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">along_x</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">along_y</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">along_z</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Power-of-2 downsampling</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">downsampled</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># factors = 4</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Downsampling uses block averaging for anti-aliasing</li>
<li>Spatial transformations are automatically scaled</li>
<li>Non-spatial dimensions (channels, time) are preserved</li>
<li>Original data remains unchanged (creates new instance)</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">downsample</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">factors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">along_x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">along_y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">along_z</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spatial_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reduce image resolution by downsampling.</span>

<span class="sd">    Performs spatial downsampling by averaging blocks of voxels, effectively</span>
<span class="sd">    reducing image resolution and size. Multiple parameter options provide</span>
<span class="sd">    flexibility for different downsampling strategies.</span>

<span class="sd">    Args:</span>
<span class="sd">        factors: Downsampling factors for spatial dimensions. Can be:</span>
<span class="sd">            - int: Same factor applied to all spatial dimensions</span>
<span class="sd">            - List[int]: Per-dimension factors matching spatial_dims order</span>
<span class="sd">            - None: Use other parameters to determine factors</span>
<span class="sd">        along_x: Downsampling factor for X dimension (legacy parameter)</span>
<span class="sd">        along_y: Downsampling factor for Y dimension (legacy parameter)</span>
<span class="sd">        along_z: Downsampling factor for Z dimension (legacy parameter)</span>
<span class="sd">        level: Power-of-2 downsampling level (factors = 2^level).</span>
<span class="sd">            Takes precedence over along_* parameters</span>
<span class="sd">        spatial_dims: Names of spatial dimensions. If None, derived</span>
<span class="sd">            from axes_order</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with downsampled data and updated metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If conflicting parameters provided or invalid factors</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Isotropic downsampling by factor of 2</span>
<span class="sd">        &gt;&gt;&gt; downsampled = znii.downsample(factors=2)</span>

<span class="sd">        &gt;&gt;&gt; # Anisotropic downsampling</span>
<span class="sd">        &gt;&gt;&gt; downsampled = znii.downsample(factors=[1, 2, 2])</span>

<span class="sd">        &gt;&gt;&gt; # Using legacy parameters</span>
<span class="sd">        &gt;&gt;&gt; downsampled = znii.downsample(along_x=2, along_y=2, along_z=1)</span>

<span class="sd">        &gt;&gt;&gt; # Power-of-2 downsampling</span>
<span class="sd">        &gt;&gt;&gt; downsampled = znii.downsample(level=2)  # factors = 4</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Downsampling uses block averaging for anti-aliasing</span>
<span class="sd">        - Spatial transformations are automatically scaled</span>
<span class="sd">        - Non-spatial dimensions (channels, time) are preserved</span>
<span class="sd">        - Original data remains unchanged (creates new instance)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle legacy parameters</span>
    <span class="k">if</span> <span class="n">factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">level</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">along_z</span><span class="p">,</span> <span class="n">along_y</span><span class="p">,</span> <span class="n">along_x</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span>
                <span class="k">else</span> <span class="p">[</span><span class="n">along_x</span><span class="p">,</span> <span class="n">along_y</span><span class="p">,</span> <span class="n">along_z</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">spatial_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">downsampled_image</span> <span class="o">=</span> <span class="n">downsample_ngff_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">factors</span><span class="p">,</span> <span class="n">spatial_dims</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">downsampled_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.from_darr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_darr</span><span class="p">(</span><span class="n">darr</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="s1">&#39;ZYX&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;RAS&#39;</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">omero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Create ZarrNii from dask array (legacy compatibility constructor).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>darr</code>
            </td>
            <td>
                  <code><span title="dask.array.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dask array containing image data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>affine</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="zarrnii.transform.AffineTransform" href="#zarrnii.transform.AffineTransform">AffineTransform</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional affine transformation</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axes order</p>
              </div>
            </td>
            <td>
                  <code>&#39;ZYX&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orientation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Anatomical orientation string</p>
              </div>
            </td>
            <td>
                  <code>&#39;RAS&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spacing</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Voxel spacing (used if no affine provided)</p>
              </div>
            </td>
            <td>
                  <code>(1.0, 1.0, 1.0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>origin</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Origin offset (used if no affine provided)</p>
              </div>
            </td>
            <td>
                  <code>(0.0, 0.0, 0.0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Image name</p>
              </div>
            </td>
            <td>
                  <code>&#39;image&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>omero</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="object">object</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional omero metadata</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_darr</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">darr</span><span class="p">:</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">affine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AffineTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
    <span class="n">spacing</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">origin</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span>
    <span class="n">omero</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create ZarrNii from dask array (legacy compatibility constructor).</span>

<span class="sd">    Args:</span>
<span class="sd">        darr: Dask array containing image data</span>
<span class="sd">        affine: Optional affine transformation</span>
<span class="sd">        axes_order: Spatial axes order</span>
<span class="sd">        orientation: Anatomical orientation string</span>
<span class="sd">        spacing: Voxel spacing (used if no affine provided)</span>
<span class="sd">        origin: Origin offset (used if no affine provided)</span>
<span class="sd">        name: Image name</span>
<span class="sd">        omero: Optional omero metadata</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create scale and translation from affine if provided</span>
    <span class="k">if</span> <span class="n">affine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Extract scale and translation from affine matrix</span>
        <span class="n">affine_matrix</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">matrix</span>
        <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># XYZ</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use spacing and origin</span>
        <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># XYZ</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>

    <span class="c1"># Create dimensions based on data shape after dimension adjustments</span>
    <span class="n">final_ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final_ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># 4D: (c, z, y, x) or (c, x, y, z) - standard case</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">final_ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># 5D: (t, c, z, y, x) or (t, c, x, y, z) - time dimension included</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback for other cases</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="c1"># Create NgffImage</span>
    <span class="n">ngff_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">darr</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="n">omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.from_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.nii&quot;</span><span class="p">,</span> <span class="s2">&quot;.nii.gz&quot;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zarr&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_ome_zarr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown file extension: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.from_imaris" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_imaris</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timepoint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="s1">&#39;ZYX&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;RAS&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Load from Imaris (.ims) file format.</p>
<p>Imaris files use HDF5 format with specific dataset structure.
This method requires the 'imaris' extra dependency (h5py).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to Imaris (.ims) file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>level</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution level to load (0 = full resolution)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timepoint</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time point to load (default: 0)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Channel to load (default: 0)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chunking strategy for dask array</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axes order for compatibility (default: "ZYX")</p>
              </div>
            </td>
            <td>
                  <code>&#39;ZYX&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orientation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default orientation (default: "RAS")</p>
              </div>
            </td>
            <td>
                  <code>&#39;RAS&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If h5py is not available</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the file is not a valid Imaris file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_imaris</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">timepoint</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">channel</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load from Imaris (.ims) file format.</span>

<span class="sd">    Imaris files use HDF5 format with specific dataset structure.</span>
<span class="sd">    This method requires the &#39;imaris&#39; extra dependency (h5py).</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path to Imaris (.ims) file</span>
<span class="sd">        level: Resolution level to load (0 = full resolution)</span>
<span class="sd">        timepoint: Time point to load (default: 0)</span>
<span class="sd">        channel: Channel to load (default: 0)</span>
<span class="sd">        chunks: Chunking strategy for dask array</span>
<span class="sd">        axes_order: Spatial axes order for compatibility (default: &quot;ZYX&quot;)</span>
<span class="sd">        orientation: Default orientation (default: &quot;RAS&quot;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii instance</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If h5py is not available</span>
<span class="sd">        ValueError: If the file is not a valid Imaris file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;h5py is required for Imaris support. &quot;</span>
            <span class="s2">&quot;Install with: pip install zarrnii[imaris] or pip install h5py&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Open Imaris file</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Verify it&#39;s an Imaris file by checking for standard structure</span>
        <span class="k">if</span> <span class="s2">&quot;DataSet&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not appear to be a valid Imaris file (missing DataSet group)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Navigate to the specific dataset</span>
        <span class="n">dataset_group</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;DataSet&quot;</span><span class="p">]</span>

        <span class="c1"># Find available resolution levels</span>
        <span class="n">resolution_levels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dataset_group</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ResolutionLevel&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resolution_levels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No resolution levels found in Imaris file&quot;</span><span class="p">)</span>

        <span class="c1"># Validate level parameter</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolution_levels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> not available. Available levels: 0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">resolution_levels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Navigate to specified resolution level</span>
        <span class="n">res_level_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ResolutionLevel </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">res_level_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolution level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">res_group</span> <span class="o">=</span> <span class="n">dataset_group</span><span class="p">[</span><span class="n">res_level_key</span><span class="p">]</span>

        <span class="c1"># Find available timepoints</span>
        <span class="n">timepoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">res_group</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TimePoint&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timepoints</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No timepoints found in Imaris file&quot;</span><span class="p">)</span>

        <span class="c1"># Validate timepoint parameter</span>
        <span class="k">if</span> <span class="n">timepoint</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timepoints</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Timepoint </span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2"> not available. Available timepoints: 0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timepoints</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Navigate to specified timepoint</span>
        <span class="n">time_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TimePoint </span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">time_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timepoint </span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">time_group</span> <span class="o">=</span> <span class="n">res_group</span><span class="p">[</span><span class="n">time_key</span><span class="p">]</span>

        <span class="c1"># Find available channels</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">time_group</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Channel&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No channels found in Imaris file&quot;</span><span class="p">)</span>

        <span class="c1"># Validate channel parameter</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> not available. Available channels: 0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Navigate to specified channel</span>
        <span class="n">channel_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">channel_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">time_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">channel_group</span> <span class="o">=</span> <span class="n">time_group</span><span class="p">[</span><span class="n">channel_key</span><span class="p">]</span>

        <span class="c1"># Load the actual data</span>
        <span class="k">if</span> <span class="s2">&quot;Data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channel_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No Data dataset found in channel group&quot;</span><span class="p">)</span>

        <span class="n">data_dataset</span> <span class="o">=</span> <span class="n">channel_group</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">]</span>

        <span class="c1"># Load data into memory first (necessary because HDF5 file will be closed)</span>
        <span class="n">data_numpy</span> <span class="o">=</span> <span class="n">data_dataset</span><span class="p">[:]</span>

        <span class="c1"># Create dask array from numpy array</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">data_numpy</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>

        <span class="c1"># Add channel dimension if not present</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

        <span class="c1"># Extract spatial metadata</span>
        <span class="c1"># Try to get spacing information from Imaris metadata</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>  <span class="c1"># Default spacing</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>  <span class="c1"># Default origin</span>

        <span class="c1"># Look for ImageSizeX, ImageSizeY, ImageSizeZ attributes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Navigate back to get image info</span>
            <span class="k">if</span> <span class="s2">&quot;ImageSizeX&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">x_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeX&quot;</span><span class="p">]</span>
                <span class="n">y_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeY&quot;</span><span class="p">]</span>
                <span class="n">z_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeZ&quot;</span><span class="p">]</span>

                <span class="c1"># Calculate spacing based on physical size and voxel count</span>
                <span class="k">if</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># X dimension</span>
                    <span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_size</span> <span class="o">/</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Y dimension</span>
                    <span class="n">spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_size</span> <span class="o">/</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Z dimension</span>
                    <span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_size</span> <span class="o">/</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="c1"># Use default spacing if metadata is not available</span>
            <span class="k">pass</span>

        <span class="c1"># Create dimensions</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="c1"># Create scale and translation dictionaries</span>
        <span class="n">scale_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">translation_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spatial_dims</span><span class="p">):</span>
            <span class="n">scale_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">translation_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Create NgffImage</span>
        <span class="n">ngff_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data_array</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale_dict</span><span class="p">,</span>
            <span class="n">translation</span><span class="o">=</span><span class="n">translation_dict</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;imaris_image_</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Create and return ZarrNii instance</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.from_ngff_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_ngff_image</span><span class="p">(</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="s1">&#39;ZYX&#39;</span><span class="p">,</span> <span class="n">xyz_orientation</span><span class="o">=</span><span class="s1">&#39;RAS&#39;</span><span class="p">,</span> <span class="n">omero</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Create ZarrNii from an existing NgffImage.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ngff_image</code>
            </td>
            <td>
                  <code><span title="ngff_zarr.NgffImage">NgffImage</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NgffImage to wrap</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axes order for NIfTI compatibility</p>
              </div>
            </td>
            <td>
                  <code>&#39;ZYX&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>xyz_orientation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Anatomical orientation string in XYZ axes order</p>
              </div>
            </td>
            <td>
                  <code>&#39;RAS&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>omero</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="object">object</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional omero metadata object</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ngff_image</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">ngff_image</span><span class="p">:</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">,</span>
    <span class="n">xyz_orientation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
    <span class="n">omero</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create ZarrNii from an existing NgffImage.</span>

<span class="sd">    Args:</span>
<span class="sd">        ngff_image: NgffImage to wrap</span>
<span class="sd">        axes_order: Spatial axes order for NIfTI compatibility</span>
<span class="sd">        xyz_orientation: Anatomical orientation string in XYZ axes order</span>
<span class="sd">        omero: Optional omero metadata object</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="n">omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.from_nifti" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_nifti</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="s1">&#39;XYZ&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_ref</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zooms</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Load ZarrNii from NIfTI file with flexible loading options.</p>
<p>Creates a ZarrNii instance from a NIfTI file, automatically converting
the data to dask arrays and extracting spatial transformation information.
Supports both full data loading and reference-only loading for memory
efficiency.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bytes">bytes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>File path to NIfTI file (.nii, .nii.gz, .img/.hdr)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dask array chunking strategy. Can be:
- "auto": Automatic chunking based on file size
- Tuple of ints: Manual chunk sizes for each dimension
- Dict mapping axis to chunk size</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axis ordering convention. Either:
- "XYZ": X=left-right, Y=anterior-posterior, Z=inferior-superior
- "ZYX": Z=inferior-superior, Y=anterior-posterior, X=left-right</p>
              </div>
            </td>
            <td>
                  <code>&#39;XYZ&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional name for the resulting NgffImage. If None,
uses filename without extension</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>as_ref</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, creates empty dask array with correct shape/metadata
without loading actual image data (memory efficient for templates)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zooms</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target voxel spacing as (x, y, z) in mm. Only valid when
as_ref=True. Adjusts shape and affine accordingly</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instance containing NIfTI data and spatial metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If zooms specified with as_ref=False, or invalid axes_order</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If NIfTI file does not exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to read NIfTI file</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="nibabel.filebasedimages.ImageFileError">ImageFileError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If file is not valid NIfTI</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load full NIfTI data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span><span class="s2">&quot;/path/to/brain.nii.gz&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load with custom chunking and axis order</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;/path/to/data.nii&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;ZYX&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create reference with target resolution</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii_ref</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_nifti</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;/path/to/template.nii.gz&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">as_ref</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">zooms</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <p>The method automatically handles NIfTI orientation codes and converts
them to the specified axes_order for consistency with OME-Zarr workflows.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_nifti</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">as_ref</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zooms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load ZarrNii from NIfTI file with flexible loading options.</span>

<span class="sd">    Creates a ZarrNii instance from a NIfTI file, automatically converting</span>
<span class="sd">    the data to dask arrays and extracting spatial transformation information.</span>
<span class="sd">    Supports both full data loading and reference-only loading for memory</span>
<span class="sd">    efficiency.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: File path to NIfTI file (.nii, .nii.gz, .img/.hdr)</span>
<span class="sd">        chunks: Dask array chunking strategy. Can be:</span>
<span class="sd">            - &quot;auto&quot;: Automatic chunking based on file size</span>
<span class="sd">            - Tuple of ints: Manual chunk sizes for each dimension</span>
<span class="sd">            - Dict mapping axis to chunk size</span>
<span class="sd">        axes_order: Spatial axis ordering convention. Either:</span>
<span class="sd">            - &quot;XYZ&quot;: X=left-right, Y=anterior-posterior, Z=inferior-superior</span>
<span class="sd">            - &quot;ZYX&quot;: Z=inferior-superior, Y=anterior-posterior, X=left-right</span>
<span class="sd">        name: Optional name for the resulting NgffImage. If None,</span>
<span class="sd">            uses filename without extension</span>
<span class="sd">        as_ref: If True, creates empty dask array with correct shape/metadata</span>
<span class="sd">            without loading actual image data (memory efficient for templates)</span>
<span class="sd">        zooms: Target voxel spacing as (x, y, z) in mm. Only valid when</span>
<span class="sd">            as_ref=True. Adjusts shape and affine accordingly</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii instance containing NIfTI data and spatial metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If zooms specified with as_ref=False, or invalid axes_order</span>
<span class="sd">        FileNotFoundError: If NIfTI file does not exist</span>
<span class="sd">        OSError: If unable to read NIfTI file</span>
<span class="sd">        nibabel.filebasedimages.ImageFileError: If file is not valid NIfTI</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Load full NIfTI data</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_nifti(&quot;/path/to/brain.nii.gz&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Load with custom chunking and axis order</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_nifti(</span>
<span class="sd">        ...     &quot;/path/to/data.nii&quot;,</span>
<span class="sd">        ...     chunks=(64, 64, 64),</span>
<span class="sd">        ...     axes_order=&quot;ZYX&quot;</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Create reference with target resolution</span>
<span class="sd">        &gt;&gt;&gt; znii_ref = ZarrNii.from_nifti(</span>
<span class="sd">        ...     &quot;/path/to/template.nii.gz&quot;,</span>
<span class="sd">        ...     as_ref=True,</span>
<span class="sd">        ...     zooms=(2.0, 2.0, 2.0)</span>
<span class="sd">        ... )</span>

<span class="sd">    Notes:</span>
<span class="sd">        The method automatically handles NIfTI orientation codes and converts</span>
<span class="sd">        them to the specified axes_order for consistency with OME-Zarr workflows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">as_ref</span> <span class="ow">and</span> <span class="n">zooms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`zooms` can only be used when `as_ref=True`.&quot;</span><span class="p">)</span>

    <span class="c1"># Load NIfTI file</span>
    <span class="n">nifti_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">nifti_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()</span>
    <span class="n">affine_matrix</span> <span class="o">=</span> <span class="n">nifti_img</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Adjust shape and affine if zooms are provided</span>
    <span class="k">if</span> <span class="n">zooms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">in_zooms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">affine_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Current voxel spacing</span>
        <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">in_zooms</span> <span class="o">/</span> <span class="n">zooms</span>
        <span class="n">new_shape</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling_factor</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>  <span class="c1"># Z</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling_factor</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>  <span class="c1"># Y</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>  <span class="c1"># X</span>
        <span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">zooms</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="k">if</span> <span class="n">as_ref</span><span class="p">:</span>
        <span class="c1"># Create an empty dask array with the adjusted shape</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">new_shape</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Load the NIfTI data and convert to a dask array</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">nifti_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>

    <span class="c1"># Add channel and time dimensions if not present</span>
    <span class="n">original_ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">original_ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># 3D data: add channel dimension -&gt; (c, z, y, x) or (c, x, y, z)</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">darr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">original_ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># 4D data: could be (c, z, y, x) or (t, z, y, x) - assume channel by default</span>
        <span class="c1"># User can specify if it&#39;s time by using appropriate axes_order</span>
        <span class="k">pass</span>  <span class="c1"># Keep as is - 4D is already handled</span>
    <span class="k">elif</span> <span class="n">original_ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># 5D data: assume (t, z, y, x, c) and handle appropriately</span>
        <span class="k">pass</span>  <span class="c1"># Keep as is - 5D is already the target format</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For 1D, 2D, or &gt;5D data, add channel dimension and let user handle</span>
        <span class="n">darr</span> <span class="o">=</span> <span class="n">darr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

    <span class="c1"># Create dimensions based on data shape after dimension adjustments</span>
    <span class="n">final_ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final_ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># 4D: (c, z, y, x) or (c, x, y, z) - standard case</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">final_ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># 5D: (t, c, z, y, x) or (t, c, x, y, z) - time dimension included</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback for other cases</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_order</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="c1"># Extract scale and translation from affine</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spatial_dims</span><span class="p">):</span>
        <span class="n">scale</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">affine_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">translation</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">affine_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Create NgffImage</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;nifti_image_</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">ngff_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">darr</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ngff_image</span><span class="o">=</span><span class="n">ngff_image</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.from_ome_zarr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_ome_zarr</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timepoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axes_order</span><span class="o">=</span><span class="s1">&#39;ZYX&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;RAS&#39;</span><span class="p">,</span> <span class="n">downsample_near_isotropic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">rechunk</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Load ZarrNii from OME-Zarr store with flexible options.</p>
<p>Creates a ZarrNii instance from an OME-Zarr store, supporting multiscale
pyramids, channel/timepoint selection, and various storage backends.
Automatically handles metadata extraction and format conversion.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>store_or_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Store or path to OME-Zarr file. Supports:
- Local file paths
- Remote URLs (s3://, http://, etc.)
- ZIP files (.zip extension)
- Zarr store objects</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>level</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyramid level to load (0 = highest resolution). If level
exceeds available levels, applies lazy downsampling</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channels</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel indices to load (0-based). Mutually
exclusive with channel_labels</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel_labels</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel names to load by label. Requires
OMERO metadata. Mutually exclusive with channels</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timepoints</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of timepoint indices to load (0-based). If None,
loads all available timepoints</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>storage_options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional options for zarr storage backend
(e.g., credentials for cloud storage)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axis order for NIfTI compatibility.
Either "ZYX" or "XYZ"</p>
              </div>
            </td>
            <td>
                  <code>&#39;ZYX&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>orientation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default anatomical orientation if not in metadata.
Standard orientations like "RAS", "LPI", etc. This is always
interpreted in XYZ axes order for consistency.</p>
              </div>
            </td>
            <td>
                  <code>&#39;RAS&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>downsample_near_isotropic</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, automatically downsample
dimensions with smaller voxel sizes to achieve near-isotropic
resolution</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="Ellipsis">Ellipsis</span>] | <span title="Literal">Literal</span>[&#39;auto&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>chunking strategy, or explicit chunk sizes to use if not automatic</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rechunk</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, rechunks the dataset after lazy loading, based
on the chunks parameter</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZarrNii instance with loaded data and metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If both channels and channel_labels are specified,
or if invalid level/indices are provided</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If store_or_path does not exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If specified channel labels are not found</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="IOError">IOError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to read from the storage backend</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load full resolution data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ome_zarr</span><span class="p">(</span><span class="s2">&quot;/path/to/data.zarr&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load specific channels and pyramid level</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ome_zarr</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;/path/to/data.zarr&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;LPI&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load from cloud storage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span> <span class="o">=</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ome_zarr</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;s3://bucket/data.zarr&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">storage_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;access_key&quot;</span><span class="p">,</span> <span class="s2">&quot;secret&quot;</span><span class="p">:</span> <span class="s2">&quot;secret&quot;</span><span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <p><strong>Orientation Metadata Backwards Compatibility:</strong></p>
<p>This method implements backwards compatibility for orientation metadata:</p>
<ol>
<li>
<p><strong>Priority Order</strong>: Checks for 'xyz_orientation' first (new format),
   then falls back to 'orientation' (legacy format)</p>
</li>
<li>
<p><strong>Legacy Fallback</strong>: When only legacy 'orientation' is found, the
   orientation string is automatically reversed to convert from ZYX-based
   encoding (legacy) to XYZ-based encoding (current standard)</p>
</li>
<li>
<p><strong>Default Fallback</strong>: If no orientation metadata is found, uses the
   provided 'orientation' parameter as the default</p>
</li>
</ol>
<p>Examples of the conversion:
- Legacy 'orientation'='SAR' (ZYX) → 'xyz_orientation'='RAS' (XYZ)
- Legacy 'orientation'='IPL' (ZYX) → 'xyz_orientation'='LPI' (XYZ)</p>
<p>This ensures consistent orientation handling while maintaining backwards
compatibility with existing OME-Zarr files that use the legacy format.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ome_zarr</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">store_or_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">channel_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timepoints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
    <span class="n">downsample_near_isotropic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="bp">Ellipsis</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">rechunk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load ZarrNii from OME-Zarr store with flexible options.</span>

<span class="sd">    Creates a ZarrNii instance from an OME-Zarr store, supporting multiscale</span>
<span class="sd">    pyramids, channel/timepoint selection, and various storage backends.</span>
<span class="sd">    Automatically handles metadata extraction and format conversion.</span>

<span class="sd">    Args:</span>
<span class="sd">        store_or_path: Store or path to OME-Zarr file. Supports:</span>
<span class="sd">            - Local file paths</span>
<span class="sd">            - Remote URLs (s3://, http://, etc.)</span>
<span class="sd">            - ZIP files (.zip extension)</span>
<span class="sd">            - Zarr store objects</span>
<span class="sd">        level: Pyramid level to load (0 = highest resolution). If level</span>
<span class="sd">            exceeds available levels, applies lazy downsampling</span>
<span class="sd">        channels: List of channel indices to load (0-based). Mutually</span>
<span class="sd">            exclusive with channel_labels</span>
<span class="sd">        channel_labels: List of channel names to load by label. Requires</span>
<span class="sd">            OMERO metadata. Mutually exclusive with channels</span>
<span class="sd">        timepoints: List of timepoint indices to load (0-based). If None,</span>
<span class="sd">            loads all available timepoints</span>
<span class="sd">        storage_options: Additional options for zarr storage backend</span>
<span class="sd">            (e.g., credentials for cloud storage)</span>
<span class="sd">        axes_order: Spatial axis order for NIfTI compatibility.</span>
<span class="sd">            Either &quot;ZYX&quot; or &quot;XYZ&quot;</span>
<span class="sd">        orientation: Default anatomical orientation if not in metadata.</span>
<span class="sd">            Standard orientations like &quot;RAS&quot;, &quot;LPI&quot;, etc. This is always</span>
<span class="sd">            interpreted in XYZ axes order for consistency.</span>
<span class="sd">        downsample_near_isotropic: If True, automatically downsample</span>
<span class="sd">            dimensions with smaller voxel sizes to achieve near-isotropic</span>
<span class="sd">            resolution</span>
<span class="sd">        chunks: chunking strategy, or explicit chunk sizes to use if not automatic</span>
<span class="sd">        rechunk: If True, rechunks the dataset after lazy loading, based</span>
<span class="sd">            on the chunks parameter</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii instance with loaded data and metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If both channels and channel_labels are specified,</span>
<span class="sd">            or if invalid level/indices are provided</span>
<span class="sd">        FileNotFoundError: If store_or_path does not exist</span>
<span class="sd">        KeyError: If specified channel labels are not found</span>
<span class="sd">        IOError: If unable to read from the storage backend</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Load full resolution data</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_ome_zarr(&quot;/path/to/data.zarr&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Load specific channels and pyramid level</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_ome_zarr(</span>
<span class="sd">        ...     &quot;/path/to/data.zarr&quot;,</span>
<span class="sd">        ...     level=1,</span>
<span class="sd">        ...     channels=[0, 2],</span>
<span class="sd">        ...     orientation=&quot;LPI&quot;</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Load from cloud storage</span>
<span class="sd">        &gt;&gt;&gt; znii = ZarrNii.from_ome_zarr(</span>
<span class="sd">        ...     &quot;s3://bucket/data.zarr&quot;,</span>
<span class="sd">        ...     storage_options={&quot;key&quot;: &quot;access_key&quot;, &quot;secret&quot;: &quot;secret&quot;}</span>
<span class="sd">        ... )</span>

<span class="sd">    Notes:</span>
<span class="sd">        **Orientation Metadata Backwards Compatibility:**</span>

<span class="sd">        This method implements backwards compatibility for orientation metadata:</span>

<span class="sd">        1. **Priority Order**: Checks for &#39;xyz_orientation&#39; first (new format),</span>
<span class="sd">           then falls back to &#39;orientation&#39; (legacy format)</span>

<span class="sd">        2. **Legacy Fallback**: When only legacy &#39;orientation&#39; is found, the</span>
<span class="sd">           orientation string is automatically reversed to convert from ZYX-based</span>
<span class="sd">           encoding (legacy) to XYZ-based encoding (current standard)</span>

<span class="sd">        3. **Default Fallback**: If no orientation metadata is found, uses the</span>
<span class="sd">           provided &#39;orientation&#39; parameter as the default</span>

<span class="sd">        Examples of the conversion:</span>
<span class="sd">        - Legacy &#39;orientation&#39;=&#39;SAR&#39; (ZYX) → &#39;xyz_orientation&#39;=&#39;RAS&#39; (XYZ)</span>
<span class="sd">        - Legacy &#39;orientation&#39;=&#39;IPL&#39; (ZYX) → &#39;xyz_orientation&#39;=&#39;LPI&#39; (XYZ)</span>

<span class="sd">        This ensures consistent orientation handling while maintaining backwards</span>
<span class="sd">        compatibility with existing OME-Zarr files that use the legacy format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate channel and timepoint selection arguments</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">channel_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify both &#39;channels&#39; and &#39;channel_labels&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Load the multiscales object</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Handle ZIP files by creating a ZipStore</span>
            <span class="k">if</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

                <span class="n">store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span>
                    <span class="n">store</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="p">)</span>
                <span class="c1"># Note: We&#39;ll close the store after extracting metadata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span>
                    <span class="n">store_or_path</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Fallback for older zarr/ngff_zarr versions</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

                <span class="n">store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">store_or_path</span>
            <span class="n">multiscales</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">from_ngff_zarr</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>

    <span class="c1"># Extract omero metadata if available</span>
    <span class="n">omero_metadata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                <span class="n">zip_store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">zip_store</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="c1"># Close zip store after getting group</span>
                <span class="n">zip_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;omero&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">omero_dict</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;omero&quot;</span><span class="p">]</span>

            <span class="c1"># Create a simple object to hold omero metadata</span>
            <span class="k">class</span><span class="w"> </span><span class="nc">OmeroMetadata</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omero_dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="s2">&quot;channels&quot;</span> <span class="ow">in</span> <span class="n">omero_dict</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">ch_dict</span> <span class="ow">in</span> <span class="n">omero_dict</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">]:</span>
                            <span class="c1"># Create channel objects</span>
                            <span class="k">class</span><span class="w"> </span><span class="nc">ChannelMetadata</span><span class="p">:</span>
                                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_dict</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">ch_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">ch_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="s2">&quot;window&quot;</span> <span class="ow">in</span> <span class="n">ch_dict</span><span class="p">:</span>

                                        <span class="k">class</span><span class="w"> </span><span class="nc">WindowMetadata</span><span class="p">:</span>
                                            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win_dict</span><span class="p">):</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">win_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">win_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                                    <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="mf">65535.0</span>
                                                <span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">win_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                                    <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="mf">0.0</span>
                                                <span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">win_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                                    <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="mf">65535.0</span>
                                                <span class="p">)</span>

                                        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">WindowMetadata</span><span class="p">(</span>
                                            <span class="n">ch_dict</span><span class="p">[</span><span class="s2">&quot;window&quot;</span><span class="p">]</span>
                                        <span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ChannelMetadata</span><span class="p">(</span><span class="n">ch_dict</span><span class="p">))</span>

            <span class="n">omero_metadata</span> <span class="o">=</span> <span class="n">OmeroMetadata</span><span class="p">(</span><span class="n">omero_dict</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># If we can&#39;t load omero metadata, that&#39;s okay</span>
        <span class="k">pass</span>

    <span class="c1"># Read orientation metadata with backwards compatibility support</span>
    <span class="c1"># Priority: xyz_orientation (new) &gt; orientation (legacy, with reversal)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">):</span>
                <span class="n">zip_store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">ZipStore</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">zip_store</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="c1"># Check for new xyz_orientation first, then fallback to legacy orientation</span>
                <span class="k">if</span> <span class="s2">&quot;xyz_orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;xyz_orientation&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="c1"># Legacy orientation is ZYX-based, reverse it to get XYZ-based orientation</span>
                    <span class="n">legacy_orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">reverse_orientation_string</span><span class="p">(</span><span class="n">legacy_orientation</span><span class="p">)</span>
                <span class="c1"># If neither found, use the provided default orientation</span>
                <span class="n">zip_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="c1"># Check for new xyz_orientation first, then fallback to legacy orientation</span>
                <span class="k">if</span> <span class="s2">&quot;xyz_orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;xyz_orientation&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="c1"># Legacy orientation is ZYX-based, reverse it to get XYZ-based orientation</span>
                    <span class="n">legacy_orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="n">reverse_orientation_string</span><span class="p">(</span><span class="n">legacy_orientation</span><span class="p">)</span>
                <span class="c1"># If neither found, use the provided default orientation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="c1"># Check for new xyz_orientation first, then fallback to legacy orientation</span>
            <span class="k">if</span> <span class="s2">&quot;xyz_orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;xyz_orientation&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;orientation&quot;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="c1"># Legacy orientation is ZYX-based, reverse it to get XYZ-based orientation</span>
                <span class="n">legacy_orientation</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="n">reverse_orientation_string</span><span class="p">(</span><span class="n">legacy_orientation</span><span class="p">)</span>
            <span class="c1"># If neither found, use the provided default orientation</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># If we can&#39;t read orientation metadata, use the provided default</span>
        <span class="k">pass</span>

    <span class="c1"># Determine the available pyramid levels and handle lazy downsampling</span>
    <span class="n">max_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiscales</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">actual_level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">max_level</span><span class="p">)</span>
    <span class="n">do_downsample</span> <span class="o">=</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">max_level</span>

    <span class="c1"># Get the highest available level</span>
    <span class="n">ngff_image</span> <span class="o">=</span> <span class="n">multiscales</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">actual_level</span><span class="p">]</span>

    <span class="c1"># Handle channel and timepoint selection and filter omero metadata accordingly</span>
    <span class="n">filtered_omero</span> <span class="o">=</span> <span class="n">omero_metadata</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">channel_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">timepoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ngff_image</span><span class="p">,</span> <span class="n">filtered_omero</span> <span class="o">=</span> <span class="n">_select_dimensions_from_image_with_omero</span><span class="p">(</span>
            <span class="n">ngff_image</span><span class="p">,</span>
            <span class="n">multiscales</span><span class="p">,</span>
            <span class="n">channels</span><span class="p">,</span>
            <span class="n">channel_labels</span><span class="p">,</span>
            <span class="n">timepoints</span><span class="p">,</span>
            <span class="n">omero_metadata</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Create ZarrNii instance with xyz_orientation</span>
    <span class="n">znimg</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="n">filtered_omero</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Apply lazy downsampling if needed</span>
    <span class="k">if</span> <span class="n">do_downsample</span><span class="p">:</span>
        <span class="n">level_ds</span> <span class="o">=</span> <span class="n">level</span> <span class="o">-</span> <span class="n">max_level</span>
        <span class="n">downsample_factor</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">level_ds</span>

        <span class="c1"># Get spatial dims based on axes order</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>

        <span class="c1"># Apply downsampling using the existing method</span>
        <span class="n">znimg</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span>
            <span class="n">factors</span><span class="o">=</span><span class="n">downsample_factor</span><span class="p">,</span> <span class="n">spatial_dims</span><span class="o">=</span><span class="n">spatial_dims</span>
        <span class="p">)</span>

    <span class="c1"># Apply near-isotropic downsampling if requested</span>
    <span class="k">if</span> <span class="n">downsample_near_isotropic</span><span class="p">:</span>
        <span class="n">znimg</span> <span class="o">=</span> <span class="n">_apply_near_isotropic_downsampling</span><span class="p">(</span><span class="n">znimg</span><span class="p">,</span> <span class="n">axes_order</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rechunk</span><span class="p">:</span>
        <span class="n">znimg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">znimg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.get_affine_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_affine_matrix</span><span class="p">(</span><span class="n">axes_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get 4x4 affine transformation matrix from NgffImage metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axes order, defaults to self.axes_order</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>4x4 affine transformation matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_affine_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get 4x4 affine transformation matrix from NgffImage metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        axes_order: Spatial axes order, defaults to self.axes_order</span>

<span class="sd">    Returns:</span>
<span class="sd">        4x4 affine transformation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axes_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span>

    <span class="c1"># Create identity 4x4 matrix</span>
    <span class="n">affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Map axes order to matrix indices</span>
    <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>

    <span class="c1"># Set scale values</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spatial_dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
            <span class="n">affine</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>

    <span class="c1"># Set translation values</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spatial_dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">translation</span><span class="p">:</span>
            <span class="n">affine</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>

    <span class="c1"># Apply orientation alignment if orientation is available</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;orientation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">:</span>
        <span class="n">affine</span> <span class="o">=</span> <span class="n">align_affine_to_input_orientation</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">affine</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.get_affine_transform" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_affine_transform</span><span class="p">(</span><span class="n">axes_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get AffineTransform object from NgffImage metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axes order, defaults to self.axes_order</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="zarrnii.transform.AffineTransform" href="#zarrnii.transform.AffineTransform">AffineTransform</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>AffineTransform object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_affine_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AffineTransform</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get AffineTransform object from NgffImage metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        axes_order: Spatial axes order, defaults to self.axes_order</span>

<span class="sd">    Returns:</span>
<span class="sd">        AffineTransform object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_affine_matrix</span><span class="p">(</span><span class="n">axes_order</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.get_orientation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_orientation</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get orientation string from affine matrix.</p>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get orientation string from affine matrix.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">affine_to_orientation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_affine_matrix</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.get_origin" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_origin</span><span class="p">(</span><span class="n">axes_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get origin (translation) from NgffImage.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axes order, defaults to self.axes_order</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of origin coordinates</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get origin (translation) from NgffImage.</span>

<span class="sd">    Args:</span>
<span class="sd">        axes_order: Spatial axes order, defaults to self.axes_order</span>

<span class="sd">    Returns:</span>
<span class="sd">        Array of origin coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axes_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span>

    <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">spatial_dims</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">translation</span><span class="p">:</span>
            <span class="n">origin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">origin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.get_zooms" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_zooms</span><span class="p">(</span><span class="n">axes_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get voxel spacing (zooms) from NgffImage scale.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>axes_order</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial axes order, defaults to self.axes_order</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of voxel spacings</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_zooms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes_order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get voxel spacing (zooms) from NgffImage scale.</span>

<span class="sd">    Args:</span>
<span class="sd">        axes_order: Spatial axes order, defaults to self.axes_order</span>

<span class="sd">    Returns:</span>
<span class="sd">        Array of voxel spacings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axes_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span>

    <span class="n">spatial_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
    <span class="n">zooms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">spatial_dims</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
            <span class="n">zooms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zooms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zooms</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.list_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_channels</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get list of available channel labels from OMERO metadata.</p>
<p>Extracts channel labels from OMERO metadata if available, providing
human-readable names for multi-channel datasets.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel label strings. Empty list if no OMERO metadata</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>is available or no channels are defined.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Check available channels</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">labels</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">list_channels</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available channels: </span><span class="si">{</span><span class="n">labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># [&#39;DAPI&#39;, &#39;GFP&#39;, &#39;RFP&#39;, &#39;Cy5&#39;]</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Select specific channels by label</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">selected</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">select_channels</span><span class="p">(</span><span class="n">channel_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DAPI&#39;</span><span class="p">,</span> <span class="s1">&#39;GFP&#39;</span><span class="p">])</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Requires OMERO metadata to be present in the dataset</li>
<li>Returns empty list for datasets without channel metadata</li>
<li>Labels are extracted from the 'label' field of each channel</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get list of available channel labels from OMERO metadata.</span>

<span class="sd">    Extracts channel labels from OMERO metadata if available, providing</span>
<span class="sd">    human-readable names for multi-channel datasets.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of channel label strings. Empty list if no OMERO metadata</span>
<span class="sd">        is available or no channels are defined.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Check available channels</span>
<span class="sd">        &gt;&gt;&gt; labels = znii.list_channels()</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Available channels: {labels}&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # [&#39;DAPI&#39;, &#39;GFP&#39;, &#39;RFP&#39;, &#39;Cy5&#39;]</span>

<span class="sd">        &gt;&gt;&gt; # Select specific channels by label</span>
<span class="sd">        &gt;&gt;&gt; selected = znii.select_channels(channel_labels=[&#39;DAPI&#39;, &#39;GFP&#39;])</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Requires OMERO metadata to be present in the dataset</span>
<span class="sd">        - Returns empty list for datasets without channel metadata</span>
<span class="sd">        - Labels are extracted from the &#39;label&#39; field of each channel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">omero</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omero</span><span class="p">,</span> <span class="s2">&quot;channels&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">label</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">ch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">omero</span><span class="o">.</span><span class="n">channels</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.segment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">segment</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply segmentation plugin to the image using blockwise processing.</p>
<p>This method applies a segmentation plugin to the image data using dask's
blockwise processing for efficient computation on large datasets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plugin</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Segmentation plugin instance or class to apply</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_size</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional chunk size for dask processing. If None, uses current chunks.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the plugin</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with segmented data as labels</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span>
<span class="normal">3400</span>
<span class="normal">3401</span>
<span class="normal">3402</span>
<span class="normal">3403</span>
<span class="normal">3404</span>
<span class="normal">3405</span>
<span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">segment</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply segmentation plugin to the image using blockwise processing.</span>

<span class="sd">    This method applies a segmentation plugin to the image data using dask&#39;s</span>
<span class="sd">    blockwise processing for efficient computation on large datasets.</span>

<span class="sd">    Args:</span>
<span class="sd">        plugin: Segmentation plugin instance or class to apply</span>
<span class="sd">        chunk_size: Optional chunk size for dask processing. If None, uses current chunks.</span>
<span class="sd">        **kwargs: Additional arguments passed to the plugin</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with segmented data as labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.plugins.segmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">SegmentationPlugin</span>

    <span class="c1"># Handle plugin instance or class</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">SegmentationPlugin</span><span class="p">):</span>
        <span class="n">plugin</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">SegmentationPlugin</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Plugin must be an instance or subclass of SegmentationPlugin&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Prepare chunk size</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Rechunk the data if different chunk size requested</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Create metadata dict to pass to plugin</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;axes_order&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="s2">&quot;dims&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
        <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
        <span class="s2">&quot;translation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Create a wrapper function for map_blocks</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">segment_block</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper function to apply segmentation to a single block.&quot;&quot;&quot;</span>
        <span class="c1"># Handle single blocks</span>
        <span class="k">return</span> <span class="n">plugin</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="c1"># Apply segmentation using dask map_blocks</span>
    <span class="n">segmented_data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">segment_block</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>  <span class="c1"># Segmentation results are typically uint8</span>
        <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>  <span class="c1"># Provide meta information</span>
    <span class="p">)</span>

    <span class="c1"># Create new NgffImage with segmented data</span>
    <span class="n">new_ngff_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">segmented_data</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">translation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_segmented_</span><span class="si">{</span><span class="n">plugin</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Return new ZarrNii instance</span>
    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">new_ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.segment_otsu" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">segment_otsu</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply local Otsu thresholding segmentation to the image.</p>
<p>Convenience method for local Otsu thresholding segmentation.
This computes the threshold locally for each processing block.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>nbins</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins for histogram computation (default: 256)</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_size</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional chunk size for dask processing</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with binary segmentation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span>
<span class="normal">3446</span>
<span class="normal">3447</span>
<span class="normal">3448</span>
<span class="normal">3449</span>
<span class="normal">3450</span>
<span class="normal">3451</span>
<span class="normal">3452</span>
<span class="normal">3453</span>
<span class="normal">3454</span>
<span class="normal">3455</span>
<span class="normal">3456</span>
<span class="normal">3457</span>
<span class="normal">3458</span>
<span class="normal">3459</span>
<span class="normal">3460</span>
<span class="normal">3461</span>
<span class="normal">3462</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">segment_otsu</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply local Otsu thresholding segmentation to the image.</span>

<span class="sd">    Convenience method for local Otsu thresholding segmentation.</span>
<span class="sd">    This computes the threshold locally for each processing block.</span>

<span class="sd">    Args:</span>
<span class="sd">        nbins: Number of bins for histogram computation (default: 256)</span>
<span class="sd">        chunk_size: Optional chunk size for dask processing</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with binary segmentation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.plugins.segmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalOtsuSegmentation</span>

    <span class="n">plugin</span> <span class="o">=</span> <span class="n">LocalOtsuSegmentation</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="n">nbins</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.segment_threshold" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">segment_threshold</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply threshold-based segmentation to the image.</p>
<p>Convenience method for threshold-based segmentation using either
manual threshold values or computed thresholds.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>thresholds</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Single threshold value or list of threshold values.
For single threshold, creates binary segmentation (0/1).
For multiple thresholds, creates multi-class segmentation (0/1/2/...).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inclusive</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether thresholds are inclusive (default: True).
If True, pixels &gt;= threshold are labeled as foreground.
If False, pixels &gt; threshold are labeled as foreground.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_size</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional chunk size for dask processing</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with labeled segmentation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Binary threshold segmentation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">segmented</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">segment_threshold</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Multi-level threshold segmentation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">compute_otsu_thresholds</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">segmented</span> <span class="o">=</span> <span class="n">znimg</span><span class="o">.</span><span class="n">segment_threshold</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Exclude min/max values</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3464</span>
<span class="normal">3465</span>
<span class="normal">3466</span>
<span class="normal">3467</span>
<span class="normal">3468</span>
<span class="normal">3469</span>
<span class="normal">3470</span>
<span class="normal">3471</span>
<span class="normal">3472</span>
<span class="normal">3473</span>
<span class="normal">3474</span>
<span class="normal">3475</span>
<span class="normal">3476</span>
<span class="normal">3477</span>
<span class="normal">3478</span>
<span class="normal">3479</span>
<span class="normal">3480</span>
<span class="normal">3481</span>
<span class="normal">3482</span>
<span class="normal">3483</span>
<span class="normal">3484</span>
<span class="normal">3485</span>
<span class="normal">3486</span>
<span class="normal">3487</span>
<span class="normal">3488</span>
<span class="normal">3489</span>
<span class="normal">3490</span>
<span class="normal">3491</span>
<span class="normal">3492</span>
<span class="normal">3493</span>
<span class="normal">3494</span>
<span class="normal">3495</span>
<span class="normal">3496</span>
<span class="normal">3497</span>
<span class="normal">3498</span>
<span class="normal">3499</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">segment_threshold</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">thresholds</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">inclusive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply threshold-based segmentation to the image.</span>

<span class="sd">    Convenience method for threshold-based segmentation using either</span>
<span class="sd">    manual threshold values or computed thresholds.</span>

<span class="sd">    Args:</span>
<span class="sd">        thresholds: Single threshold value or list of threshold values.</span>
<span class="sd">            For single threshold, creates binary segmentation (0/1).</span>
<span class="sd">            For multiple thresholds, creates multi-class segmentation (0/1/2/...).</span>
<span class="sd">        inclusive: Whether thresholds are inclusive (default: True).</span>
<span class="sd">            If True, pixels &gt;= threshold are labeled as foreground.</span>
<span class="sd">            If False, pixels &gt; threshold are labeled as foreground.</span>
<span class="sd">        chunk_size: Optional chunk size for dask processing</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with labeled segmentation</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Binary threshold segmentation</span>
<span class="sd">        &gt;&gt;&gt; segmented = znimg.segment_threshold(0.5)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Multi-level threshold segmentation</span>
<span class="sd">        &gt;&gt;&gt; thresholds = znimg.compute_otsu_thresholds(classes=3)</span>
<span class="sd">        &gt;&gt;&gt; segmented = znimg.segment_threshold(thresholds[1:-1])  # Exclude min/max values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.plugins.segmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThresholdSegmentation</span>

    <span class="n">plugin</span> <span class="o">=</span> <span class="n">ThresholdSegmentation</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="n">inclusive</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.select_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">select_channels</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Select specific channels from multi-channel image data.</p>
<p>Creates a new ZarrNii instance containing only the specified channels,
reducing memory usage and focusing analysis on channels of interest.
Supports selection by both numeric indices and human-readable labels.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>channels</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of 0-based channel indices to select.
Mutually exclusive with channel_labels</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel_labels</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel names to select by label.
Requires OMERO metadata. Mutually exclusive with channels</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with selected channels and updated metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If both channels and channel_labels specified, or if
channel_labels used without OMERO metadata, or if labels not found</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="IndexError">IndexError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If channel indices are out of range</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Select channels by index</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">selected</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">select_channels</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Select channels by label (requires OMERO metadata)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">selected</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">select_channels</span><span class="p">(</span><span class="n">channel_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DAPI&#39;</span><span class="p">,</span> <span class="s1">&#39;GFP&#39;</span><span class="p">])</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Check available labels first</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">available</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">list_channels</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">selected</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">select_channels</span><span class="p">(</span><span class="n">channel_labels</span><span class="o">=</span><span class="n">available</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Preserves all spatial dimensions and timepoints</li>
<li>Updates OMERO metadata to reflect selected channels</li>
<li>Maintains spatial transformations and other metadata</li>
<li>Channel order in output matches selection order</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select_channels</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">channel_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select specific channels from multi-channel image data.</span>

<span class="sd">    Creates a new ZarrNii instance containing only the specified channels,</span>
<span class="sd">    reducing memory usage and focusing analysis on channels of interest.</span>
<span class="sd">    Supports selection by both numeric indices and human-readable labels.</span>

<span class="sd">    Args:</span>
<span class="sd">        channels: List of 0-based channel indices to select.</span>
<span class="sd">            Mutually exclusive with channel_labels</span>
<span class="sd">        channel_labels: List of channel names to select by label.</span>
<span class="sd">            Requires OMERO metadata. Mutually exclusive with channels</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with selected channels and updated metadata</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If both channels and channel_labels specified, or if</span>
<span class="sd">            channel_labels used without OMERO metadata, or if labels not found</span>
<span class="sd">        IndexError: If channel indices are out of range</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Select channels by index</span>
<span class="sd">        &gt;&gt;&gt; selected = znii.select_channels(channels=[0, 2])</span>

<span class="sd">        &gt;&gt;&gt; # Select channels by label (requires OMERO metadata)</span>
<span class="sd">        &gt;&gt;&gt; selected = znii.select_channels(channel_labels=[&#39;DAPI&#39;, &#39;GFP&#39;])</span>

<span class="sd">        &gt;&gt;&gt; # Check available labels first</span>
<span class="sd">        &gt;&gt;&gt; available = znii.list_channels()</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Available: {available}&quot;)</span>
<span class="sd">        &gt;&gt;&gt; selected = znii.select_channels(channel_labels=available[:2])</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Preserves all spatial dimensions and timepoints</span>
<span class="sd">        - Updates OMERO metadata to reflect selected channels</span>
<span class="sd">        - Maintains spatial transformations and other metadata</span>
<span class="sd">        - Channel order in output matches selection order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">channel_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify both &#39;channels&#39; and &#39;channel_labels&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">channel_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">omero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Channel labels were specified but no omero metadata found&quot;</span>
            <span class="p">)</span>

        <span class="n">available_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_channels</span><span class="p">()</span>
        <span class="n">channel_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">channel_labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel label &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
            <span class="n">channel_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">available_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">channel_indices</span>

    <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Return a copy with all channels</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Check if channel dimension exists</span>
    <span class="k">if</span> <span class="s2">&quot;c&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No channel dimension found in the data&quot;</span><span class="p">)</span>

    <span class="c1"># Get channel dimension index</span>
    <span class="n">c_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

    <span class="c1"># Create slice objects for proper dimension indexing</span>
    <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">slices</span><span class="p">[</span><span class="n">c_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span>

    <span class="c1"># Select channels from data using proper dimension indexing</span>
    <span class="n">selected_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span>

    <span class="c1"># Create new NgffImage with selected data</span>
    <span class="n">new_ngff_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">selected_data</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">translation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Filter omero metadata to match selected channels</span>
    <span class="n">filtered_omero</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">omero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omero</span><span class="p">,</span> <span class="s2">&quot;channels&quot;</span><span class="p">):</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">FilteredOmero</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>

        <span class="n">filtered_channels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">omero</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">]</span>
        <span class="n">filtered_omero</span> <span class="o">=</span> <span class="n">FilteredOmero</span><span class="p">(</span><span class="n">filtered_channels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">new_ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="n">filtered_omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.select_timepoints" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">select_timepoints</span><span class="p">(</span><span class="n">timepoints</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Select timepoints from the image data and return a new ZarrNii instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>timepoints</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timepoint indices to select</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New ZarrNii instance with selected timepoints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span>
<span class="normal">3346</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select_timepoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select timepoints from the image data and return a new ZarrNii instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        timepoints: Timepoint indices to select</span>

<span class="sd">    Returns:</span>
<span class="sd">        New ZarrNii instance with selected timepoints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timepoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Return a copy with all timepoints</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Check if time dimension exists</span>
    <span class="k">if</span> <span class="s2">&quot;t&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No time dimension found in the data&quot;</span><span class="p">)</span>

    <span class="c1"># Get time dimension index</span>
    <span class="n">t_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>

    <span class="c1"># Create slice objects</span>
    <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">slices</span><span class="p">[</span><span class="n">t_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">timepoints</span>

    <span class="c1"># Select timepoints from data</span>
    <span class="n">selected_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span>

    <span class="c1"># Create new NgffImage with selected data</span>
    <span class="n">new_ngff_image</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">selected_data</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">translation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ZarrNii</span><span class="p">(</span>
        <span class="n">ngff_image</span><span class="o">=</span><span class="n">new_ngff_image</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">_omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_omero</span><span class="p">,</span>  <span class="c1"># Timepoint selection doesn&#39;t affect omero metadata</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.to_imaris" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_imaris</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="n">compression_opts</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Save to Imaris (.ims) file format using HDF5.</p>
<p>This method creates Imaris files compatible with Imaris software by
following the exact HDF5 structure from correctly-formed reference files.
All attributes use byte-array encoding as required by Imaris.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output path for Imaris (.ims) file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HDF5 compression method (default: "gzip")</p>
              </div>
            </td>
            <td>
                  <code>&#39;gzip&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression_opts</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression level (default: 6)</p>
              </div>
            </td>
            <td>
                  <code>6</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If h5py is not available</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_imaris</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="n">compression_opts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save to Imaris (.ims) file format using HDF5.</span>

<span class="sd">    This method creates Imaris files compatible with Imaris software by</span>
<span class="sd">    following the exact HDF5 structure from correctly-formed reference files.</span>
<span class="sd">    All attributes use byte-array encoding as required by Imaris.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Output path for Imaris (.ims) file</span>
<span class="sd">        compression: HDF5 compression method (default: &quot;gzip&quot;)</span>
<span class="sd">        compression_opts: Compression level (default: 6)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the saved file</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If h5py is not available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;h5py is required for Imaris support. &quot;</span>
            <span class="s2">&quot;Install with: pip install zarrnii[imaris] or pip install h5py&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Ensure path has .ims extension</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ims&quot;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.ims&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_string_to_byte_array</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert string to byte array as required by Imaris.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span>

    <span class="c1"># Get data and metadata</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>  <span class="c1"># Convert Dask array to numpy array</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="p">)</span>  <span class="c1"># Handle numpy arrays directly</span>

    <span class="c1"># Handle dimensions: expect ZYX or CZYX</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># CZYX format</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># ZYX format - single channel</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># Add channel dimension</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported data shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Expected 3D (ZYX) or 4D (CZYX)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Create Imaris file structure exactly matching reference file</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Root attributes - use exact byte array format from reference</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;DataSetDirectoryName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;DataSet&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;DataSetInfoDirectoryName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;DataSetInfo&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImarisDataSet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;ImarisDataSet&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImarisVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;5.5.0&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumberOfDataSets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ThumbnailDirectoryName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;Thumbnail&quot;</span><span class="p">)</span>

        <span class="c1"># Create main DataSet group structure</span>
        <span class="n">dataset_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;DataSet&quot;</span><span class="p">)</span>
        <span class="n">res_group</span> <span class="o">=</span> <span class="n">dataset_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ResolutionLevel 0&quot;</span><span class="p">)</span>
        <span class="n">time_group</span> <span class="o">=</span> <span class="n">res_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;TimePoint 0&quot;</span><span class="p">)</span>

        <span class="c1"># Create channels with proper attributes</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channels</span><span class="p">):</span>
            <span class="n">channel_group</span> <span class="o">=</span> <span class="n">time_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">channel_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>  <span class="c1"># (Z, Y, X)</span>

            <span class="c1"># Channel attributes - use byte array format exactly like reference</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageSizeZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageBlockSizeX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageBlockSizeY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ImageBlockSizeZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># Histogram range attributes</span>
            <span class="n">data_min</span><span class="p">,</span> <span class="n">data_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">channel_data</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">channel_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;HistogramMin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_min</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;HistogramMax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_max</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Create data dataset with proper compression</span>
            <span class="c1"># Preserve original data type but ensure it&#39;s compatible with Imaris</span>
            <span class="k">if</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="ow">or</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="c1"># Keep float data as is for round-trip compatibility</span>
                <span class="n">data_for_storage</span> <span class="o">=</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">]:</span>
                <span class="c1"># Keep 16-bit data as is</span>
                <span class="n">data_for_storage</span> <span class="o">=</span> <span class="n">channel_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Convert other types to uint8</span>
                <span class="n">data_for_storage</span> <span class="o">=</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="n">channel_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;Data&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data_for_storage</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                <span class="n">compression_opts</span><span class="o">=</span><span class="n">compression_opts</span><span class="p">,</span>
                <span class="n">chunks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create histogram</span>
            <span class="n">hist_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">channel_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span> <span class="n">data_max</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">channel_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s2">&quot;Histogram&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Get spacing directly from scale dictionary with proper XYZ order</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract voxel sizes directly from ngff_image scale dictionary</span>
            <span class="c1"># This ensures we get X, Y, Z in the correct order regardless of axes_order</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Calculate extents (physical coordinates)</span>
        <span class="n">ext_x</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">x</span>
        <span class="n">ext_y</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">y</span>
        <span class="n">ext_z</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">*</span> <span class="n">z</span>

        <span class="c1"># Create comprehensive DataSetInfo structure matching reference</span>
        <span class="n">info_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;DataSetInfo&quot;</span><span class="p">)</span>

        <span class="c1"># Create channel info groups</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channels</span><span class="p">):</span>
            <span class="n">channel_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Essential channel attributes in byte array format</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="s2">&quot;1.000 0.000 0.000&quot;</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;0.000 </span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mf">0.0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mf">0.0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ColorMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;BaseColor&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ColorOpacity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1.000&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ColorRange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;0 255&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;GammaCorrection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1.000&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LSMEmissionWavelength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="s2">&quot;500&quot;</span>
            <span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LSMExcitationWavelength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
                <span class="s2">&quot;500&quot;</span>
            <span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LSMPhotons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LSMPinhole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>

            <span class="c1"># Add description</span>
            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> created by ZarrNii&quot;</span>
            <span class="n">channel_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># Create CRITICAL Image group with voxel size information (this was missing!)</span>
        <span class="n">image_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;Image&quot;</span><span class="p">)</span>

        <span class="c1"># Add essential image metadata with proper voxel size information</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;um&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Noc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n_channels</span><span class="p">))</span>

        <span class="c1"># CRITICAL: Set proper physical extents that define voxel size</span>
        <span class="c1"># Imaris reads voxel size from these extent values</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMin0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="n">ext_x</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMax0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ext_x</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMin1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="n">ext_y</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMax1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ext_y</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMin2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="n">ext_z</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ExtMax2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ext_z</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add device/acquisition metadata</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ManufactorString&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;ZarrNii&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ManufactorType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;Generic&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LensPower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumericalAperture&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;RecordingDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
            <span class="s2">&quot;2024-01-01 00:00:00.000&quot;</span>
        <span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;ZarrNii Export&quot;</span><span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Compression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;5794&quot;</span><span class="p">)</span>

        <span class="c1"># Add description</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Imaris file created by ZarrNii from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="si">}</span><span class="s2"> format data. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Original shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">darr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Converted to Imaris format &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;with </span><span class="si">{</span><span class="n">n_channels</span><span class="si">}</span><span class="s2"> channel(s) and dimensions </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Voxel size: </span><span class="si">{</span><span class="n">sx</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">sy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">sz</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> um.&quot;</span>
        <span class="p">)</span>
        <span class="n">image_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># Create Imaris metadata group</span>
        <span class="n">imaris_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;Imaris&quot;</span><span class="p">)</span>
        <span class="n">imaris_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;7.0&quot;</span><span class="p">)</span>
        <span class="n">imaris_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ThumbnailMode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;thumbnailMIP&quot;</span><span class="p">)</span>
        <span class="n">imaris_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ThumbnailSize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;256&quot;</span><span class="p">)</span>

        <span class="c1"># Create ImarisDataSet metadata</span>
        <span class="n">dataset_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ImarisDataSet&quot;</span><span class="p">)</span>
        <span class="n">dataset_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Creator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;Imaris&quot;</span><span class="p">)</span>
        <span class="n">dataset_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;7.0&quot;</span><span class="p">)</span>
        <span class="n">dataset_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumberOfImages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="c1"># Add version-specific groups as seen in reference</span>
        <span class="n">dataset_info_ver</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ImarisDataSet       0.0.0&quot;</span><span class="p">)</span>
        <span class="n">dataset_info_ver</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumberOfImages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">dataset_info_ver2</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ImarisDataSet      0.0.0&quot;</span><span class="p">)</span>
        <span class="n">dataset_info_ver2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;NumberOfImages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="c1"># Create TimeInfo group</span>
        <span class="n">time_info</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;TimeInfo&quot;</span><span class="p">)</span>
        <span class="n">time_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;DatasetTimePoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">time_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;FileTimePoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">time_info</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;TimePoint1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
            <span class="s2">&quot;2024-01-01 00:00:00.000&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create Log group (basic processing log)</span>
        <span class="n">log_group</span> <span class="o">=</span> <span class="n">info_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;Log&quot;</span><span class="p">)</span>
        <span class="n">log_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Entries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">log_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Entry0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_string_to_byte_array</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;ZarrNiiExport channels=</span><span class="se">\&quot;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;on&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_channels</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">/&gt;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create thumbnail group with proper multi-channel thumbnail</span>
        <span class="n">thumbnail_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;Thumbnail&quot;</span><span class="p">)</span>

        <span class="c1"># Create a combined thumbnail (256x1024 for multi-channel as in reference)</span>
        <span class="k">if</span> <span class="n">n_channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Multi-channel thumbnail: concatenate channels horizontally</span>
            <span class="n">thumb_width</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">n_channels</span>
            <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="n">thumb_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channels</span><span class="p">):</span>
                <span class="c1"># Downsample each channel to 256x256</span>
                <span class="n">channel_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="c1"># Take MIP (Maximum Intensity Projection) along Z</span>
                <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channel_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Resize to 256x256 (simple decimation)</span>
                <span class="n">step_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span>
                <span class="n">step_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span>
                <span class="n">thumb_channel</span> <span class="o">=</span> <span class="n">mip</span><span class="p">[::</span><span class="n">step_y</span><span class="p">,</span> <span class="p">::</span><span class="n">step_x</span><span class="p">]</span>

                <span class="c1"># Pad or crop to exactly 256x256</span>
                <span class="k">if</span> <span class="n">thumb_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="ow">or</span> <span class="n">thumb_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
                    <span class="n">padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">thumb_channel</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">thumb_channel</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">padded</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">thumb_channel</span>
                    <span class="n">thumb_channel</span> <span class="o">=</span> <span class="n">padded</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">thumb_channel</span> <span class="o">=</span> <span class="n">thumb_channel</span><span class="p">[:</span><span class="mi">256</span><span class="p">,</span> <span class="p">:</span><span class="mi">256</span><span class="p">]</span>

                <span class="c1"># Place in thumbnail</span>
                <span class="n">thumbnail_data</span><span class="p">[:,</span> <span class="n">c</span> <span class="o">*</span> <span class="mi">256</span> <span class="p">:</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="n">thumb_channel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single channel: 256x256 thumbnail</span>
            <span class="n">channel_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channel_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">step_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span>
            <span class="n">step_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span>
            <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">mip</span><span class="p">[::</span><span class="n">step_y</span><span class="p">,</span> <span class="p">::</span><span class="n">step_x</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">thumbnail_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="ow">or</span> <span class="n">thumbnail_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
                <span class="n">padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">thumbnail_data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">thumbnail_data</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">padded</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">thumbnail_data</span>
                <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">padded</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="n">thumbnail_data</span><span class="p">[:</span><span class="mi">256</span><span class="p">,</span> <span class="p">:</span><span class="mi">256</span><span class="p">]</span>

        <span class="n">thumbnail_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">thumbnail_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.to_ngff_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_ngff_image</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert to NgffImage object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional name for the image</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ngff_zarr.NgffImage">NgffImage</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NgffImage representation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_ngff_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert to NgffImage object.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Optional name for the image</span>

<span class="sd">    Returns:</span>
<span class="sd">        NgffImage representation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">return</span> <span class="n">nz</span><span class="o">.</span><span class="n">NgffImage</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">translation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.to_nifti" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_nifti</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert to NIfTI format with automatic dimension handling.</p>
<p>Converts the ZarrNii image to NIfTI-1 format, handling dimension
reordering, singleton dimension removal, and spatial transformation
conversion. NIfTI files are always written in XYZ axis order.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bytes">bytes</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output file path for saving. Supported extensions:
- .nii: Uncompressed NIfTI
- .nii.gz: Compressed NIfTI (recommended)
If None, returns nibabel image object without saving</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="nibabel.Nifti1Image">Nifti1Image</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filename is None: nibabel.Nifti1Image object</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="nibabel.Nifti1Image">Nifti1Image</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filename provided: path to saved file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If data has non-singleton time or channel dimensions
(NIfTI doesn't support &gt;4D data)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to write to specified filename</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Automatically reorders data from ZYX to XYZ if necessary</li>
<li>Removes singleton time/channel dimensions automatically</li>
<li>Spatial transformations are converted to NIfTI affine format</li>
<li>For 5D data (T,C,Z,Y,X), only singleton T/C dimensions are supported</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save to compressed NIfTI file</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_nifti</span><span class="p">(</span><span class="s2">&quot;output.nii.gz&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Get nibabel object without saving</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nifti_img</span> <span class="o">=</span> <span class="n">znii</span><span class="o">.</span><span class="n">to_nifti</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">nifti_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Handle multi-channel data by selecting single channel first</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">select_channels</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to_nifti</span><span class="p">(</span><span class="s2">&quot;channel0.nii.gz&quot;</span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_nifti</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert to NIfTI format with automatic dimension handling.</span>

<span class="sd">    Converts the ZarrNii image to NIfTI-1 format, handling dimension</span>
<span class="sd">    reordering, singleton dimension removal, and spatial transformation</span>
<span class="sd">    conversion. NIfTI files are always written in XYZ axis order.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Output file path for saving. Supported extensions:</span>
<span class="sd">            - .nii: Uncompressed NIfTI</span>
<span class="sd">            - .nii.gz: Compressed NIfTI (recommended)</span>
<span class="sd">            If None, returns nibabel image object without saving</span>

<span class="sd">    Returns:</span>
<span class="sd">        If filename is None: nibabel.Nifti1Image object</span>
<span class="sd">        If filename provided: path to saved file</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If data has non-singleton time or channel dimensions</span>
<span class="sd">            (NIfTI doesn&#39;t support &gt;4D data)</span>
<span class="sd">        OSError: If unable to write to specified filename</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Automatically reorders data from ZYX to XYZ if necessary</span>
<span class="sd">        - Removes singleton time/channel dimensions automatically</span>
<span class="sd">        - Spatial transformations are converted to NIfTI affine format</span>
<span class="sd">        - For 5D data (T,C,Z,Y,X), only singleton T/C dimensions are supported</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Save to compressed NIfTI file</span>
<span class="sd">        &gt;&gt;&gt; znii.to_nifti(&quot;output.nii.gz&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Get nibabel object without saving</span>
<span class="sd">        &gt;&gt;&gt; nifti_img = znii.to_nifti()</span>
<span class="sd">        &gt;&gt;&gt; print(nifti_img.shape)</span>

<span class="sd">        &gt;&gt;&gt; # Handle multi-channel data by selecting single channel first</span>
<span class="sd">        &gt;&gt;&gt; znii.select_channels([0]).to_nifti(&quot;channel0.nii.gz&quot;)</span>

<span class="sd">    Warnings:</span>
<span class="sd">        Large images will be computed in memory during conversion.</span>
<span class="sd">        Consider downsampling or cropping first for very large datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get data and dimensions</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>

    <span class="c1"># Handle dimensional reduction for NIfTI compatibility</span>
    <span class="c1"># NIfTI supports up to 4D, so we need to remove singleton dimensions</span>
    <span class="n">squeeze_axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining_dims</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Remove singleton time or channel dimensions</span>
            <span class="n">squeeze_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Non-singleton time or channel dimensions - NIfTI can&#39;t handle this</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;NIfTI format doesn&#39;t support non-singleton </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2"> dimension. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Dimension &#39;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&#39; has size </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Consider selecting specific timepoints/channels first.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remaining_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

    <span class="c1"># Squeeze out singleton dimensions</span>
    <span class="k">if</span> <span class="n">squeeze_axes</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">squeeze_axes</span><span class="p">))</span>

    <span class="c1"># Check final dimensionality</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Resulting data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2"> dimensions, but NIfTI supports maximum 4D&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Now handle spatial reordering based on axes_order</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">:</span>
        <span class="c1"># Data spatial dimensions are in ZYX order, need to transpose to XYZ</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Pure spatial data: ZYX -&gt; XYZ</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># 4D data with one non-spatial dimension remaining</span>
            <span class="c1"># Could be (T,Z,Y,X) or (C,Z,Y,X) - spatial part needs ZYX-&gt;XYZ</span>
            <span class="c1"># The non-spatial dimension stays first</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get affine matrix in XYZ order</span>
        <span class="n">affine_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_affine_matrix</span><span class="p">(</span><span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;XYZ&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Data is already in XYZ order</span>
        <span class="n">affine_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_affine_matrix</span><span class="p">(</span><span class="n">axes_order</span><span class="o">=</span><span class="s2">&quot;XYZ&quot;</span><span class="p">)</span>

    <span class="c1"># Create NIfTI image</span>
    <span class="n">nifti_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nifti_img</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nifti_img</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.to_ome_zarr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_ome_zarr</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">max_layer</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">scale_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Save to OME-Zarr store with multiscale pyramid.</p>
<p>Creates an OME-Zarr dataset with automatic multiscale pyramid generation
for efficient visualization and processing at multiple resolutions.
Preserves spatial metadata and supports various storage backends.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>store_or_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target location for OME-Zarr store. Supports:
- Local directory path
- Remote URLs (s3://, gs://, etc.)
- ZIP files (.zip extension for compressed storage)
- Zarr store objects</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_layer</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of pyramid levels to create (including level 0).
Higher values create more downsampled levels</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale_factors</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom downsampling factors for each pyramid level.
If None, uses powers of 2: [2, 4, 8, 16, ...]</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to underlying to_ngff_zarr function.
May include compression options, chunk sizes, etc.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;ZarrNii&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to write to target location</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If invalid scale_factors provided</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save with default pyramid levels</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_ome_zarr</span><span class="p">(</span><span class="s2">&quot;/path/to/output.zarr&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save to compressed ZIP with custom pyramid</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_ome_zarr</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;/path/to/output.zarr.zip&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">max_layer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">scale_factors</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Chain with other operations</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">znii</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">... </span>              <span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
<span class="gp">... </span>              <span class="o">.</span><span class="n">to_ome_zarr</span><span class="p">(</span><span class="s2">&quot;processed.zarr&quot;</span><span class="p">))</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>OME-Zarr files are always saved in ZYX axis order</li>
<li>Automatic axis reordering if current order is XYZ</li>
<li>Spatial transformations and metadata are preserved</li>
<li>Orientation information is stored using the new 'xyz_orientation'
  metadata key for consistency and future compatibility</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_ome_zarr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">store_or_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">max_layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">scale_factors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ZarrNii&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save to OME-Zarr store with multiscale pyramid.</span>

<span class="sd">    Creates an OME-Zarr dataset with automatic multiscale pyramid generation</span>
<span class="sd">    for efficient visualization and processing at multiple resolutions.</span>
<span class="sd">    Preserves spatial metadata and supports various storage backends.</span>

<span class="sd">    Args:</span>
<span class="sd">        store_or_path: Target location for OME-Zarr store. Supports:</span>
<span class="sd">            - Local directory path</span>
<span class="sd">            - Remote URLs (s3://, gs://, etc.)</span>
<span class="sd">            - ZIP files (.zip extension for compressed storage)</span>
<span class="sd">            - Zarr store objects</span>
<span class="sd">        max_layer: Maximum number of pyramid levels to create (including level 0).</span>
<span class="sd">            Higher values create more downsampled levels</span>
<span class="sd">        scale_factors: Custom downsampling factors for each pyramid level.</span>
<span class="sd">            If None, uses powers of 2: [2, 4, 8, 16, ...]</span>
<span class="sd">        **kwargs: Additional arguments passed to underlying to_ngff_zarr function.</span>
<span class="sd">            May include compression options, chunk sizes, etc.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>

<span class="sd">    Raises:</span>
<span class="sd">        OSError: If unable to write to target location</span>
<span class="sd">        ValueError: If invalid scale_factors provided</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Save with default pyramid levels</span>
<span class="sd">        &gt;&gt;&gt; znii.to_ome_zarr(&quot;/path/to/output.zarr&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Save to compressed ZIP with custom pyramid</span>
<span class="sd">        &gt;&gt;&gt; znii.to_ome_zarr(</span>
<span class="sd">        ...     &quot;/path/to/output.zarr.zip&quot;,</span>
<span class="sd">        ...     max_layer=3,</span>
<span class="sd">        ...     scale_factors=[2, 4]</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Chain with other operations</span>
<span class="sd">        &gt;&gt;&gt; result = (znii.downsample(2)</span>
<span class="sd">        ...               .crop((0,0,0), (100,100,100))</span>
<span class="sd">        ...               .to_ome_zarr(&quot;processed.zarr&quot;))</span>

<span class="sd">    Notes:</span>
<span class="sd">        - OME-Zarr files are always saved in ZYX axis order</span>
<span class="sd">        - Automatic axis reordering if current order is XYZ</span>
<span class="sd">        - Spatial transformations and metadata are preserved</span>
<span class="sd">        - Orientation information is stored using the new &#39;xyz_orientation&#39;</span>
<span class="sd">          metadata key for consistency and future compatibility</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the image to save</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
        <span class="c1"># Need to reorder data from XYZ to ZYX for OME-Zarr</span>
        <span class="n">ngff_image_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_zyx_ngff_image</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Already in ZYX order</span>
        <span class="n">ngff_image_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngff_image</span>

    <span class="n">save_ngff_image</span><span class="p">(</span>
        <span class="n">ngff_image_to_save</span><span class="p">,</span>
        <span class="n">store_or_path</span><span class="p">,</span>
        <span class="n">max_layer</span><span class="p">,</span>
        <span class="n">scale_factors</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xyz_orientation&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Add orientation metadata to the zarr store (only for non-ZIP files)</span>
    <span class="c1"># For ZIP files, orientation is handled inside save_ngff_image</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">store_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store_or_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span>

            <span class="c1"># Add metadata for xyz_orientation (new format)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xyz_orientation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;xyz_orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If we can&#39;t write orientation metadata, that&#39;s not critical</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.to_tiff_stack" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_tiff_stack</span><span class="p">(</span><span class="n">filename_pattern</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timepoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Save data as a stack of 2D TIFF images.</p>
<p>Saves the image data as a series of 2D TIFF files, with each Z-slice
saved as a separate file. This format is useful for compatibility with
tools that don't support OME-Zarr or napari plugins that require
individual TIFF files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename_pattern</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output filename pattern. Should contain '{z:04d}' or similar
format specifier for the Z-slice number. Examples:
- "output_z{z:04d}.tif"
- "data/slice_{z:03d}.tiff"
If pattern doesn't contain format specifier, '_{z:04d}' is appended
before the extension.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Channel index to save (0-based). If None and data has multiple
channels, all channels will be saved as separate channel dimensions
in each TIFF file (multi-channel TIFFs).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timepoint</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timepoint index to save (0-based). If None and data has multiple
timepoints, raises ValueError (must select single timepoint).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use LZW compression (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output data type for TIFF files. Options:
- 'uint8': 8-bit unsigned integer (0-255)
- 'uint16': 16-bit unsigned integer (0-65535) [default]
- 'int16': 16-bit signed integer (-32768 to 32767)
- 'float32': 32-bit float (preserves original data)
Default 'uint16' provides good range and compatibility.</p>
              </div>
            </td>
            <td>
                  <code>&#39;uint16&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rescale</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to rescale data to fit the output dtype range.
If True, data is linearly scaled from [min, max] to the full
range of the output dtype. If False, data is clipped to the
output dtype range. Default: True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base directory path where files were saved</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If data has multiple timepoints but none selected,
or if selected channel/timepoint is out of range,
or if dtype is not supported</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If unable to write to specified directory</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save as 16-bit with auto-rescaling (default, recommended)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_tiff_stack</span><span class="p">(</span><span class="s2">&quot;output_z</span><span class="si">{z:04d}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save as 8-bit for smaller file sizes</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_tiff_stack</span><span class="p">(</span><span class="s2">&quot;output_z</span><span class="si">{z:04d}</span><span class="s2">.tif&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save specific channel without rescaling</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_tiff_stack</span><span class="p">(</span><span class="s2">&quot;channel0_z</span><span class="si">{z:04d}</span><span class="s2">.tif&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Save as float32 to preserve original precision</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">znii</span><span class="o">.</span><span class="n">to_tiff_stack</span><span class="p">(</span><span class="s2">&quot;precise_z</span><span class="si">{z:04d}</span><span class="s2">.tif&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</code></pre></div>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Z-dimension becomes the stack (file) dimension</li>
<li>Time and channel dimensions are handled as specified</li>
<li>Spatial transformations are not preserved in TIFF format</li>
<li>For 5D data (T,C,Z,Y,X), you must select a single timepoint</li>
<li>Multi-channel data can be saved as multi-channel TIFFs or selected</li>
<li>Data type conversion helps ensure compatibility with analysis tools</li>
<li>uint16 is recommended for most scientific applications (good range + compatibility)</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_tiff_stack</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">filename_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">channel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timepoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uint16&quot;</span><span class="p">,</span>
    <span class="n">rescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save data as a stack of 2D TIFF images.</span>

<span class="sd">    Saves the image data as a series of 2D TIFF files, with each Z-slice</span>
<span class="sd">    saved as a separate file. This format is useful for compatibility with</span>
<span class="sd">    tools that don&#39;t support OME-Zarr or napari plugins that require</span>
<span class="sd">    individual TIFF files.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename_pattern: Output filename pattern. Should contain &#39;{z:04d}&#39; or similar</span>
<span class="sd">            format specifier for the Z-slice number. Examples:</span>
<span class="sd">            - &quot;output_z{z:04d}.tif&quot;</span>
<span class="sd">            - &quot;data/slice_{z:03d}.tiff&quot;</span>
<span class="sd">            If pattern doesn&#39;t contain format specifier, &#39;_{z:04d}&#39; is appended</span>
<span class="sd">            before the extension.</span>
<span class="sd">        channel: Channel index to save (0-based). If None and data has multiple</span>
<span class="sd">            channels, all channels will be saved as separate channel dimensions</span>
<span class="sd">            in each TIFF file (multi-channel TIFFs).</span>
<span class="sd">        timepoint: Timepoint index to save (0-based). If None and data has multiple</span>
<span class="sd">            timepoints, raises ValueError (must select single timepoint).</span>
<span class="sd">        compress: Whether to use LZW compression (default: True)</span>
<span class="sd">        dtype: Output data type for TIFF files. Options:</span>
<span class="sd">            - &#39;uint8&#39;: 8-bit unsigned integer (0-255)</span>
<span class="sd">            - &#39;uint16&#39;: 16-bit unsigned integer (0-65535) [default]</span>
<span class="sd">            - &#39;int16&#39;: 16-bit signed integer (-32768 to 32767)</span>
<span class="sd">            - &#39;float32&#39;: 32-bit float (preserves original data)</span>
<span class="sd">            Default &#39;uint16&#39; provides good range and compatibility.</span>
<span class="sd">        rescale: Whether to rescale data to fit the output dtype range.</span>
<span class="sd">            If True, data is linearly scaled from [min, max] to the full</span>
<span class="sd">            range of the output dtype. If False, data is clipped to the</span>
<span class="sd">            output dtype range. Default: True</span>

<span class="sd">    Returns:</span>
<span class="sd">        Base directory path where files were saved</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If data has multiple timepoints but none selected,</span>
<span class="sd">            or if selected channel/timepoint is out of range,</span>
<span class="sd">            or if dtype is not supported</span>
<span class="sd">        OSError: If unable to write to specified directory</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Save as 16-bit with auto-rescaling (default, recommended)</span>
<span class="sd">        &gt;&gt;&gt; znii.to_tiff_stack(&quot;output_z{z:04d}.tif&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Save as 8-bit for smaller file sizes</span>
<span class="sd">        &gt;&gt;&gt; znii.to_tiff_stack(&quot;output_z{z:04d}.tif&quot;, dtype=&#39;uint8&#39;)</span>

<span class="sd">        &gt;&gt;&gt; # Save specific channel without rescaling</span>
<span class="sd">        &gt;&gt;&gt; znii.to_tiff_stack(&quot;channel0_z{z:04d}.tif&quot;, channel=0, rescale=False)</span>

<span class="sd">        &gt;&gt;&gt; # Save as float32 to preserve original precision</span>
<span class="sd">        &gt;&gt;&gt; znii.to_tiff_stack(&quot;precise_z{z:04d}.tif&quot;, dtype=&#39;float32&#39;)</span>

<span class="sd">    Warnings:</span>
<span class="sd">        This method loads all data into memory. For large datasets,</span>
<span class="sd">        consider cropping or downsampling first to reduce memory usage.</span>
<span class="sd">        The cellseg3d napari plugin and similar tools work best with</span>
<span class="sd">        cropped regions rather than full-resolution whole-brain images.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Z-dimension becomes the stack (file) dimension</span>
<span class="sd">        - Time and channel dimensions are handled as specified</span>
<span class="sd">        - Spatial transformations are not preserved in TIFF format</span>
<span class="sd">        - For 5D data (T,C,Z,Y,X), you must select a single timepoint</span>
<span class="sd">        - Multi-channel data can be saved as multi-channel TIFFs or selected</span>
<span class="sd">        - Data type conversion helps ensure compatibility with analysis tools</span>
<span class="sd">        - uint16 is recommended for most scientific applications (good range + compatibility)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tifffile</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;tifffile is required for TIFF stack support. &quot;</span>
            <span class="s2">&quot;Install with: pip install tifffile&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get data and dimensions</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>

    <span class="c1"># Create output directory if needed</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename_pattern</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Handle dimensional selection and validation</span>
    <span class="c1"># Remove singleton dimensions first, similar to to_nifti</span>
    <span class="n">squeeze_axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining_dims</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_dim_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">channel_dim_size</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">time_dim_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">squeeze_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">timepoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> timepoints. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Must specify &#39;timepoint&#39; parameter to select a single timepoint.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">timepoint</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Timepoint </span><span class="si">{</span><span class="n">timepoint</span><span class="si">}</span><span class="s2"> is out of range (data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> timepoints)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remaining_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
            <span class="n">channel_dim_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">squeeze_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">channel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> channels. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Must specify &#39;channel&#39; parameter to select a single channel.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> is out of range (data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> channels)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remaining_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remaining_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

    <span class="c1"># Select specific timepoint if needed</span>
    <span class="k">if</span> <span class="n">time_dim_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">timepoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timepoint</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">time_axis</span><span class="p">)</span>
        <span class="c1"># Update dims list</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">time_axis</span><span class="p">]</span>

    <span class="c1"># Select specific channel if needed</span>
    <span class="k">if</span> <span class="n">channel_dim_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">channel_axis</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">channel_axis</span><span class="p">)</span>
        <span class="c1"># Update dims list</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">channel_axis</span><span class="p">]</span>

    <span class="c1"># Squeeze singleton dimensions</span>
    <span class="k">if</span> <span class="n">squeeze_axes</span><span class="p">:</span>
        <span class="c1"># Recalculate squeeze axes after potential dimension removal</span>
        <span class="n">current_squeeze_axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">squeeze_axes</span><span class="p">:</span>
            <span class="c1"># Count how many axes were removed before this one</span>
            <span class="n">removed_before</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="mi">1</span>
                <span class="k">for</span> <span class="n">removed_axis</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">time_dim_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">timepoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="p">),</span>
                    <span class="p">(</span>
                        <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">channel_dim_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="p">),</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">removed_axis</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">removed_axis</span> <span class="o">&lt;</span> <span class="n">axis</span>
            <span class="p">)</span>
            <span class="n">current_squeeze_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span> <span class="o">-</span> <span class="n">removed_before</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">current_squeeze_axes</span><span class="p">))</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_squeeze_axes</span><span class="p">]</span>

    <span class="c1"># Find Z dimension for stacking</span>
    <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data must have a Z dimension for TIFF stack export&quot;</span><span class="p">)</span>

    <span class="n">z_axis</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
    <span class="n">z_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">z_axis</span><span class="p">]</span>

    <span class="c1"># Check filename pattern contains format specifier</span>
    <span class="k">if</span> <span class="s2">&quot;{z&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename_pattern</span><span class="p">:</span>
        <span class="c1"># Add default z format before extension</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_pattern</span><span class="p">)</span>
        <span class="n">filename_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="se">{{</span><span class="s2">z:04d</span><span class="se">}}</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Move Z axis to first position for easy iteration</span>
    <span class="n">axes_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
    <span class="n">axes_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes_order</span><span class="p">[</span><span class="n">z_axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_order</span><span class="p">[</span><span class="n">z_axis</span><span class="p">],</span> <span class="n">axes_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axes_order</span><span class="p">)</span>

    <span class="c1"># Handle data type conversion and rescaling</span>
    <span class="n">supported_dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;uint8&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="s2">&quot;uint16&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
        <span class="s2">&quot;int16&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
        <span class="s2">&quot;float32&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_dtypes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported dtype &#39;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&#39;. Supported types: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">supported_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">target_dtype</span> <span class="o">=</span> <span class="n">supported_dtypes</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">rescale</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
        <span class="c1"># Get the data range</span>
        <span class="n">data_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data_min</span> <span class="o">==</span> <span class="n">data_max</span><span class="p">:</span>
            <span class="c1"># Handle constant data case</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">target_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get target range for the dtype</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
                <span class="n">target_min</span><span class="p">,</span> <span class="n">target_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span>
            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
                <span class="n">target_min</span><span class="p">,</span> <span class="n">target_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span>
            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;int16&quot;</span><span class="p">:</span>
                <span class="n">target_min</span><span class="p">,</span> <span class="n">target_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">,</span> <span class="mi">32767</span>

            <span class="c1"># Linear rescaling: new_value = (value - data_min) * (target_max - target_min) / (data_max - data_min) + target_min</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">data_min</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">target_max</span> <span class="o">-</span> <span class="n">target_min</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">data_max</span> <span class="o">-</span> <span class="n">data_min</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">target_min</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Rescaled data from [</span><span class="si">{</span><span class="n">data_min</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">data_max</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] to </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> range&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No rescaling - just clip and convert</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;int16&quot;</span><span class="p">:</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">32768</span><span class="p">,</span> <span class="mi">32767</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># float32</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted data to </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> with clipping (no rescaling)&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_scaled</span>

    <span class="c1"># Save each Z-slice as a separate TIFF file</span>
    <span class="n">compression</span> <span class="o">=</span> <span class="s2">&quot;lzw&quot;</span> <span class="k">if</span> <span class="n">compress</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">saved_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">z_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_size</span><span class="p">):</span>
        <span class="n">slice_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">z_idx</span><span class="p">]</span>

        <span class="c1"># Generate filename for this slice</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z_idx</span><span class="p">)</span>

        <span class="c1"># Save the 2D slice</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">slice_data</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">)</span>
        <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">saved_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> TIFF files to </span><span class="si">{</span><span class="n">output_dir</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Files: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">saved_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> ... </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">saved_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">output_dir</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.ZarrNii.upsample" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">upsample</span><span class="p">(</span><span class="n">along_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_z</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">to_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Upsamples the ZarrNii instance using <code>scipy.ndimage.zoom</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>along_x</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upsampling factor along the X-axis (default: 1).</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_y</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upsampling factor along the Y-axis (default: 1).</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>along_z</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upsampling factor along the Z-axis (default: 1).</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>to_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target shape for upsampling. Should include all dimensions
                         (e.g., <code>(c, z, y, x)</code> for ZYX or <code>(c, x, y, z)</code> for XYZ).
                         If provided, <code>along_x</code>, <code>along_y</code>, and <code>along_z</code> are ignored.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>ZarrNii</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new ZarrNii instance with the upsampled data and updated affine.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>This method supports both direct scaling via <code>along_*</code> factors or target shape via <code>to_shape</code>.</li>
<li>If <code>to_shape</code> is provided, chunk sizes and scaling factors are dynamically calculated.</li>
<li>The affine matrix is updated to reflect the new voxel size after upsampling.</li>
</ul>
</details>

<details class="example" open>
  <summary>Example</summary>
  <h3 id="zarrnii.ZarrNii.upsample--upsample-with-scaling-factors">Upsample with scaling factors</h3>
<p>upsampled_znimg = znimg.upsample(along_x=2, along_y=2, along_z=2)</p>
<h3 id="zarrnii.ZarrNii.upsample--upsample-to-a-specific-shape">Upsample to a specific shape</h3>
<p>upsampled_znimg = znimg.upsample(to_shape=(1, 256, 256, 256))</p>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">upsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">along_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_z</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">to_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upsamples the ZarrNii instance using `scipy.ndimage.zoom`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        along_x (int, optional): Upsampling factor along the X-axis (default: 1).</span>
<span class="sd">        along_y (int, optional): Upsampling factor along the Y-axis (default: 1).</span>
<span class="sd">        along_z (int, optional): Upsampling factor along the Z-axis (default: 1).</span>
<span class="sd">        to_shape (tuple, optional): Target shape for upsampling. Should include all dimensions</span>
<span class="sd">                                     (e.g., `(c, z, y, x)` for ZYX or `(c, x, y, z)` for XYZ).</span>
<span class="sd">                                     If provided, `along_x`, `along_y`, and `along_z` are ignored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ZarrNii: A new ZarrNii instance with the upsampled data and updated affine.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - This method supports both direct scaling via `along_*` factors or target shape via `to_shape`.</span>
<span class="sd">        - If `to_shape` is provided, chunk sizes and scaling factors are dynamically calculated.</span>
<span class="sd">        - The affine matrix is updated to reflect the new voxel size after upsampling.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Upsample with scaling factors</span>
<span class="sd">        upsampled_znimg = znimg.upsample(along_x=2, along_y=2, along_z=2)</span>

<span class="sd">        # Upsample to a specific shape</span>
<span class="sd">        upsampled_znimg = znimg.upsample(to_shape=(1, 256, 256, 256))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine scaling and chunks based on input parameters</span>
    <span class="k">if</span> <span class="n">to_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_x</span><span class="p">,</span> <span class="n">along_y</span><span class="p">,</span> <span class="n">along_z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">along_z</span><span class="p">,</span> <span class="n">along_y</span><span class="p">,</span> <span class="n">along_x</span><span class="p">)</span>

        <span class="n">chunks_out</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks_i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chunks_i</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chunks</span><span class="p">,</span> <span class="n">scaling</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunks_out</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_upsampled_chunks</span><span class="p">(</span><span class="n">to_shape</span><span class="p">)</span>

    <span class="c1"># Define block-wise upsampling function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zoom_blocks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">block_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scales blocks to the desired size using `scipy.ndimage.zoom`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x (np.ndarray): Input block data.</span>
<span class="sd">            block_info (dict, optional): Metadata about the current block.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The upscaled block.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate scaling factors based on input and output chunk shapes</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">out_n</span> <span class="o">/</span> <span class="n">in_n</span>
            <span class="k">for</span> <span class="n">out_n</span><span class="p">,</span> <span class="n">in_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">block_info</span><span class="p">[</span><span class="kc">None</span><span class="p">][</span><span class="s2">&quot;chunk-shape&quot;</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">zoom</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scaling</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prefilter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Perform block-wise upsampling</span>
    <span class="n">darr_scaled</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">zoom_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks_out</span>
    <span class="p">)</span>

    <span class="c1"># Update the affine matrix to reflect the new voxel size</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
        <span class="n">scaling_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scaling_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">new_affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">scaling_matrix</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

    <span class="c1"># Create new NgffImage with upsampled data</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">:</span>
        <span class="n">new_scale</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_scale</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="n">upsampled_ngff</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">to_ngff_image</span><span class="p">(</span>
        <span class="n">darr_scaled</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">new_scale</span><span class="p">,</span>
        <span class="n">translation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Return a new ZarrNii instance with the upsampled data</span>
    <span class="k">return</span> <span class="n">ZarrNii</span><span class="o">.</span><span class="n">from_ngff_image</span><span class="p">(</span>
        <span class="n">upsampled_ngff</span><span class="p">,</span>
        <span class="n">axes_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_order</span><span class="p">,</span>
        <span class="n">xyz_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_orientation</span><span class="p">,</span>
        <span class="n">omero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">omero</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<a id="zarrnii.transform.AffineTransform"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="zarrnii.transform.Transform">Transform</span></code></p>


        <p>Affine transformation for spatial coordinate mapping.</p>
<p>Represents a 4x4 affine transformation matrix that can be used to transform
3D coordinates between different coordinate systems. Supports various
operations including matrix multiplication, inversion, and point transformation.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="matrix = None

  
      class-attribute
      instance-attribute
   (zarrnii.transform.AffineTransform.matrix)" href="#zarrnii.transform.AffineTransform.matrix">matrix</a></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>4x4 affine transformation matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>











  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.transform.AffineTransform.matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">matrix</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.__array__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__array__</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert to numpy array.</p>
<p>Defines how the object behaves when converted to a numpy array.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The 4x4 affine transformation matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__array__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert to numpy array.</span>

<span class="sd">    Defines how the object behaves when converted to a numpy array.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The 4x4 affine transformation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Enable array-like indexing on the matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index or slice for matrix access</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Element(s) from the transformation matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable array-like indexing on the matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        key: Index or slice for matrix access</span>

<span class="sd">    Returns:</span>
<span class="sd">        Element(s) from the transformation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.__matmul__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__matmul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Perform matrix multiplication with another object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>other</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, &#39;AffineTransform&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The object to multiply with. Supported types:
- (3,) or (3, 1): A 3D point or vector (voxel coordinates)
- (3, N): A batch of N 3D points or vectors (voxel coordinates)
- (4,) or (4, 1): A 4D point/vector in homogeneous coordinates
- (4, N): A batch of N 4D points in homogeneous coordinates
- (4, 4): Another affine transformation matrix
- AffineTransform: Another affine transformation object</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, &#39;AffineTransform&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transformed coordinates as numpy array or new AffineTransform:
- For coordinate inputs: transformed coordinates with same shape
- For matrix/AffineTransform inputs: new AffineTransform object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the shape of <code>other</code> is unsupported</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>other</code> is not an np.ndarray or AffineTransform</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__matmul__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;AffineTransform&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;AffineTransform&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform matrix multiplication with another object.</span>

<span class="sd">    Args:</span>
<span class="sd">        other: The object to multiply with. Supported types:</span>
<span class="sd">            - (3,) or (3, 1): A 3D point or vector (voxel coordinates)</span>
<span class="sd">            - (3, N): A batch of N 3D points or vectors (voxel coordinates)</span>
<span class="sd">            - (4,) or (4, 1): A 4D point/vector in homogeneous coordinates</span>
<span class="sd">            - (4, N): A batch of N 4D points in homogeneous coordinates</span>
<span class="sd">            - (4, 4): Another affine transformation matrix</span>
<span class="sd">            - AffineTransform: Another affine transformation object</span>

<span class="sd">    Returns:</span>
<span class="sd">        Transformed coordinates as numpy array or new AffineTransform:</span>
<span class="sd">            - For coordinate inputs: transformed coordinates with same shape</span>
<span class="sd">            - For matrix/AffineTransform inputs: new AffineTransform object</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the shape of `other` is unsupported</span>
<span class="sd">        TypeError: If `other` is not an np.ndarray or AffineTransform</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="c1"># Single 3D point/vector</span>
            <span class="n">homog_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Convert to homogeneous coordinates</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">@</span> <span class="n">homog_point</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Convert back to 3D</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Batch of 3D points/vectors (3 x N)</span>
            <span class="n">homog_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">[</span><span class="n">other</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
            <span class="p">)</span>  <span class="c1"># Add homogeneous row</span>
            <span class="n">transformed_points</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">@</span> <span class="n">homog_points</span>
            <span class="p">)</span>  <span class="c1"># Apply affine transform</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">transformed_points</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">transformed_points</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="p">)</span>  <span class="c1"># Convert back to 3D</span>
        <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,):</span>
            <span class="c1"># Single 4D point/vector</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">@</span> <span class="n">other</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Batch of 4D points in homogeneous coordinates (4 x N)</span>
            <span class="n">transformed_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">@</span> <span class="n">other</span>  <span class="c1"># Apply affine transform</span>
            <span class="k">return</span> <span class="n">transformed_points</span>  <span class="c1"># No conversion needed, stays in 4D space</span>
        <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="c1"># Matrix multiplication with another affine matrix</span>
            <span class="k">return</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">@</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported shape for multiplication: </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AffineTransform</span><span class="p">):</span>
        <span class="c1"># Matrix multiplication with another AffineTransform object</span>
        <span class="k">return</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">@</span> <span class="n">other</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported type for multiplication: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.__setitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Enable array-like assignment to the matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index or slice for matrix assignment</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value(s) to assign to matrix</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable array-like assignment to the matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        key: Index or slice for matrix assignment</span>
<span class="sd">        value: Value(s) to assign to matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.apply_transform" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_transform</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply transformation to coordinate vectors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vecs</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input coordinates to transform</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transformed coordinates</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vecs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply transformation to coordinate vectors.</span>

<span class="sd">    Args:</span>
<span class="sd">        vecs: Input coordinates to transform</span>

<span class="sd">    Returns:</span>
<span class="sd">        Transformed coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">vecs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.from_array" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Create AffineTransform from numpy array.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>matrix</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>4x4 numpy array representing affine transformation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>invert</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to invert the matrix</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;AffineTransform&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>AffineTransform instance with the matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If matrix is not 4x4</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_array</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AffineTransform&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create AffineTransform from numpy array.</span>

<span class="sd">    Args:</span>
<span class="sd">        matrix: 4x4 numpy array representing affine transformation</span>
<span class="sd">        invert: Whether to invert the matrix</span>

<span class="sd">    Returns:</span>
<span class="sd">        AffineTransform instance with the matrix</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If matrix is not 4x4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matrix must be 4x4, got shape </span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.from_txt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_txt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Create AffineTransform from text file containing matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bytes">bytes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to text file containing 4x4 affine matrix</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>invert</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to invert the matrix after loading</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;AffineTransform&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>AffineTransform instance with loaded matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If file cannot be read</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If file does not contain valid 4x4 matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_txt</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AffineTransform&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create AffineTransform from text file containing matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path to text file containing 4x4 affine matrix</span>
<span class="sd">        invert: Whether to invert the matrix after loading</span>

<span class="sd">    Returns:</span>
<span class="sd">        AffineTransform instance with loaded matrix</span>

<span class="sd">    Raises:</span>
<span class="sd">        OSError: If file cannot be read</span>
<span class="sd">        ValueError: If file does not contain valid 4x4 matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.identity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">identity</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Create identity transformation.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;AffineTransform&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>AffineTransform representing identity transformation (no change)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">identity</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AffineTransform&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create identity transformation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        AffineTransform representing identity transformation (no change)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.invert" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invert</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Return the inverse of the matrix transformation.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;AffineTransform&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New AffineTransform with inverted matrix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.linalg.LinAlgError">LinAlgError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If matrix is singular and cannot be inverted</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AffineTransform&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the inverse of the matrix transformation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        New AffineTransform with inverted matrix</span>

<span class="sd">    Raises:</span>
<span class="sd">        np.linalg.LinAlgError: If matrix is singular and cannot be inverted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.AffineTransform.update_for_orientation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_for_orientation</span><span class="p">(</span><span class="n">input_orientation</span><span class="p">,</span> <span class="n">output_orientation</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Update the matrix to map from input orientation to output orientation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_orientation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current anatomical orientation (e.g., 'RPI')</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_orientation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target anatomical orientation (e.g., 'RAS')</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;AffineTransform&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New AffineTransform updated for orientation mapping</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If orientations are invalid or cannot be matched</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_for_orientation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">input_orientation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_orientation</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AffineTransform&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the matrix to map from input orientation to output orientation.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_orientation: Current anatomical orientation (e.g., &#39;RPI&#39;)</span>
<span class="sd">        output_orientation: Target anatomical orientation (e.g., &#39;RAS&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        New AffineTransform updated for orientation mapping</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If orientations are invalid or cannot be matched</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define a mapping of anatomical directions to axis indices and flips</span>
    <span class="n">axis_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Parse the input and output orientations</span>
    <span class="n">input_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis_map</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">input_orientation</span><span class="p">]</span>
    <span class="n">output_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis_map</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">output_orientation</span><span class="p">]</span>

    <span class="c1"># Create a mapping from input to output</span>
    <span class="n">reorder_indices</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">flip_signs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

    <span class="k">for</span> <span class="n">out_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">out_axis</span><span class="p">,</span> <span class="n">out_sign</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_axes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">in_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">in_axis</span><span class="p">,</span> <span class="n">in_sign</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_axes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">out_axis</span> <span class="o">==</span> <span class="n">in_axis</span><span class="p">:</span>  <span class="c1"># Match axis</span>
                <span class="n">reorder_indices</span><span class="p">[</span><span class="n">out_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_idx</span>
                <span class="n">flip_signs</span><span class="p">[</span><span class="n">out_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_sign</span> <span class="o">*</span> <span class="n">in_sign</span>
                <span class="k">break</span>

    <span class="c1"># Reorder and flip the affine matrix</span>
    <span class="n">reordered_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">reorder_idx</span><span class="p">,</span> <span class="n">flip_sign</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">reorder_indices</span><span class="p">,</span> <span class="n">flip_signs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">reorder_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot match all axes from </span><span class="si">{</span><span class="n">input_orientation</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">output_orientation</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">reordered_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">flip_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">reorder_idx</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">reordered_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">flip_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">reorder_idx</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">reordered_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Preserve the homogeneous row</span>

    <span class="k">return</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">reordered_matrix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<a id="zarrnii.transform.DisplacementTransform"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="zarrnii.transform.Transform">Transform</span></code></p>


        <p>Non-linear displacement field transformation.</p>
<p>Represents a displacement field transformation where each point in space
has an associated displacement vector. Uses interpolation to compute
displacements for arbitrary coordinates.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="disp_xyz = None

  
      class-attribute
      instance-attribute
   (zarrnii.transform.DisplacementTransform.disp_xyz)" href="#zarrnii.transform.DisplacementTransform.disp_xyz">disp_xyz</a></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Displacement vectors at grid points (4D array: x, y, z, vector_component)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="disp_grid = None

  
      class-attribute
      instance-attribute
   (zarrnii.transform.DisplacementTransform.disp_grid)" href="#zarrnii.transform.DisplacementTransform.disp_grid">disp_grid</a></code></td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Grid coordinates for displacement field</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="disp_affine = None

  
      class-attribute
      instance-attribute
   (zarrnii.transform.DisplacementTransform.disp_affine)" href="#zarrnii.transform.DisplacementTransform.disp_affine">disp_affine</a></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="zarrnii.transform.AffineTransform" href="#zarrnii.transform.AffineTransform">AffineTransform</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Affine transformation from world to displacement field coordinates</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>











  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.transform.DisplacementTransform.disp_affine" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">disp_affine</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.transform.DisplacementTransform.disp_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">disp_grid</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="zarrnii.transform.DisplacementTransform.disp_xyz" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">disp_xyz</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.DisplacementTransform.apply_transform" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_transform</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply displacement transformation to coordinate vectors.</p>
<p>Transforms input coordinates by interpolating displacement vectors
from the displacement field and adding them to the input coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vecs</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input coordinates as numpy array. Shape should be (3, N) for
N points or (3,) for single point</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transformed coordinates with same shape as input</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>Points outside the displacement field domain are filled with
zero displacement (no transformation).</p>
</details>

            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vecs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply displacement transformation to coordinate vectors.</span>

<span class="sd">    Transforms input coordinates by interpolating displacement vectors</span>
<span class="sd">    from the displacement field and adding them to the input coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        vecs: Input coordinates as numpy array. Shape should be (3, N) for</span>
<span class="sd">            N points or (3,) for single point</span>

<span class="sd">    Returns:</span>
<span class="sd">        Transformed coordinates with same shape as input</span>

<span class="sd">    Notes:</span>
<span class="sd">        Points outside the displacement field domain are filled with</span>
<span class="sd">        zero displacement (no transformation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Transform points to voxel space of the displacement field</span>
    <span class="n">vox_vecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp_affine</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span> <span class="o">@</span> <span class="n">vecs</span>

    <span class="c1"># Initialize displacement vectors</span>
    <span class="n">disp_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vox_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Interpolate displacement for each spatial dimension (x, y, z)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">disp_vecs</span><span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">interpn</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_grid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_xyz</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
            <span class="n">vox_vecs</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Add displacement to original coordinates</span>
    <span class="k">return</span> <span class="n">vecs</span> <span class="o">+</span> <span class="n">disp_vecs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="zarrnii.transform.DisplacementTransform.from_nifti" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_nifti</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Create DisplacementTransform from NIfTI file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="bytes">bytes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to NIfTI displacement field file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;DisplacementTransform&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DisplacementTransform instance loaded from file</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If file cannot be read</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If file format is invalid</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zarrnii/transform.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_nifti</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;DisplacementTransform&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create DisplacementTransform from NIfTI file.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path to NIfTI displacement field file</span>

<span class="sd">    Returns:</span>
<span class="sd">        DisplacementTransform instance loaded from file</span>

<span class="sd">    Raises:</span>
<span class="sd">        OSError: If file cannot be read</span>
<span class="sd">        ValueError: If file format is invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">disp_nib</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">disp_xyz</span> <span class="o">=</span> <span class="n">disp_nib</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">disp_affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">disp_nib</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>

    <span class="c1"># Convert from ITK transform convention</span>
    <span class="c1"># ITK uses opposite sign convention for x and y displacements</span>
    <span class="n">disp_xyz</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">disp_xyz</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">disp_xyz</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">disp_xyz</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Create grid coordinates</span>
    <span class="n">disp_grid</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">disp_xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">disp_xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">disp_xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">disp_xyz</span><span class="o">=</span><span class="n">disp_xyz</span><span class="p">,</span>
        <span class="n">disp_grid</span><span class="o">=</span><span class="n">disp_grid</span><span class="p">,</span>
        <span class="n">disp_affine</span><span class="o">=</span><span class="n">disp_affine</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>